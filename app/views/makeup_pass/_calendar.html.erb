<%# Calendar partial - updated with time-based lesson checking %>
<%
  start_date = date.beginning_of_month
  end_date = date.end_of_month
  weeks = (start_date.beginning_of_week(:sunday)..end_date.end_of_week(:sunday)).to_a.each_slice(7)
  today = Date.current
  
  is_clean_subject = local_assigns[:enrollment] && enrollment.subject == '클린'
  clean_teachers_by_day = local_assigns[:clean_teachers_by_day] || {}
  
  if local_assigns[:enrollment]
    user_teacher = enrollment.teacher
    
    now = Time.current
    kst_zone = ActiveSupport::TimeZone['Seoul']
    
    # 다음 수업 찾기 (시간 체크)
    upcoming_schedules = TeacherSchedule.where(user_enrollment_id: enrollment.id)
      .where('lesson_date >= ?', today)
      .order(:lesson_date)
    
    next_lesson = nil
    following_lesson = nil
    
    upcoming_schedules.each do |schedule|
      end_hour = schedule.time_slot.split('-').last.to_i
      lesson_end_time = kst_zone.local(schedule.lesson_date.year, schedule.lesson_date.month, schedule.lesson_date.day, end_hour, 0, 0)
      
      if lesson_end_time > now
        if next_lesson.nil?
          next_lesson = schedule.lesson_date
        elsif following_lesson.nil?
          following_lesson = schedule.lesson_date
          break
        end
      end
    end
    
    # 이전 수업 찾기 (시간 체크)
    past_schedules = TeacherSchedule.where(user_enrollment_id: enrollment.id)
      .where('lesson_date <= ?', today)
      .order(lesson_date: :desc)
    
    prev_lesson = nil
    past_schedules.each do |schedule|
      end_hour = schedule.time_slot.split('-').last.to_i
      lesson_end_time = kst_zone.local(schedule.lesson_date.year, schedule.lesson_date.month, schedule.lesson_date.day, end_hour, 0, 0)
      
      if lesson_end_time <= now
        prev_lesson = schedule.lesson_date
        break
      end
    end
  else
    user_teacher = current_user&.primary_teacher || ''
    next_lesson = current_user&.next_lesson_date
    following_lesson = current_user&.following_lesson_date
    prev_lesson = current_user&.prev_lesson_date
  end
%>

<div class="calendar" data-month="<%= date.strftime('%Y-%m') %>">
  <div class="calendar-header">
    <button class="calendar-nav-btn" onclick="navigateMakeupPassMonth('prev')">←</button>
    <h3 class="calendar-month-title"><%= date.strftime('%Y년 %m월') %></h3>
    <button class="calendar-nav-btn" onclick="navigateMakeupPassMonth('next')">→</button>
  </div>
  
  <div class="calendar-grid">
    <% %w[일 월 화 수 목 금 토].each do |day| %>
      <div class="calendar-weekday"><%= day %></div>
    <% end %>
    
    <% weeks.each do |week| %>
      <% week.each do |day| %>
        <%
          is_today = day == today
          is_past = day < today
          is_current_month = day.month == date.month
          is_monday = day.wday == 1  # 월요일 체크
          is_tuesday = day.wday == 2  # 화요일 체크
          is_wednesday = day.wday == 3  # 수요일 체크
          is_thursday = day.wday == 4  # 목요일 체크
          is_friday = day.wday == 5  # 금요일 체크
          is_saturday = day.wday == 6  # 토요일 체크
          is_sunday = day.wday == 0  # 일요일 체크

          # 이번/다음 수업일 체크
          is_prev_lesson = prev_lesson && day == prev_lesson
          is_next_lesson = next_lesson && day == next_lesson
          is_following_lesson = following_lesson && day == following_lesson

          is_makeup_available = false
          if following_lesson && day >= today && day < following_lesson
            is_makeup_available = true
          end

          is_teacher_closed = if day.wday == 1
            true
          elsif is_clean_subject
            clean_teachers = ['무성', '성균', '노네임', '로한', '범석', '두박', '오또']
            clean_teachers.all? { |teacher| Teacher.closed_on?(teacher, day) }
          elsif user_teacher.present?
            Teacher.closed_on?(user_teacher, day)
          else
            false
          end

          blocked_dates = (Date.new(2025, 10, 2)..Date.new(2025, 10, 10)).to_a
          is_blocked = blocked_dates.include?(day)

          css_classes = []
          css_classes << "calendar-day-cell"
          css_classes << "not-current-month" unless is_current_month
          css_classes << "past-day" if is_past
          css_classes << "today" if is_today
          css_classes << "blocked-day" if is_blocked
          
          if is_prev_lesson || is_next_lesson || is_following_lesson
            css_classes << "lesson-day" unless is_blocked
          elsif is_teacher_closed
            css_classes << "monday-closed"
          end
          
          css_classes << "between-lessons" if is_makeup_available && !is_teacher_closed && !is_blocked

          is_clickable = is_current_month && !is_blocked && is_makeup_available && !is_teacher_closed && !is_prev_lesson
        %>
        
        <div class="<%= css_classes.join(' ') %>" 
             data-date="<%= day.strftime('%Y-%m-%d') %>"
             <% if is_clickable %>
               data-clickable="true"
               onclick="selectDate(this)"
             <% end %>>
          <div class="day-number"><%= day.day %></div>
          <div class="day-label">
            <% if is_prev_lesson && is_current_month %>
              저번수업
            <% elsif is_next_lesson && is_current_month %>
              이번수업
            <% elsif is_following_lesson && is_current_month %>
              다음수업
            <% elsif is_teacher_closed && is_current_month %>
              휴무
            <% elsif is_blocked && is_current_month %>
              예약불가
            <% elsif is_today && !is_makeup_available %>
              예약불가
            <% else %>
              &nbsp;
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>