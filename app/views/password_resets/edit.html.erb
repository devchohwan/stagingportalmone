<div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-md w-full space-y-8">
    <div>
      <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
        ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
      </h2>
      <p class="mt-2 text-center text-sm text-gray-600">
        ì „í™”ë²ˆí˜¸ ì¸ì¦ í›„ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”
      </p>
    </div>
    
    <% if flash[:alert] %>
      <div class="bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <span class="block sm:inline"><%= flash[:alert] %></span>
      </div>
    <% end %>
    
    <!-- ì „í™”ë²ˆí˜¸ ì¸ì¦ ì„¹ì…˜ -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ“± ì „í™”ë²ˆí˜¸ ì¸ì¦</h3>
      <p class="text-sm text-gray-600 mb-4">ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ <%= @user.phone.gsub(/(\d{3})(\d{3,4})(\d{4})/, '\1-\2-\3') %>ë¡œ ì¸ì¦ë²ˆí˜¸ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.</p>
      
      <div class="space-y-3">
        <button type="button" 
                id="send-verification-btn"
                onclick="sendVerificationForReset()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors mb-4">
          ì¸ì¦ë²ˆí˜¸ ë°œì†¡
        </button>
        
        <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ í•„ë“œ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="verification-input-section" class="hidden">
          <div class="flex gap-2">
            <input type="text" 
                   id="verification-code"
                   placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ ì…ë ¥"
                   maxlength="6"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            <button type="button"
                    onclick="verifyCodeForReset()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium whitespace-nowrap transition-colors">
              í™•ì¸
            </button>
          </div>
          <p id="timer-display" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <p id="verification-status" class="text-xs"></p>
      </div>
    </div>
    
    <!-- ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì„¹ì…˜ -->
    <div id="password-section" class="bg-white p-6 rounded-lg shadow opacity-50 pointer-events-none">
      <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ”’ ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h3>
      
      <%= form_with url: password_reset_path, method: :patch, local: true, data: { turbo: false }, class: "space-y-4", id: "password-reset-form" do |f| %>
        <div class="space-y-4">
          <div>
            <%= f.label :password, "ìƒˆ ë¹„ë°€ë²ˆí˜¸", class: "block text-sm font-medium text-gray-700" %>
            <%= f.password_field :password, 
                required: true,
                class: "appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm",
                placeholder: "ìµœì†Œ 6ì ì´ìƒ" %>
          </div>
          
          <div>
            <%= f.label :password_confirmation, "ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸", class: "block text-sm font-medium text-gray-700" %>
            <%= f.password_field :password_confirmation, 
                required: true,
                class: "appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm",
                placeholder: "ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥" %>
          </div>
        </div>

        <div>
          <%= f.submit "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½", 
              class: "group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer" %>
        </div>
      <% end %>
    </div>
    
    <div class="text-center">
      <%= link_to "â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°", login_path, class: "font-medium text-indigo-600 hover:text-indigo-500 text-sm" %>
    </div>
  </div>
</div>

<script>
let verificationTimer;
let timeLeft = 180; // 3ë¶„
let isPhoneVerified = false;

function sendVerificationForReset() {
  const phone = '<%= @user.phone %>';
  
  // ì¸ì¦ë²ˆí˜¸ ë°œì†¡ API í˜¸ì¶œ
  fetch('/api/send-verification', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ phone: phone })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert(data.message || 'ì¸ì¦ë²ˆí˜¸ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    console.log('ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì„±ê³µ:', data.message);
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
  
  // UI ì—…ë°ì´íŠ¸
  document.getElementById('verification-input-section').classList.remove('hidden');
  const btn = document.getElementById('send-verification-btn');
  btn.textContent = 'ì¬ë°œì†¡';
  btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
  btn.classList.add('bg-gray-500', 'hover:bg-gray-600');
  
  // ìƒíƒœ ë©”ì‹œì§€
  const statusEl = document.getElementById('verification-status');
  statusEl.textContent = 'ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
  statusEl.classList.add('text-green-600');
  statusEl.classList.remove('text-red-600');
  
  // íƒ€ì´ë¨¸ ì‹œì‘
  startTimerForReset();
}

function startTimerForReset() {
  // ì´ì „ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™”
  if (verificationTimer) {
    clearInterval(verificationTimer);
  }
  
  timeLeft = 180; // 3ë¶„ ë¦¬ì…‹
  
  verificationTimer = setInterval(() => {
    timeLeft--;
    
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    
    document.getElementById('timer-display').textContent = 
      `ë‚¨ì€ ì‹œê°„: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
      clearInterval(verificationTimer);
      document.getElementById('timer-display').textContent = 'ì‹œê°„ ì´ˆê³¼ - ì¬ë°œì†¡ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”';
      document.getElementById('timer-display').classList.add('text-red-600');
    }
  }, 1000);
}

function verifyCodeForReset() {
  const code = document.getElementById('verification-code').value;
  
  if (!code || code.length !== 6) {
    alert('6ìë¦¬ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì¸ì¦ë²ˆí˜¸ í™•ì¸ API í˜¸ì¶œ
  fetch('/api/verify-code', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ code: code })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert(data.message || 'ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ì¸ì¦ ì„±ê³µ ì²˜ë¦¬
    isPhoneVerified = true;
    clearInterval(verificationTimer);
    
    // UI ì—…ë°ì´íŠ¸ - ì¸ì¦ ì„¹ì…˜ ì™„ë£Œ í‘œì‹œ
    const statusEl = document.getElementById('verification-status');
    statusEl.textContent = 'âœ“ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    statusEl.classList.add('text-green-600');
    statusEl.classList.remove('text-red-600');
    
    // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
    document.getElementById('verification-input-section').classList.add('hidden');
    document.getElementById('send-verification-btn').style.display = 'none';
    
    // ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì„¹ì…˜ í™œì„±í™”
    const passwordSection = document.getElementById('password-section');
    passwordSection.classList.remove('opacity-50', 'pointer-events-none');
    passwordSection.classList.add('ring-2', 'ring-green-500');
  })
  .catch(error => {
    console.error('Error:', error);
    alert('ì¸ì¦ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}

// í¼ ì œì¶œ ì‹œ ì¸ì¦ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('password-reset-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      if (!isPhoneVerified) {
        e.preventDefault();
        alert('ì „í™”ë²ˆí˜¸ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
      }
    });
  }
});
</script>