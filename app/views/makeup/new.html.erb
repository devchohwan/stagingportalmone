<style>
  .reserve-container {
    min-height: 100vh;
    background: #ffffff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 40px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .reserve-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .reserve-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 20px;
    line-height: 1.3;
  }
  
  .content-wrapper {
    width: 100%;
    max-width: 500px;
  }
  
  .step-section {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
    padding: 25px;
  }
  
  .step-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 15px;
    font-size: 1.1rem;
  }
  
  .calendar-container {
    background: #ffffff;
    border-radius: 8px;
    padding: 0;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    text-align: center;
    display: block;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    width: 100%;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
  }
  
  .confirmation-card {
    background: linear-gradient(135deg, rgba(240, 147, 251, 0.05), rgba(245, 87, 108, 0.05));
    border: 2px solid rgba(240, 147, 251, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .confirmation-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 10px;
  }
  
  .confirmation-text {
    color: #4a5568;
    font-size: 0.9rem;
    line-height: 1.5;
  }
  
  .back-link {
    color: #718096;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.3s ease;
    text-align: center;
    display: block;
    margin-top: 30px;
  }
  
  .back-link:hover {
    color: #2d3748;
    text-decoration: none;
  }
  
  /* Calendar specific styles */
  .calendar {
    width: 100%;
  }
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .calendar-nav-btn {
    color: #718096;
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
  }
  
  .calendar-nav-btn:hover {
    color: #2d3748;
    background-color: #f7fafc;
  }
  
  .calendar-month-title {
    font-weight: 600;
    color: #2d3748;
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    text-align: center;
  }
  
  .calendar-weekday {
    font-weight: 600;
    color: #718096;
    font-size: 0.75rem;
    padding: 8px 0;
  }
  
  .calendar-day-cell {
    padding: 12px;
    text-align: center;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: white;
    border: 1px solid #e2e8f0;
  }
  
  .calendar-day-cell:hover:not(.past-day):not(.monday-closed) {
    background-color: #f7fafc;
    border-color: #f093fb;
  }
  
  .calendar-day-cell.selected {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
    border-color: #f093fb;
  }
  
  .calendar-day-cell.not-current-month {
    opacity: 0.3;
  }
  
  .calendar-day-cell.past-day,
  .calendar-day-cell.monday-closed {
    cursor: not-allowed;
    opacity: 0.4;
    background-color: #f9fafb;
  }
  
  .calendar-day-cell.today {
    color: #059669;
    font-weight: bold;
  }
  
  .calendar-day-cell.monday-closed {
    background-color: #f3f4f6;
    color: #9ca3af;
  }
  
  .day-number {
    font-size: 0.9rem;
  }
  
  .day-label {
    font-size: 0.7rem;
    margin-top: 2px;
  }
  
  .today .day-label {
    color: #059669;
  }
  
  .monday-closed .day-label {
    color: #9ca3af;
  }
  
  /* Time slot styles */
  .time-slots-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .period-section {
    margin-bottom: 15px;
  }
  
  .period-title {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 12px;
    color: #2d3748;
  }
  
  .time-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  
  .time-slot-btn {
    padding: 10px 15px;
    font-size: 0.9rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background-color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }
  
  .time-slot-btn:hover:not(.disabled):not(.selected) {
    background-color: #f7fafc;
    border-color: #f093fb;
  }
  
  .time-slot-btn.selected {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
    border-color: #f093fb;
  }
  
  .time-slot-btn.disabled,
  .time-slot-btn:disabled {
    background-color: #f9fafb;
    color: #9ca3af;
    border-color: #e5e7eb;
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  /* Room selection styles */
  .rooms-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .room-btn {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    background-color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }
  
  .room-btn:hover:not(.unavailable):not(.selected) {
    border-color: #f093fb;
    background-color: #f7fafc;
  }
  
  .room-btn.selected {
    background-color: rgba(240, 147, 251, 0.1);
    border-color: #f093fb;
  }
  
  .room-btn.unavailable {
    cursor: not-allowed;
    background-color: #fef2f2;
    border-color: #fecaca;
    opacity: 0.75;
  }
  
  .room-name {
    font-weight: 600;
    color: #2d3748;
  }
  
  .room-btn.unavailable .room-name {
    color: #9ca3af;
  }
  
  .room-info {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  .room-btn.pending {
    cursor: not-allowed;
    background-color: #fffbeb;
    border-color: #fbbf24;
    opacity: 0.8;
  }
  
  .status-pending {
    font-size: 0.75rem;
    background-color: #fef3c7;
    color: #92400e;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .status-available {
    font-size: 0.75rem;
    background-color: #dcfce7;
    color: #166534;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .status-unavailable {
    font-size: 0.75rem;
    background-color: #fee2e2;
    color: #991b1b;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  @media (max-width: 480px) {
    .reserve-title {
      font-size: 1.2rem;
      white-space: nowrap;
    }
    
    .reserve-container {
      padding: 20px 15px;
    }
    
    .content-wrapper {
      max-width: 100%;
    }
    
    .step-title {
      font-size: 1rem;
    }
    
    .calendar-grid {
      gap: 2px;
    }
    
    .calendar-day-cell {
      padding: 8px 4px;
      font-size: 12px;
    }
    
    .day-number {
      font-size: 0.75rem;
    }
    
    .day-label {
      font-size: 0.6rem;
    }
    
    .calendar-weekday {
      font-size: 0.7rem;
      padding: 6px 0;
    }
    
    .time-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .time-slot-btn {
      padding: 8px 12px;
      font-size: 0.75rem;
    }
    
    .room-btn {
      padding: 12px;
      font-size: 0.85rem;
    }
    
    .confirmation-text {
      font-size: 0.8rem;
    }
    
    .btn-primary {
      font-size: 14px;
      padding: 12px 16px;
    }
    
    .back-link {
      font-size: 0.8rem;
    }
  }
</style>

<div class="reserve-container">
  <div class="reserve-header">
    <h1 class="reserve-title">ë³´ì¶©ìˆ˜ì—… ì˜ˆì•½í•˜ê¸°</h1>
  </div>

  <div class="content-wrapper">
    <% if flash[:alert] %>
      <script>
        alert('ì´ë¯¸ ì˜ˆì•½í•˜ì…¨ìŠµë‹ˆë‹¤. ì˜ˆì•½í•œ ì‹œê°„ì„ ë¨¼ì € ì‚¬ìš©í•´ì£¼ì„¸ìš”');
      </script>
    <% end %>
    
    <div>
      <!-- Step 1: ë‚ ì§œ ì„ íƒ -->
      <div class="step-section" data-reservation-target="dateSection">
        <h3 class="step-title">1. ë‚ ì§œ ì„ íƒ</h3>
        <div id="calendar-container" class="calendar-container">
          <%= render partial: 'calendar', locals: { date: @date, selected_date: nil } %>
        </div>
      </div>
      
      <!-- Step 2: ì‹œê°„ ì„ íƒ -->
      <div class="step-section hidden" data-reservation-target="timeSection">
        <h3 class="step-title">2. ì‹œê°„ ì„ íƒ</h3>
        <div id="time-slots-container">
          <!-- Time slots will be loaded here -->
        </div>
      </div>
      
      <!-- Step 3: ì¢Œì„ ì„ íƒ -->
      <div class="step-section hidden" data-reservation-target="roomSection">
        <h3 class="step-title">3. ì¢Œì„ ì„ íƒ</h3>
        <div id="rooms-container">
          <!-- Available rooms will be loaded here -->
        </div>
      </div>
      
      <!-- Step 4: ë³´ì¶©ìˆ˜ì—… ë‚´ìš© ì…ë ¥ -->
      <div class="step-section hidden" data-reservation-target="contentSection">
        <h3 class="step-title">4. ë³´ì¶©ìˆ˜ì—… ë°›ê³  ì‹¶ì€ ë‚´ìš©</h3>
        <textarea id="lesson-content" 
                  placeholder="ë³´ì¶©ìˆ˜ì—… ë°›ê³  ì‹¶ìœ¼ì‹  ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”ğŸ˜Š" 
                  style="width: 100%; min-height: 150px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; resize: vertical;"
                  onblur="if(this.value.trim()) showConfirmation()"></textarea>
        <p style="margin-top: 10px; font-size: 0.85rem; color: #6b7280;">ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ë‹¤ë¥¸ ê³³ì„ í´ë¦­í•˜ë©´ í™•ì¸ ë‹¨ê³„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>
      </div>
      
      <!-- ì˜ˆì•½ í™•ì¸ -->
      <div class="hidden" data-reservation-target="confirmSection">
        <%= form_with url: makeup_path, method: :post, local: true, data: { reservation_target: "form", turbo: false } do |f| %>
          <%= hidden_field_tag "makeup_lesson[makeup_room_id]", nil, data: { reservation_target: "roomId" } %>
          <%= hidden_field_tag "makeup_lesson[start_time]", nil, data: { reservation_target: "startTime" } %>
          <%= hidden_field_tag "makeup_lesson[end_time]", nil, data: { reservation_target: "endTime" } %>
          <%= hidden_field_tag "makeup_lesson[lesson_content]", nil, data: { reservation_target: "lessonContent" } %>
          
          <div class="confirmation-card">
            <h3 class="confirmation-title">ì˜ˆì•½ ì •ë³´ í™•ì¸</h3>
            <div class="confirmation-text" data-reservation-target="summary"></div>
          </div>
          
          <button type="button" class="btn-primary" id="reservation-submit-btn" onclick="window.confirmMakeupReservation()">ì˜ˆì•½í•˜ê¸°</button>
        <% end %>
      </div>
    </div>

    <%= link_to "â† ë’¤ë¡œê°€ê¸°", makeup_path, class: "back-link" %>
  </div>
</div>

<script>
// ë³´ì¶©ìˆ˜ì—… ì˜ˆì•½ JavaScript - ì „ì—­ ìŠ¤ì½”í”„ë¡œ ìˆ˜ì •
var selectedDate = null;
var selectedTime = null;
var selectedRoom = null;

function selectDate(element) {
  selectedDate = element.getAttribute('data-date');
  console.log('ë‚ ì§œ ì„ íƒ:', selectedDate);
  
  // ì‹œê°ì  ì„ íƒ ì—…ë°ì´íŠ¸
  var dateElements = document.querySelectorAll('[data-date]');
  for (var i = 0; i < dateElements.length; i++) {
    dateElements[i].classList.remove('selected');
  }
  element.classList.add('selected');
  
  // ì‹œê°„ ìŠ¬ë¡¯ ë¡œë“œ
  fetch('/makeup/time_slots?date=' + selectedDate)
    .then(function(response) { return response.text(); })
    .then(function(html) {
      document.getElementById('time-slots-container').innerHTML = html;
      var timeSection = document.querySelector('[data-reservation-target="timeSection"]');
      if (timeSection) {
        timeSection.classList.remove('hidden');
        console.log('ì‹œê°„ ì„ íƒ ì„¹ì…˜ í‘œì‹œ');
      }
      hideSection('roomSection');
      hideSection('confirmSection');
    })
    .catch(function(error) {
      console.error('ì‹œê°„ ìŠ¬ë¡¯ ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

function selectTime(element) {
  selectedTime = {
    time: element.getAttribute('data-time'),
    display: element.getAttribute('data-display')
  };
  console.log('ì‹œê°„ ì„ íƒ:', selectedTime);
  
  // ì‹œê°ì  ì„ íƒ ì—…ë°ì´íŠ¸
  var timeElements = document.querySelectorAll('.time-slot-btn');
  for (var i = 0; i < timeElements.length; i++) {
    timeElements[i].classList.remove('selected');
  }
  element.classList.add('selected');
  
  // ì¢Œì„ ë¡œë“œ
  var startDateTime = new Date(selectedTime.time);
  var endDateTime = new Date(startDateTime.getTime() + 30 * 60000);
  
  fetch('/makeup/available_rooms?start_time=' + encodeURIComponent(selectedTime.time) + '&end_time=' + endDateTime.toISOString())
    .then(function(response) { return response.text(); })
    .then(function(html) {
      document.getElementById('rooms-container').innerHTML = html;
      var roomSection = document.querySelector('[data-reservation-target="roomSection"]');
      if (roomSection) {
        roomSection.classList.remove('hidden');
        console.log('ì¢Œì„ ì„ íƒ ì„¹ì…˜ í‘œì‹œ');
      }
      hideSection('confirmSection');
    })
    .catch(function(error) {
      console.error('ì¢Œì„ ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

function selectRoom(element) {
  selectedRoom = {
    id: element.getAttribute('data-room-id'),
    number: element.getAttribute('data-room-number')
  };
  console.log('ì¢Œì„ ì„ íƒ:', selectedRoom);
  
  // ì‹œê°ì  ì„ íƒ ì—…ë°ì´íŠ¸
  var roomElements = document.querySelectorAll('.room-btn');
  for (var i = 0; i < roomElements.length; i++) {
    roomElements[i].classList.remove('selected');
  }
  element.classList.add('selected');
  
  // ë³´ì¶©ìˆ˜ì—… ë‚´ìš© ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
  var contentSection = document.querySelector('[data-reservation-target="contentSection"]');
  if (contentSection) {
    contentSection.classList.remove('hidden');
    console.log('ë³´ì¶©ìˆ˜ì—… ë‚´ìš© ì…ë ¥ ì„¹ì…˜ í‘œì‹œ');
  }
  hideSection('confirmSection');
}

function showConfirmation() {
  var selectedDateTime = new Date(selectedTime.time);
  var endDateTime = new Date(selectedDateTime.getTime() + 30 * 60000);
  
  // lesson content ê°€ì ¸ì˜¤ê¸°
  var lessonContent = document.getElementById('lesson-content').value;
  
  // í¼ í•„ë“œ ì„¤ì •
  var roomIdField = document.querySelector('[data-reservation-target="roomId"]');
  var startTimeField = document.querySelector('[data-reservation-target="startTime"]');
  var endTimeField = document.querySelector('[data-reservation-target="endTime"]');
  var lessonContentField = document.querySelector('[data-reservation-target="lessonContent"]');
  
  if (roomIdField) roomIdField.value = selectedRoom.id;
  if (startTimeField) startTimeField.value = selectedTime.time;
  if (endTimeField) endTimeField.value = endDateTime.toISOString();
  if (lessonContentField) lessonContentField.value = lessonContent;
  
  console.log('Form values set:', {
    roomId: roomIdField.value,
    startTime: startTimeField.value,
    endTime: endTimeField.value,
    lessonContent: lessonContentField.value
  });
  
  // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
  var dateObj = new Date(selectedDate);
  var weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  var weekday = weekdays[dateObj.getDay()];
  var formattedDate = (dateObj.getMonth() + 1) + 'ì›” ' + dateObj.getDate() + 'ì¼(' + weekday + ')';
  
  var summaryElement = document.querySelector('[data-reservation-target="summary"]');
  if (summaryElement) {
    var lessonContent = document.getElementById('lesson-content').value.trim();
    var contentPreview = lessonContent.length > 50 ? lessonContent.substring(0, 50) + '...' : lessonContent;
    
    summaryElement.innerHTML = 
      '<div>ë‚ ì§œ: ' + formattedDate + '</div>' +
      '<div>ì‹œê°„: ' + selectedTime.display + ' - ' + endDateTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit', hour12: false}) + '</div>' +
      '<div>ì¢Œì„: ' + selectedRoom.number + 'ë²ˆ</div>' +
      '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">ë³´ì¶©ìˆ˜ì—… ë‚´ìš©: ' + contentPreview + '</div>';
  }
  
  var confirmSection = document.querySelector('[data-reservation-target="confirmSection"]');
  if (confirmSection) {
    confirmSection.classList.remove('hidden');
    console.log('ì˜ˆì•½ í™•ì¸ ì„¹ì…˜ í‘œì‹œ');
  }
}

function hideSection(target) {
  var section = document.querySelector('[data-reservation-target="' + target + '"]');
  if (section) {
    section.classList.add('hidden');
  }
}

window.confirmMakeupReservation = function() {
  if (!selectedDate || !selectedTime || !selectedRoom) {
    alert('ì˜ˆì•½ ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.');
    return false;
  }

  var dateObj = new Date(selectedDate);
  var weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  var weekday = weekdays[dateObj.getDay()];
  var formattedDate = (dateObj.getMonth() + 1) + 'ì›” ' + dateObj.getDate() + 'ì¼(' + weekday + ')';
  
  var confirmMessage = 'ì˜ˆì•½ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‚ ì§œ: ' + formattedDate + '\nì‹œê°„: ' + selectedTime.display + '\nì¢Œì„: ' + selectedRoom.number + 'ë²ˆ';
  
  if (confirm(confirmMessage)) {
    var submitBtn = document.getElementById('reservation-submit-btn');
    var form = document.querySelector('[data-reservation-target="form"]');
    
    if (submitBtn) {
      if (submitBtn.disabled) {
        alert('ì´ë¯¸ ì˜ˆì•½ ìš”ì²­ì´ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.');
        return false;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'ì˜ˆì•½ ì¤‘...';
    }
    
    if (form) {
      if (form.requestSubmit) {
        var hiddenSubmit = document.createElement('input');
        hiddenSubmit.type = 'submit';
        hiddenSubmit.style.display = 'none';
        form.appendChild(hiddenSubmit);
        hiddenSubmit.click();
        form.removeChild(hiddenSubmit);
      } else {
        form.submit();
      }
    }
    return true;
  }
  return false;
};

window.showPendingMessage = function() {
  alert('â³ ì˜ˆì•½ ìŠ¹ì¸ì¤‘ì¸ ìë¦¬ì…ë‹ˆë‹¤.\n\n' +
        'ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì˜ˆì•½ì´ í™•ì •ë˜ë¯€ë¡œ\n' +
        'ë‹¤ë¥¸ ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
};

console.log('ë³´ì¶©ìˆ˜ì—… ì˜ˆì•½ JavaScript ë¡œë“œ ì™„ë£Œ');
</script>