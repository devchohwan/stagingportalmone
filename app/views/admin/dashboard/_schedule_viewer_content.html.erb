<style>
  /* ì „ì²´ ì»¨í…Œì´ë„ˆ - ê³ ìœ  í´ë˜ìŠ¤ë¡œ CSS ê²©ë¦¬ */
  .schedule-viewer-wrapper {
    min-height: 100vh;
    background: #f9fafb;
    padding: 1.5rem;
  }

  .schedule-viewer-wrapper .header-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-viewer-wrapper .header-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #667eea;
  }

  .schedule-viewer-wrapper .tabs-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-viewer-wrapper .teacher-tab {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .schedule-viewer-wrapper .teacher-tab.active {
    background: #667eea;
    color: white;
  }

  .schedule-viewer-wrapper .teacher-tab:not(.active) {
    background: #e5e7eb;
    color: #374151;
  }

  .schedule-viewer-wrapper .teacher-tab:not(.active):hover {
    background: #d1d5db;
  }

  .schedule-viewer-wrapper .nav-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-viewer-wrapper .nav-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .schedule-viewer-wrapper .nav-btn:hover {
    background: #5568d3;
  }

  .schedule-viewer-wrapper .table-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .schedule-viewer-wrapper table {
    border-collapse: collapse;
    table-layout: fixed;
    width: auto;
  }

  .schedule-viewer-wrapper th {
    background: #667eea;
    color: white;
    font-weight: 700;
    padding: 0.5rem;
    border: 1px solid white;
    text-align: center;
    width: 140px;
  }

  .schedule-viewer-wrapper th:first-child {
    width: 80px;
  }

  .schedule-viewer-wrapper td {
    border: 1px solid #e5e7eb;
    vertical-align: top;
    background: white;
    padding: 0;
    width: 140px;
  }

  .schedule-viewer-wrapper .time-cell {
    background: #f9fafb;
    font-weight: 700;
    text-align: center;
    padding: 0.5rem;
    position: sticky;
    left: 0;
    z-index: 10;
    width: 80px;
  }

  .schedule-viewer-wrapper .schedule-cell {
    min-height: 160px;
    padding: 0.4rem;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .schedule-viewer-wrapper .schedule-cell.holiday {
    background: repeating-linear-gradient(
      45deg,
      #f9fafb,
      #f9fafb 10px,
      #f3f4f6 10px,
      #f3f4f6 20px
    );
    opacity: 0.6;
  }

  .schedule-viewer-wrapper .schedule-cell.holiday::before {
    content: 'ğŸš« íœ´ë¬´ì¼';
    display: block;
    text-align: center;
    color: #9ca3af;
    font-size: 0.75rem;
    margin-top: 3rem;
  }

  .schedule-viewer-wrapper .student-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.35rem 0.5rem;
    transition: all 0.2s;
  }

  .schedule-viewer-wrapper .student-card:hover {
    border-color: #667eea;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
    transform: translateX(2px);
  }

  .schedule-viewer-wrapper .student-name {
    font-weight: 700;
    color: #374151;
    font-size: 0.8rem;
    line-height: 1.3;
  }

  .schedule-viewer-wrapper .student-username {
    font-size: 0.7rem;
    color: #6b7280;
    margin-top: 0.1rem;
    line-height: 1.2;
  }

  .schedule-viewer-wrapper .count-badge {
    background: #f3f4f6;
    color: #4b5563;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    text-align: center;
    margin-top: 0.5rem;
  }

  .schedule-viewer-wrapper .legend-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-viewer-wrapper .legend-items {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    font-size: 0.875rem;
  }

  .schedule-viewer-wrapper .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .schedule-viewer-wrapper .legend-box {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 4px;
  }
</style>

<div class="schedule-viewer-wrapper">
  <!-- í—¤ë” -->
  <div class="header-card">
    <h1 class="header-title">ğŸ“º ì‹œê°„í‘œ ë·°ì–´</h1>
  </div>

  <!-- ì„ ìƒë‹˜ íƒ­ -->
  <div class="tabs-card">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <% @teachers.each do |teacher| %>
        <button
          onclick="window.switchScheduleTeacherViewer('<%= teacher %>')"
          class="teacher-tab <%= teacher == @selected_teacher ? 'active' : '' %>"
          data-teacher="<%= teacher %>">
          <%= teacher %>
        </button>
      <% end %>
    </div>
  </div>

  <!-- ì£¼ì°¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="nav-card">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
      <button onclick="window.changeScheduleWeekViewer(-1)" class="nav-btn">
        â† ì´ì „ ì£¼
      </button>
      <div id="week-display-viewer" style="font-weight: 700; font-size: 1.125rem; color: #374151;">
        2025ë…„ 10ì›” 13ì¼ ì£¼
      </div>
      <button onclick="window.changeScheduleWeekViewer(1)" class="nav-btn">
        ë‹¤ìŒ ì£¼ â†’
      </button>
    </div>
  </div>

  <!-- ë²”ë¡€ -->
  <div class="legend-card">
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-box" style="background: white; border: 2px solid #e5e7eb;"></div>
        <span>ì •ê·œ ìˆ˜ì—…</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: repeating-linear-gradient(45deg, #f9fafb, #f9fafb 5px, #f3f4f6 5px, #f3f4f6 10px);"></div>
        <span>íœ´ë¬´ì¼</span>
      </div>
    </div>
  </div>

  <!-- ì‹œê°„í‘œ í…Œì´ë¸” -->
  <div class="table-container">
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th style="width: 100px; position: sticky; left: 0; z-index: 20;">ì‹œê°„</th>
            <th id="header-mon-viewer">ì›”<br><span style="font-weight: 400; font-size: 0.875rem;">10/13</span></th>
            <th id="header-tue-viewer">í™”<br><span style="font-weight: 400; font-size: 0.875rem;">10/14</span></th>
            <th id="header-wed-viewer">ìˆ˜<br><span style="font-weight: 400; font-size: 0.875rem;">10/15</span></th>
            <th id="header-thu-viewer">ëª©<br><span style="font-weight: 400; font-size: 0.875rem;">10/16</span></th>
            <th id="header-fri-viewer">ê¸ˆ<br><span style="font-weight: 400; font-size: 0.875rem;">10/17</span></th>
            <th id="header-sat-viewer">í† <br><span style="font-weight: 400; font-size: 0.875rem;">10/18</span></th>
            <th id="header-sun-viewer">ì¼<br><span style="font-weight: 400; font-size: 0.875rem;">10/19</span></th>
          </tr>
        </thead>
        <tbody>
          <% ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'].each do |time_slot| %>
            <tr>
              <td class="time-cell">
                <%= time_slot.split('-').map { |t| "#{t}:00" }.join('-') %>
              </td>
              <% ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].each do |day| %>
                <td>
                  <div class="schedule-cell" id="cell-viewer-<%= day %>-<%= time_slot %>" data-day="<%= day %>" data-time="<%= time_slot %>">
                  </div>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function() {
  window.currentScheduleTeacherViewer = '<%= @selected_teacher %>';
  window.currentWeekOffsetViewer = 0;
  window.teacherHolidaysViewer = <%= raw @teacher_holidays.to_json %>;

  // ì„ ìƒë‹˜ì´ íŠ¹ì • ìš”ì¼ì— íœ´ë¬´ì¸ì§€ í™•ì¸
  window.isTeacherHolidayViewer = function(teacher, dayOfWeek) {
    const holidays = window.teacherHolidaysViewer[teacher] || [];
    return holidays.includes(dayOfWeek);
  };

  // ì„ ìƒë‹˜ ë³€ê²½
  window.switchScheduleTeacherViewer = function(teacher) {
    window.currentScheduleTeacherViewer = teacher;

    // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
    document.querySelectorAll('.schedule-viewer-wrapper .teacher-tab').forEach(tab => {
      if (tab.getAttribute('data-teacher') === teacher) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    loadScheduleViewer();
    updateHolidayCellsViewer();
  };

  // ì£¼ì°¨ ë³€ê²½
  window.changeScheduleWeekViewer = function(offset) {
    window.currentWeekOffsetViewer += offset;
    loadScheduleViewer();
    updateHolidayCellsViewer();
  };

  // ì‹œê°„í‘œ ë¡œë“œ
  function loadScheduleViewer() {
    fetch(`/admin/load_schedule?teacher=${encodeURIComponent(window.currentScheduleTeacherViewer)}&week_offset=${window.currentWeekOffsetViewer}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderScheduleViewer(data);
          updateWeekDisplayViewer();
        } else {
          alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error loading schedule:', error);
        alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  }

  // ì‹œê°„í‘œ ë Œë”ë§
  function renderScheduleViewer(data) {
    // ëª¨ë“  ì…€ ì´ˆê¸°í™”
    document.querySelectorAll('.schedule-viewer-wrapper .schedule-cell').forEach(cell => {
      cell.innerHTML = '';
    });

    // ìŠ¤ì¼€ì¤„ ë°ì´í„° ë Œë”ë§
    const schedules = data.schedules || {};

    for (const [day, timeSlots] of Object.entries(schedules)) {
      for (const [timeSlot, students] of Object.entries(timeSlots)) {
        const cellId = `cell-viewer-${day}-${timeSlot}`;
        const cell = document.getElementById(cellId);

        if (cell && students && students.length > 0) {
          students.forEach(student => {
            const card = document.createElement('div');
            card.className = 'student-card';

            // ë³´ê°•ì¼ ê²½ìš° ë‹¤ë¥¸ ë°°ê²½ìƒ‰
            if (student.is_makeup) {
              card.style.background = '#fef3c7';  // ì—°ë…¸ë‘
              card.style.color = '#000';
              card.style.border = '2px solid #fbbf24';
              card.style.cursor = 'pointer';
              card.onclick = () => showMakeupRequestInfo(student.makeup_request_id);
            } else if (student.is_makeup_away) {
              // ë³´ê°•ìœ¼ë¡œ ë‹¤ë¥¸ ìŠ¤ì¼€ì¤„ë¡œ ë¹ ì§„ ê²½ìš° - íšŒìƒ‰ ë°°ê²½
              card.style.background = '#e5e7eb';
              card.style.borderColor = '#9ca3af';
            } else if (student.is_pass) {
              // íŒ¨ìŠ¤ì¸ ê²½ìš° - íšŒìƒ‰ ë°°ê²½
              card.style.background = '#e5e7eb';
              card.style.borderColor = '#9ca3af';
            } else if (student.is_absent) {
              // ê²°ì„ì¸ ê²½ìš° - íšŒìƒ‰ ë°°ê²½
              card.style.background = '#e5e7eb';
              card.style.borderColor = '#9ca3af';
            } else if (student.is_on_leave) {
              // íœ´ì› ìƒíƒœ
              card.style.background = '#fef3c7'; // ì—°ë…¸ë‘
              card.style.borderColor = '#fbbf24';
            } else {
              // í™œì„± ìƒíƒœ
              card.style.background = '#d9f99d'; // ì—°ë‘ìƒ‰
              card.style.borderColor = '#84cc16';
            }

            const usernameDiv = document.createElement('div');
            usernameDiv.className = 'student-username';
            usernameDiv.style.fontWeight = '600';
            usernameDiv.style.textAlign = 'center';
            // ë³´ê°•ì¼ ê²½ìš°: ì´ë¦„(ì›ë˜ì„ ìƒë‹˜)
            if (student.is_makeup && student.original_teacher) {
              usernameDiv.textContent = `${student.name}(${student.original_teacher})`;
            } else if (student.is_makeup_away && student.moved_to_teacher) {
              // ë³´ê°•ìœ¼ë¡œ ì´ë™í•œ ê²½ìš°: ì´ë¦„(â†’ë³´ê°•ì˜ˆì •ì„ ìƒë‹˜)
              usernameDiv.textContent = `${student.name}(â†’${student.moved_to_teacher})`;
            } else if (student.is_pass) {
              // íŒ¨ìŠ¤ì¸ ê²½ìš°
              usernameDiv.textContent = `${student.name} (íŒ¨ìŠ¤)`;
            } else if (student.is_absent) {
              // ê²°ì„ì¸ ê²½ìš°
              usernameDiv.textContent = `${student.name} (ê²°ì„)`;
            } else if (student.is_on_leave) {
              // íœ´ì› ìƒíƒœ í‘œì‹œ
              usernameDiv.textContent = student.username + ' (íœ´ì›)';
            } else {
              usernameDiv.textContent = student.username;
            }

            card.appendChild(usernameDiv);
            cell.appendChild(card);
          });

          // ì¸ì›ìˆ˜ í‘œì‹œ
          const countBadge = document.createElement('div');
          countBadge.className = 'count-badge';
          countBadge.textContent = `${students.length}/3ëª…`;
          cell.appendChild(countBadge);
        }
      }
    }
  }

  // ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateWeekDisplayViewer() {
    const today = new Date();
    const weekStart = new Date(today);
    // ì¼ìš”ì¼ ì‹œì‘ (ì‹œê°„í‘œ ê´€ë¦¬ì™€ ë™ì¼)
    weekStart.setDate(today.getDate() - today.getDay() + (window.currentWeekOffsetViewer * 7));

    // ì›”ìš”ì¼ ë‚ ì§œë¡œ í‘œì‹œ
    const monday = new Date(weekStart);
    monday.setDate(weekStart.getDate() + 1);

    const year = monday.getFullYear();
    const month = monday.getMonth() + 1;
    const day = monday.getDate();

    const weekDisplay = document.getElementById('week-display-viewer');
    if (weekDisplay) {
      weekDisplay.textContent = `${year}ë…„ ${month}ì›” ${day}ì¼ ì£¼`;
    }

    // ê° ìš”ì¼ì˜ ë‚ ì§œ ì—…ë°ì´íŠ¸
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

    days.forEach((day, index) => {
      const dayDate = new Date(weekStart);
      // weekStartëŠ” ì¼ìš”ì¼ì´ë¯€ë¡œ, monì€ +1, tueëŠ” +2, ... sunì€ +7
      dayDate.setDate(weekStart.getDate() + index + 1);

      const header = document.getElementById(`header-${day}-viewer`);
      if (header) {
        const m = dayDate.getMonth() + 1;
        const d = dayDate.getDate();
        header.innerHTML = `${dayNames[index]}<br><span style="font-weight: 400; font-size: 0.875rem;">${m}/${d}</span>`;
      }
    });
  }

  // íœ´ë¬´ì¼ ì…€ ì—…ë°ì´íŠ¸
  function updateHolidayCellsViewer() {
    const today = new Date();
    const weekStart = new Date(today);
    // ì¼ìš”ì¼ ì‹œì‘ (ì‹œê°„í‘œ ê´€ë¦¬ì™€ ë™ì¼)
    weekStart.setDate(today.getDate() - today.getDay() + (window.currentWeekOffsetViewer * 7));

    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const timeSlots = ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'];

    days.forEach((day, index) => {
      const dayDate = new Date(weekStart);
      // weekStartëŠ” ì¼ìš”ì¼ì´ë¯€ë¡œ, monì€ +1, tueëŠ” +2, ... sunì€ +7
      dayDate.setDate(weekStart.getDate() + index + 1);
      const dayOfWeek = dayDate.getDay();

      const isHoliday = window.isTeacherHolidayViewer(window.currentScheduleTeacherViewer, dayOfWeek);

      timeSlots.forEach(timeSlot => {
        const cell = document.getElementById(`cell-viewer-${day}-${timeSlot}`);
        if (cell) {
          if (isHoliday) {
            cell.classList.add('holiday');
          } else {
            cell.classList.remove('holiday');
          }
        }
      });
    });
  }

  // ë³´ê°• ì‹ ì²­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
  function showMakeupRequestInfo(requestId) {
    if (!requestId) return;

    fetch(`/admin/makeup_request_info?id=${requestId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const req = data.request;
          showMakeupModal(req);
        } else {
          alert('ë³´ê°• ì‹ ì²­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ë³´ê°• ì‹ ì²­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
  }

  // ë³´ê°• ì‹ ì²­ ì •ë³´ ëª¨ë‹¬
  function showMakeupModal(req) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    modal.innerHTML = `
      <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #667eea; padding-bottom: 1rem;">
          <h3 style="margin: 0; color: #667eea; font-size: 1.25rem; font-weight: 700;">ë³´ê°• ì‹ ì²­ ì •ë³´</h3>
          <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 1.5rem; color: #9ca3af; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>

        <div style="space-y: 1rem;">
          <div style="margin-bottom: 1rem;">
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem;">ì‹ ì²­ì</div>
            <div style="color: #1f2937; font-size: 1rem; font-weight: 600;">${req.user_name}</div>
          </div>

          <div style="margin-bottom: 1rem;">
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem;">ë³´ê°•ì¼</div>
            <div style="color: #1f2937; font-size: 1rem; font-weight: 600;">${req.makeup_date}</div>
          </div>

          <div style="margin-bottom: 1rem;">
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem;">ì‹œê°„</div>
            <div style="color: #1f2937; font-size: 1rem; font-weight: 600;">${req.time_slot}</div>
          </div>

          <div style="margin-bottom: 1rem;">
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem;">ë‹´ë‹¹</div>
            <div style="color: #1f2937; font-size: 1rem; font-weight: 600;">${req.teacher}</div>
          </div>

          <div style="margin-bottom: 1rem;">
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem;">ì£¼ì°¨</div>
            <div style="color: #1f2937; font-size: 1rem; font-weight: 600;">${req.week_number}ì£¼ì°¨</div>
          </div>

          <div style="margin-bottom: 1rem;">
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.25rem;">ì‹ ì²­ ë‚´ìš©</div>
            <div style="color: #1f2937; font-size: 0.95rem; white-space: pre-wrap; background: #f9fafb; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">${req.content || 'ë‚´ìš© ì—†ìŒ'}</div>
          </div>
        </div>

        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
          <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #667eea; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer;">ë‹«ê¸°</button>
        </div>
      </div>
    `;

    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };

    document.body.appendChild(modal);
  }

  // ì´ˆê¸° ë¡œë“œ
  loadScheduleViewer();
  updateHolidayCellsViewer();

  console.log('ì‹œê°„í‘œ ë·°ì–´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
})();
</script>
