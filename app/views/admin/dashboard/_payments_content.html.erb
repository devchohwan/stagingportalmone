<style>
  .payments-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    overflow: hidden;
    max-width: 100%;
  }

  .payments-content {
    padding: 25px;
    overflow-x: auto;
  }

  .payments-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .payments-table-header {
    background: #f8fafc;
  }

  .payments-table-header th {
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e2e8f0;
  }

  .payments-table-header th:first-child {
    border-radius: 8px 0 0 0;
  }

  .payments-table-header th:last-child {
    border-radius: 0 8px 0 0;
  }

  .payment-row {
    transition: background-color 0.2s ease;
  }

  .payment-row:hover {
    background: #f8fafc;
  }

  .payment-row td {
    padding: 15px 12px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
  }

  .user-name-payment {
    font-weight: 600;
    color: #2d3748;
  }

  .payment-date {
    color: #4a5568;
  }

  .payment-date.overdue {
    color: #dc2626;
    font-weight: 600;
  }

  .payment-date.none {
    color: #9ca3af;
    font-style: italic;
  }

  .pagination-container {
    margin-top: 25px;
    display: flex;
    justify-content: center;
    gap: 8px;
  }

  .pagination-btn {
    padding: 8px 16px;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    color: #4a5568;
    transition: all 0.3s ease;
  }

  .pagination-btn:hover:not(:disabled) {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .pagination-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .pagination-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .empty-state-payment {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
  }

  .empty-state-icon-payment {
    font-size: 3rem;
    margin-bottom: 16px;
  }

  .empty-state-text-payment {
    font-size: 1.1rem;
    font-weight: 500;
  }

  .remaining-lessons {
    color: #2d3748;
    font-weight: 600;
  }

  .payment-amount-input {
    width: 100px;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.85rem;
    transition: all 0.3s ease;
  }

  .payment-amount-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .payment-buttons {
    display: flex;
    gap: 6px;
  }

  .payment-period-btn {
    padding: 8px 14px;
    border: 1px solid #667eea;
    background: white;
    color: #667eea;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .payment-period-btn:hover {
    background: #667eea;
    color: white;
  }

  .subject-select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.85rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 90px;
  }

  .subject-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .confirm-payment-btn {
    padding: 8px 16px;
    border: 1px solid #10b981;
    background: #10b981;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .confirm-payment-btn:hover {
    background: #059669;
    border-color: #059669;
  }

  .leave-status-btn {
    padding: 8px 16px;
    border: 1px solid #9ca3af;
    background: white;
    color: #4a5568;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .leave-status-btn:hover {
    background: #f3f4f6;
    border-color: #6b7280;
  }

  .leave-status-btn.on-leave {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #d97706;
  }

  .leave-status-btn.on-leave:hover {
    background: #fde68a;
    border-color: #d97706;
  }

  /* 320px ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 320px) {
    .payments-container {
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .payments-content {
      padding: 16px;
      overflow-x: auto;
    }

    .payments-table {
      min-width: 500px;
      font-size: 0.8rem;
    }

    .payments-table-header th {
      padding: 10px 8px;
      font-size: 0.7rem;
    }

    .payment-row td {
      padding: 10px 8px;
      font-size: 0.8rem;
    }

    .user-name-payment {
      font-size: 0.85rem;
    }

    .pagination-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
    }

    .empty-state-payment {
      padding: 40px 16px;
    }

    .empty-state-icon-payment {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .empty-state-text-payment {
      font-size: 0.95rem;
    }

    .payment-amount-input {
      width: 80px;
      padding: 6px 8px;
      font-size: 0.75rem;
    }

    .payment-period-btn {
      padding: 6px 10px;
      font-size: 0.7rem;
    }

    .subject-select {
      padding: 6px 8px;
      font-size: 0.75rem;
      min-width: 70px;
    }

    .confirm-payment-btn {
      padding: 6px 12px;
      font-size: 0.7rem;
    }
  }

  /* ê²°ì œ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
  .payment-history-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .payment-history-modal.active {
    display: flex;
  }

  .payment-history-content {
    background: white;
    border-radius: 12px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .payment-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
  }

  .payment-history-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #2d3748;
  }

  .payment-history-close {
    font-size: 1.5rem;
    color: #9ca3af;
    cursor: pointer;
    border: none;
    background: none;
    padding: 0;
    line-height: 1;
  }

  .payment-history-close:hover {
    color: #4a5568;
  }

  .payment-history-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .payment-history-item {
    background: #f8fafc;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #667eea;
  }

  .payment-history-date {
    font-size: 0.9rem;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 8px;
  }

  .payment-history-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 0.85rem;
    color: #4a5568;
  }

  .payment-history-detail-row {
    display: flex;
    justify-content: space-between;
  }

  .payment-history-label {
    font-weight: 600;
    color: #2d3748;
  }

  .payment-history-empty {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
  }
</style>

<!-- ê²°ì œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="payment-modal" class="payment-history-modal" onclick="closePaymentModal(event)" style="display: none;">
  <div class="payment-history-content" style="max-width: 800px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title" id="payment-modal-user-name"></h3>
      <button class="payment-history-close" onclick="closePaymentModal()">&times;</button>
    </div>

    <!-- ìˆ˜ê°• ë“±ë¡ ëª©ë¡ -->
    <div id="enrollment-list" style="margin-bottom: 20px;"></div>

    <!-- ìƒˆ ê³¼ëª© ì¶”ê°€ ë²„íŠ¼ -->
    <button onclick="addNewEnrollment()" style="margin-bottom: 20px; padding: 10px 16px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">+ ìƒˆ ê³¼ëª© ì¶”ê°€</button>

    <!-- ê²°ì œ ì •ë³´ ì„¹ì…˜ -->
    <div id="payment-section" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; background: #f8fafc;"></div>
  </div>
</div>

<!-- ìƒˆ ê³¼ëª© ì¶”ê°€ ëª¨ë‹¬ -->
<div id="add-enrollment-modal" class="payment-history-modal" onclick="closeAddEnrollmentModal(event)" style="display: none;">
  <div class="payment-history-content" style="max-width: 600px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title">ìƒˆ ê³¼ëª© ì¶”ê°€</h3>
      <button class="payment-history-close" onclick="closeAddEnrollmentModal()">&times;</button>
    </div>

    <div style="padding: 20px;">
      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ë‹´ë‹¹ ì„ ìƒë‹˜</label>
        <select id="new-enrollment-teacher" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.95rem;">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ë¬´ì„±" data-subject="í´ë¦°">ë¬´ì„± (í´ë¦°)</option>
          <option value="ì„±ê· " data-subject="í´ë¦°">ì„±ê·  (í´ë¦°)</option>
          <option value="ë…¸ë„¤ì„" data-subject="í´ë¦°">ë…¸ë„¤ì„ (í´ë¦°)</option>
          <option value="ë¡œí•œ" data-subject="í´ë¦°">ë¡œí•œ (í´ë¦°)</option>
          <option value="ë²”ì„" data-subject="í´ë¦°">ë²”ì„ (í´ë¦°)</option>
          <option value="ë‘ë°•" data-subject="í´ë¦°">ë‘ë°• (í´ë¦°)</option>
          <option value="ì˜¤ë˜" data-subject="í´ë¦°">ì˜¤ë˜ (í´ë¦°)</option>
          <option value="ì§€ëª…" data-subject="ë¯¹ì‹±">ì§€ëª… (ë¯¹ì‹±)</option>
          <option value="ë„í˜„" data-subject="ì–¸í´ë¦°">ë„í˜„ (ì–¸í´ë¦°)</option>
          <option value="ì˜¨ë¼ì¸" data-subject="í´ë¦°">ì˜¨ë¼ì¸ (í´ë¦°)</option>
        </select>
      </div>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ê³¼ëª©</label>
        <input type="text" id="new-enrollment-subject" readonly style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 0.95rem;" placeholder="ì„ ìƒë‹˜ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤">
      </div>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ì²«ìˆ˜ì—… ë‚ ì§œ</label>
        <div id="new-enrollment-calendar"></div>
        <input type="hidden" id="new-enrollment-date">
      </div>

      <div id="new-enrollment-time-section" style="margin-bottom: 24px; display: none;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ì²«ìˆ˜ì—… ì‹œê°„</label>
        <div id="new-enrollment-time-slots" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;"></div>
        <input type="hidden" id="new-enrollment-time">
      </div>

      <div id="new-enrollment-duration-section" style="margin-bottom: 24px; display: none;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ìˆ˜ê°• ê¸°ê°„</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
          <button type="button" class="duration-btn" data-months="1" data-lessons="4" onclick="selectDuration(1, 4, this)" style="padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
            <div style="font-weight: 600;">1ê°œì›”</div>
            <div style="font-size: 0.8rem; color: #6b7280;">4íšŒ</div>
          </button>
          <button type="button" class="duration-btn" data-months="3" data-lessons="12" onclick="selectDuration(3, 12, this)" style="padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
            <div style="font-weight: 600;">3ê°œì›”</div>
            <div style="font-size: 0.8rem; color: #6b7280;">12íšŒ</div>
          </button>
          <button type="button" class="duration-btn" data-months="4" data-lessons="16" onclick="selectDuration(4, 16, this)" style="padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
            <div style="font-weight: 600;">4ê°œì›” (ë¯¹ì‹±)</div>
            <div style="font-size: 0.8rem; color: #6b7280;">16íšŒ</div>
          </button>
        </div>
        <input type="hidden" id="new-enrollment-months">
        <input type="hidden" id="new-enrollment-lessons">
      </div>

      <div id="new-enrollment-summary" style="margin-bottom: 24px; display: none; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="font-weight: 600; margin-bottom: 12px; color: #2d3748;">ìˆ˜ê°• ì •ë³´ ìš”ì•½</div>
        <div style="display: grid; gap: 8px; font-size: 0.9rem;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ë‹´ë‹¹ ì„ ìƒë‹˜</span>
            <span id="summary-teacher" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ê³¼ëª©</span>
            <span id="summary-subject" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ìš”ì¼/ì‹œê°„</span>
            <span id="summary-schedule" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ì²«ìˆ˜ì—… ë‚ ì§œ</span>
            <span id="summary-first-lesson" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ì¢…ë£Œì¼</span>
            <span id="summary-end-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ë‚¨ì€ ìˆ˜ì—…</span>
            <span id="summary-lessons" style="font-weight: 600; color: #667eea;"></span>
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <button onclick="closeAddEnrollmentModal()" style="flex: 1; padding: 12px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
        <button onclick="saveNewEnrollment()" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">ì¶”ê°€</button>
      </div>
    </div>
  </div>
</div>

<!-- ê²°ì œ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
<div id="payment-history-modal" class="payment-history-modal" onclick="closePaymentHistoryModal(event)">
  <div class="payment-history-content" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title" id="payment-history-user-name"></h3>
      <button class="payment-history-close" onclick="closePaymentHistoryModal()">&times;</button>
    </div>
    <div id="payment-history-list" class="payment-history-list"></div>
  </div>
</div>

<!-- ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="enrollment-manage-modal" class="payment-history-modal" onclick="closeEnrollmentManageModal(event)">
  <div class="payment-history-content" style="max-width: 500px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title">ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬</h3>
      <button class="payment-history-close" onclick="closeEnrollmentManageModal()">&times;</button>
    </div>
    <div id="enrollment-manage-list" style="padding: 20px;"></div>
  </div>
</div>

<!-- ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ (íœ´ì› í•´ì œìš©) -->
<div id="schedule-select-modal" class="payment-history-modal" onclick="closeScheduleSelectModal(event)" style="display: none;">
  <div class="payment-history-content" style="max-width: 1100px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title">ë³µê·€í•  ì‹œê°„ëŒ€ ì„ íƒ</h3>
      <button class="payment-history-close" onclick="closeScheduleSelectModal()">&times;</button>
    </div>
    <div style="padding: 20px;">
      <!-- ì„ ìƒë‹˜ ì„ íƒ íƒ­ -->
      <div id="teacher-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;"></div>

      <!-- ìº˜ë¦°ë” -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <button onclick="changeScheduleMonth(-1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">â—€ ì´ì „</button>
          <h4 id="schedule-calendar-month" style="margin: 0; font-size: 1.1rem; font-weight: 600;"></h4>
          <button onclick="changeScheduleMonth(1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ë‹¤ìŒ â–¶</button>
        </div>
        <div id="schedule-calendar-content"></div>
      </div>

      <!-- ì„ íƒëœ ë‚ ì§œ ì •ë³´ -->
      <div id="selected-date-info" style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; display: none;">
        <p style="margin: 0; color: #0c4a6e; font-weight: 600;"></p>
      </div>

      <!-- ì‹œê°„í‘œ -->
      <div id="schedule-select-content"></div>
    </div>
  </div>
</div>

<!-- ê²°ì œì¼ íšŒì› ëª©ë¡ ëª¨ë‹¬ -->
<div id="payment-date-modal" class="payment-history-modal" onclick="closePaymentDateModal(event)">
  <div class="payment-history-content" style="max-width: 700px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title" id="payment-date-modal-title"></h3>
      <button class="payment-history-close" onclick="closePaymentDateModal()">&times;</button>
    </div>
    <div style="padding: 20px;">
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
          <input type="checkbox" id="select-all-payments" onclick="toggleAllPaymentCheckboxes()" style="width: 16px; height: 16px; cursor: pointer;">
          <span style="font-weight: 600;">ì „ì²´ì„ íƒ</span>
        </label>
        <button onclick="markSelectedAsPaid()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ì„ íƒí•­ëª© ê²°ì œì™„ë£Œ ì²˜ë¦¬</button>
      </div>
      <div id="payment-date-list" style="display: flex; flex-direction: column; gap: 15px;"></div>
    </div>
  </div>
</div>

<!-- ê²°ì œ ìº˜ë¦°ë” -->
<div style="background: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; padding: 25px; margin-bottom: 25px;">
  <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; color: #2d3748;">ê²°ì œ ìº˜ë¦°ë”</h3>

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <button onclick="changeCalendarMonth(-1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">â—€ ì´ì „</button>
    <h4 id="calendar-month-title" style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #2d3748;"></h4>
    <button onclick="changeCalendarMonth(1)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ë‹¤ìŒ â–¶</button>
  </div>

  <div id="payment-calendar-content"></div>

  <!-- ì˜¤ëŠ˜ ê²°ì œ ì˜ˆì •ì ìš”ì•½ -->
  <div id="today-payments-summary" style="margin-top: 15px; padding: 15px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; display: none;">
    <div style="font-weight: 700; font-size: 1rem; color: #d97706; margin-bottom: 8px;">ğŸ“… ì˜¤ëŠ˜ ê²°ì œ ì˜ˆì •</div>
    <div id="today-payments-list" style="font-size: 0.9rem; color: #92400e;"></div>
  </div>
</div>

<div class="payments-container">
  <div class="payments-content">
    <% if @users.empty? %>
      <div class="empty-state-payment">
        <div class="empty-state-icon-payment">ğŸ’³</div>
        <div class="empty-state-text-payment">
          <%= params[:search].present? ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.' %>
        </div>
      </div>
    <% else %>
      <table class="payments-table">
        <thead class="payments-table-header">
          <tr>
            <th>ì´ë¦„</th>
            <th>ë‹´ë‹¹ ì„ ìƒë‹˜</th>
            <th>ìƒíƒœ</th>
            <th>íœ´ì›</th>
            <th>ë§ˆì§€ë§‰ ê²°ì œì¼</th>
            <th>ì²«ìˆ˜ì—…ì¼</th>
            <th>ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼</th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody>
          <% @users.each do |user| %>
            <%
              # ì‚¬ìš©ìì˜ ê²°ì œ ì™„ë£Œëœ ë“±ë¡ ê³¼ëª©ë§Œ ê°€ì ¸ì˜¤ê¸°
              enrollments = UserEnrollment.where(user_id: user['id'], is_paid: true)
              teachers = enrollments.map(&:teacher).uniq.join(', ')
              teachers = user['teacher'] if teachers.blank?

              # ìƒíƒœ í‘œì‹œ
              status_text = case user['status']
              when 'on_leave' then 'íœ´ì›'
              when 'active', 'approved' then 'í™œì„±'
              else 'ëŒ€ê¸°'
              end

              status_color = case user['status']
              when 'on_leave' then '#f59e0b'
              when 'active', 'approved' then '#10b981'
              else '#9ca3af'
              end
            %>
            <tr class="payment-row" data-user-id="<%= user['id'] %>">
              <td>
                <span class="user-name-payment" style="cursor: pointer; text-decoration: underline; color: #667eea; font-weight: 600;" onclick="openPaymentModal(<%= user['id'] %>)">
                  <%= user['name'] %>
                </span>
              </td>
              <td><%= teachers %></td>
              <td>
                <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: <%= status_color %>20; color: <%= status_color %>;">
                  <%= status_text %>
                </span>
              </td>
              <td>
                <% if enrollments.any? %>
                  <% on_leave_subjects = enrollments.select { |e| e.status == 'on_leave' }.map(&:subject) %>

                  <button onclick="openEnrollmentModal(<%= user['id'] %>)"
                          style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                    ê³¼ëª©ë³„ ê´€ë¦¬
                  </button>

                  <% on_leave_subjects.each do |subject| %>
                    <span style="display: inline-block; margin-left: 8px; padding: 4px 8px; background: #fef3c7; color: #f59e0b; border: 1px solid #fbbf24; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                      <%= subject %>
                    </span>
                  <% end %>

                  <!-- ëª¨ë‹¬ìš© ë°ì´í„° ì €ì¥ -->
                  <div id="enrollment-data-<%= user['id'] %>" style="display: none;">
                    <% enrollments.each do |enrollment| %>
                      <div class="enrollment-item"
                           data-id="<%= enrollment.id %>"
                           data-subject="<%= enrollment.subject %>"
                           data-teacher="<%= enrollment.teacher %>"
                           data-day="<%= enrollment.day_korean %>"
                           data-time="<%= enrollment.time_slot %>"
                           data-status="<%= enrollment.status %>">
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <span style="color: #9ca3af;">-</span>
                <% end %>
              </td>
              <td>
                <% if user['last_payment_date'].present? %>
                  <% payment_date = user['last_payment_date'].is_a?(Date) ? user['last_payment_date'] : Date.parse(user['last_payment_date']) %>
                  <% days_ago = (Date.current - payment_date).to_i %>
                  <% is_overdue = days_ago > 30 %>
                  <span class="payment-date <%= is_overdue ? 'overdue' : '' %>">
                    <%= payment_date.strftime('%Y.%m.%d') %>
                    <% if is_overdue %>
                      <span style="font-size: 0.8rem; color: #ef4444;">(<%= days_ago %>ì¼ ì „)</span>
                    <% end %>
                  </span>
                <% else %>
                  <span class="payment-date none">-</span>
                <% end %>
              </td>
              <td>
                <%
                  # ì²«ìˆ˜ì—…ì¼ (ê°€ì¥ ë¹ ë¥¸ ê²ƒ)
                  first_lesson_dates = enrollments.map(&:first_lesson_date).compact
                  earliest_first_lesson = first_lesson_dates.min
                %>
                <% if earliest_first_lesson.present? %>
                  <span class="payment-date">
                    <%= earliest_first_lesson.strftime('%Y.%m.%d') %>
                  </span>
                <% else %>
                  <span class="payment-date none">-</span>
                <% end %>
              </td>
              <td>
                <%
                  # í™œì„± ê³¼ëª©ê³¼ íœ´ì› ê³¼ëª© ë¶„ë¦¬
                  active_enrollments = enrollments.select { |e| e.status == 'active' }
                  all_on_leave = enrollments.all? { |e| e.status == 'on_leave' }

                  # í™œì„± ê³¼ëª©ì˜ ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼ë§Œ ê³„ì‚°
                  active_next_payment_dates = active_enrollments.map { |e| e.next_payment_date }.compact
                  earliest_next_payment = active_next_payment_dates.min
                %>
                <% if all_on_leave && enrollments.any? %>
                  <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #f59e0b20; color: #f59e0b;">
                    íœ´ì›
                  </span>
                <% elsif earliest_next_payment.present? %>
                  <% days_until = (earliest_next_payment - Date.current).to_i %>
                  <% is_soon = days_until <= 7 && days_until >= 0 %>
                  <% is_today = days_until == 0 %>
                  <% is_overdue = days_until < 0 %>
                  <span class="payment-date <%= is_overdue ? 'overdue' : '' %>" style="<%= is_today ? 'background: #fef3c7; padding: 4px 8px; border-radius: 4px; font-weight: 700; color: #d97706;' : is_soon ? 'color: #f59e0b; font-weight: 600;' : '' %>">
                    <%= earliest_next_payment.strftime('%Y.%m.%d') %>
                    <% if is_today %>
                      <span style="font-size: 0.8rem;">(ì˜¤ëŠ˜)</span>
                    <% elsif is_soon && !is_overdue %>
                      <span style="font-size: 0.8rem;">(D-<%= days_until %>)</span>
                    <% elsif is_overdue %>
                      <span style="font-size: 0.8rem; color: #ef4444;">(+<%= -days_until %>ì¼)</span>
                    <% end %>
                  </span>
                <% else %>
                  <span class="payment-date none">-</span>
                <% end %>
              </td>
              <td>
                <button onclick="showPaymentHistory(<%= user['id'] %>)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                  ê²°ì œ ë‚´ì—­ ë³´ê¸°
                </button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <% if @total_pages > 1 %>
        <div class="pagination-container">
          <button class="pagination-btn" onclick="loadPaymentsTab(<%= [@page - 1, 1].max %>)" <%= 'disabled' if @page == 1 %>>
            ì´ì „
          </button>

          <% start_page = [@page - 2, 1].max %>
          <% end_page = [start_page + 4, @total_pages].min %>
          <% start_page = [end_page - 4, 1].max if end_page - start_page < 4 %>

          <% (start_page..end_page).each do |page_num| %>
            <button class="pagination-btn <%= 'active' if page_num == @page %>" onclick="loadPaymentsTab(<%= page_num %>)">
              <%= page_num %>
            </button>
          <% end %>

          <button class="pagination-btn" onclick="loadPaymentsTab(<%= [@page + 1, @total_pages].min %>)" <%= 'disabled' if @page == @total_pages %>>
            ë‹¤ìŒ
          </button>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
(function() {
  // ê³¼ëª©ë³„ ê°€ê²© ì •ë³´
  const SUBJECT_PRICES = {
    'í´ë¦°': { 1: 370000, 3: 950000 },
    'ì–¸í´ë¦°': { 1: 370000, 3: 950000 },
    'ë¯¹ì‹±': { 1: 280000, 4: 990000 },
    'ì‘ê³¡': { 1: 350000, 3: 950000 },
    'ê¸°íƒ€': { 1: 300000, 3: 770000 }
  };

  // í• ì¸ ì •ë³´
  const DISCOUNTS = {
    'text_review': 30000,
    'video_review': 30000,
    'referral': 50000,
    'bundle_2': 50000,
    'bundle_3': 100000
  };

  // ì„ ìƒë‹˜ íœ´ë¬´ì¼ ë°ì´í„°
  const TEACHER_HOLIDAYS = <%= raw @teacher_holidays.to_json %>;

  let currentUserId = null;
  let currentUserName = null;
  let enrollments = []; // ì¶”ê°€í•  ê³¼ëª© ëª©ë¡
  let selectedTeacher = null; // í˜„ì¬ ì„ íƒëœ ì„ ìƒë‹˜

  // ê²°ì œ ëª¨ë‹¬ ì—´ê¸°
  window.openPaymentModal = function(userId) {
    // ë‹¤ë¥¸ ëª¨ë‹¬ë“¤ ë¨¼ì € ë‹«ê¸°
    closePaymentDateModal();

    fetch(`/admin/users/${userId}`)
      .then(response => response.json())
      .then(data => {
        currentUserId = userId;
        currentUserName = data.name;
        enrollments = [];

        // ì—°ì¥ ëª¨ë“œ í”Œë˜ê·¸ ì´ˆê¸°í™” (ì‹ ê·œ ë“±ë¡ ëª¨ë“œ)
        window.extendingEnrollmentId = null;
        window.extendingUserId = null;

        document.getElementById('payment-modal-user-name').textContent = data.name + ' - ê²°ì œ ë“±ë¡';
        document.getElementById('enrollment-list').innerHTML = '';
        document.getElementById('payment-section').innerHTML = '';
        document.getElementById('payment-modal').style.display = 'flex';
      })
      .catch(error => {
        console.error('Error:', error);
        alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  };

  // ê²°ì œ ëª¨ë‹¬ ë‹«ê¸°
  window.closePaymentModal = function(event) {
    if (!event || event.target.id === 'payment-modal') {
      document.getElementById('payment-modal').style.display = 'none';
      enrollments = [];
    }
  };

  // ìƒˆ ê³¼ëª© ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
  window.addNewEnrollment = function() {
    document.getElementById('add-enrollment-modal').style.display = 'flex';
    initializeEnrollmentForm();
  };

  // ìƒˆ ê³¼ëª© ì¶”ê°€ ëª¨ë‹¬ ë‹«ê¸°
  window.closeAddEnrollmentModal = function(event) {
    if (!event || event.target.id === 'add-enrollment-modal') {
      document.getElementById('add-enrollment-modal').style.display = 'none';
    }
  };

  // ê³¼ëª© ì¶”ê°€ í¼ ì´ˆê¸°í™”
  function initializeEnrollmentForm() {
    // ì„ ìƒë‹˜ ì„ íƒ ì‹œ ê³¼ëª© ìë™ ì…ë ¥
    document.getElementById('new-enrollment-teacher').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const subject = selectedOption.getAttribute('data-subject');
      selectedTeacher = this.value; // ì„ íƒëœ ì„ ìƒë‹˜ ì €ì¥
      document.getElementById('new-enrollment-subject').value = subject || '';

      if (subject) {
        showCalendar();
      }
    });

    // í¼ ë¦¬ì…‹
    document.getElementById('new-enrollment-teacher').value = '';
    document.getElementById('new-enrollment-subject').value = '';
    document.getElementById('new-enrollment-date').value = '';
    document.getElementById('new-enrollment-time').value = '';
    document.getElementById('new-enrollment-months').value = '';
    document.getElementById('new-enrollment-lessons').value = '';
    document.getElementById('new-enrollment-time-section').style.display = 'none';
    document.getElementById('new-enrollment-duration-section').style.display = 'none';
    document.getElementById('new-enrollment-summary').style.display = 'none';
  }

  // ë‹¬ë ¥ í‘œì‹œ
  function showCalendar() {
    const calendarDiv = document.getElementById('new-enrollment-calendar');
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();

    // ì„ íƒëœ ì„ ìƒë‹˜ì˜ íœ´ë¬´ì¼ ê°€ì ¸ì˜¤ê¸° (0=ì¼, 1=ì›”, 2=í™”, 3=ìˆ˜, 4=ëª©, 5=ê¸ˆ, 6=í† )
    const teacherHolidays = selectedTeacher ? (TEACHER_HOLIDAYS[selectedTeacher] || []) : [];

    let html = '<div style="text-align: center; margin-bottom: 10px; font-weight: 600;">';
    html += year + 'ë…„ ' + (month + 1) + 'ì›”</div>';
    html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">';

    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    dayNames.forEach(day => {
      html += '<div style="text-align: center; font-weight: 600; padding: 8px; font-size: 0.85rem;">' + day + '</div>';
    });

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      html += '<div></div>';
    }

    for (let date = 1; date <= lastDate; date++) {
      const fullDate = new Date(year, month, date);
      const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(date).padStart(2, '0');
      const dayOfWeek = fullDate.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 
      const isHoliday = teacherHolidays.includes(dayOfWeek);

      let style = 'text-align: center; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;';

      if (isHoliday) {
        // íœ´ë¬´ì¼ì€ ì„ íƒ ë¶ˆê°€
        style += ' opacity: 0.5; pointer-events: none; cursor: not-allowed;';
        style += ' background: #fef3c7;'; // ì—°ë…¸ë‘
      } else {
        style += ' cursor: pointer;';
      }

      const onclick = isHoliday ? '' : 'onclick="selectDate(\'' + dateStr + '\')"';

      html += '<div ' + onclick + ' style="' + style + '" data-date="' + dateStr + '">' + date + '</div>';
    }

    html += '</div>';
    calendarDiv.innerHTML = html;
  }

  // ë‚ ì§œ ì„ íƒ
  window.selectDate = function(dateStr) {
    document.getElementById('new-enrollment-date').value = dateStr;

    // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
    document.querySelectorAll('[data-date]').forEach(el => {
      el.style.background = '';
      el.style.color = '';
    });
    document.querySelector('[data-date="' + dateStr + '"]').style.background = '#667eea';
    document.querySelector('[data-date="' + dateStr + '"]').style.color = 'white';

    showTimeSlots(dateStr);
  };

  // ì‹œê°„ëŒ€ í‘œì‹œ
  function showTimeSlots(dateStr) {
    const parts = dateStr.split('-');
    const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    const dayOfWeek = date.getDay();
    const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const dayKey = dayKeys[dayOfWeek];

    document.getElementById('new-enrollment-time-section').style.display = 'block';

    // ë¡œë”© í‘œì‹œ
    document.getElementById('new-enrollment-time-slots').innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

    // ì„ íƒëœ ë‚ ì§œê°€ ì†í•œ ì£¼ì˜ week_offset ê³„ì‚°
    const selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    const today = new Date();
    const todaySunday = new Date(today);
    todaySunday.setDate(today.getDate() - today.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼
    const selectedSunday = new Date(selectedDate);
    selectedSunday.setDate(selectedDate.getDate() - selectedDate.getDay()); // ì„ íƒëœ ë‚ ì§œì˜ ì¼ìš”ì¼

    const weekOffset = Math.round((selectedSunday - todaySunday) / (7 * 24 * 60 * 60 * 1000));

    // íœ´ì› ë³µê·€ì™€ ë™ì¼í•œ API ì‚¬ìš© (ì£¼ ë‹¨ìœ„ ì‹œê°„í‘œ)
    fetch(`/admin/load_schedule?teacher=${encodeURIComponent(selectedTeacher)}&week_offset=${weekOffset}&mode=manager`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const scheduleData = data.schedules[dayKey] || {};
          const timeSlots = ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'];
          let html = '';

          timeSlots.forEach(slot => {
            const students = scheduleData[slot] || [];
            const currentCount = students.length;
            const isFull = currentCount >= 3;

            let btnStyle = 'padding: 20px; border-radius: 8px; text-align: center; border: 2px solid; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px;';
            let bgColor, borderColor, textColor, cursor;

            if (isFull) {
              bgColor = '#fee2e2'; // ì—°ë¶‰ì€ìƒ‰ (ê½‰ ì°¸ - ì„ íƒ ë¶ˆê°€)
              borderColor = '#fecaca';
              textColor = '#dc2626';
              cursor = 'not-allowed';
            } else {
              bgColor = '#dbeafe'; // ì—°íŒŒë‘ (ì„ íƒ ê°€ëŠ¥)
              borderColor = '#93c5fd';
              textColor = '#1e40af';
              cursor = 'pointer';
            }

            btnStyle += ` background: ${bgColor}; border-color: ${borderColor}; color: ${textColor}; cursor: ${cursor};`;

            if (isFull) {
              // 3ëª… ì´ìƒì´ë©´ í´ë¦­ ë¶ˆê°€
              html += '<button type="button" class="time-slot-btn" data-time="' + slot + '" style="' + btnStyle + '" disabled>';
            } else {
              html += '<button type="button" onclick="selectTime(\'' + slot + '\')" class="time-slot-btn" data-time="' + slot + '" style="' + btnStyle + '">';
            }

            html += '<div style="font-size: 1.1rem; font-weight: 600;">' + slot.replace('-', ':00-') + ':00</div>';
            html += '<div style="font-size: 0.9rem;">' + currentCount + '/3</div>';

            if (!isFull) {
              html += '<div style="font-size: 0.8rem; color: #10b981;">ì„ íƒ ê°€ëŠ¥</div>';
            } else {
              html += '<div style="font-size: 0.8rem;">ìë¦¬ ì—†ìŒ</div>';
            }

            html += '</button>';
          });

          document.getElementById('new-enrollment-time-slots').innerHTML = html;
        } else {
          document.getElementById('new-enrollment-time-slots').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('new-enrollment-time-slots').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      });
  }

  // ì‹œê°„ ì„ íƒ
  window.selectTime = function(timeSlot) {
    document.getElementById('new-enrollment-time').value = timeSlot;

    // ì„ íƒëœ ì‹œê°„ í‘œì‹œ
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
      // ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µì› (data-time ì†ì„± ê¸°ë°˜ìœ¼ë¡œ ë³µì›ì€ ë³µì¡í•˜ë¯€ë¡œ, ì„ íƒëœ ê²ƒë§Œ ë³€ê²½)
      btn.style.opacity = '0.7';
      btn.style.transform = 'scale(0.95)';
    });
    const selectedBtn = document.querySelector('[data-time="' + timeSlot + '"]');
    selectedBtn.style.opacity = '1';
    selectedBtn.style.transform = 'scale(1.05)';
    selectedBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';

    showDurationOptions();
  };

  // ìˆ˜ê°• ê¸°ê°„ ì˜µì…˜ í‘œì‹œ
  function showDurationOptions() {
    const subject = document.getElementById('new-enrollment-subject').value;
    document.getElementById('new-enrollment-duration-section').style.display = 'block';

    // ê³¼ëª©ì— ë”°ë¼ ê°€ëŠ¥í•œ ê¸°ê°„ë§Œ í™œì„±í™”
    const availableMonths = Object.keys(SUBJECT_PRICES[subject] || {});
    document.querySelectorAll('.duration-btn').forEach(btn => {
      const months = btn.getAttribute('data-months');
      if (availableMonths.includes(months)) {
        btn.disabled = false;
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.3';
      }
    });
  }

  // ìˆ˜ê°• ê¸°ê°„ ì„ íƒ
  window.selectDuration = function(months, lessons, element) {
    document.getElementById('new-enrollment-months').value = months;
    document.getElementById('new-enrollment-lessons').value = lessons;

    // ì„ íƒëœ ê¸°ê°„ í‘œì‹œ
    document.querySelectorAll('.duration-btn').forEach(btn => {
      btn.style.borderColor = '#e2e8f0';
      btn.style.background = 'white';
    });
    element.style.borderColor = '#667eea';
    element.style.background = '#f0f4ff';

    updateSummary();
  };

  // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateSummary() {
    const teacher = document.getElementById('new-enrollment-teacher').value;
    const subject = document.getElementById('new-enrollment-subject').value;
    const dateStr = document.getElementById('new-enrollment-date').value;
    const timeSlot = document.getElementById('new-enrollment-time').value;
    const months = parseInt(document.getElementById('new-enrollment-months').value);
    const lessons = parseInt(document.getElementById('new-enrollment-lessons').value);

    if (!teacher || !subject || !dateStr || !timeSlot || !months) return;

    const parts = dateStr.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const day = parseInt(parts[2]);
    const date = new Date(year, month, day);
    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];

    // ì¢…ë£Œì¼ ê³„ì‚°
    const endDate = new Date(year, month + months, day);
    const endDateStr = endDate.getFullYear() + '-' +
                       String(endDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(endDate.getDate()).padStart(2, '0');

    document.getElementById('summary-teacher').textContent = teacher;
    document.getElementById('summary-subject').textContent = subject;
    document.getElementById('summary-schedule').textContent = dayOfWeek + 'ìš”ì¼ ' + timeSlot.replace('-', ':00-') + ':00';
    document.getElementById('summary-first-lesson').textContent = dateStr;
    document.getElementById('summary-end-date').textContent = endDateStr;
    document.getElementById('summary-lessons').textContent = lessons + 'íšŒ';

    document.getElementById('new-enrollment-summary').style.display = 'block';
  }

  // ìƒˆ ê³¼ëª© ì €ì¥
  window.saveNewEnrollment = function() {
    const teacher = document.getElementById('new-enrollment-teacher').value;
    const subject = document.getElementById('new-enrollment-subject').value;
    const dateStr = document.getElementById('new-enrollment-date').value;
    const timeSlot = document.getElementById('new-enrollment-time').value;
    const months = parseInt(document.getElementById('new-enrollment-months').value);
    const lessons = parseInt(document.getElementById('new-enrollment-lessons').value);

    if (!teacher || !subject || !dateStr || !timeSlot || !months) {
      alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const parts = dateStr.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const day = parseInt(parts[2]);
    const date = new Date(year, month, day);
    const dayOfWeek = date.getDay(); // 0=ì¼, 1=ì›”, ...

    // ì¢…ë£Œì¼ ê³„ì‚°
    const endDate = new Date(year, month + months, day);
    const endDateStr = endDate.getFullYear() + '-' +
                       String(endDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(endDate.getDate()).padStart(2, '0');

    enrollments.push({
      teacher: teacher,
      subject: subject,
      first_lesson_date: dateStr,
      time_slot: timeSlot,
      day_of_week: dayOfWeek,
      months: months,
      lessons: lessons,
      end_date: endDateStr,
      price: SUBJECT_PRICES[subject][months]
    });

    closeAddEnrollmentModal();
    updateEnrollmentList();
    updatePaymentSection();
  };

  // ë“±ë¡ ê³¼ëª© ëª©ë¡ ì—…ë°ì´íŠ¸
  function updateEnrollmentList() {
    const listDiv = document.getElementById('enrollment-list');
    if (enrollments.length === 0) {
      listDiv.innerHTML = '';
      return;
    }

    let html = '<div style="margin-bottom: 20px;"><h4 style="font-weight: 600; margin-bottom: 10px;">ë“±ë¡í•  ê³¼ëª©</h4>';
    enrollments.forEach((enroll, index) => {
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
      html += '<div>';
      html += '<div style="font-weight: 600; margin-bottom: 5px;">' + enroll.subject + ' - ' + enroll.teacher + '</div>';
      html += '<div style="font-size: 0.85rem; color: #6b7280;">' + dayNames[enroll.day_of_week] + 'ìš”ì¼ ' + enroll.time_slot.replace('-', ':00-') + ':00</div>';
      html += '<div style="font-size: 0.85rem; color: #6b7280;">ì²«ìˆ˜ì—…: ' + enroll.first_lesson_date + ' | ì¢…ë£Œ: ' + enroll.end_date + '</div>';
      html += '<div style="font-size: 0.85rem; color: #667eea; font-weight: 600; margin-top: 5px;">' + enroll.price.toLocaleString() + 'ì› (' + enroll.months + 'ê°œì›”/' + enroll.lessons + 'íšŒ)</div>';
      html += '</div>';
      html += '<button onclick="removeEnrollment(' + index + ')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">ì‚­ì œ</button>';
      html += '</div></div>';
    });
    html += '</div>';

    listDiv.innerHTML = html;
  }

  // ê³¼ëª© ì‚­ì œ
  window.removeEnrollment = function(index) {
    enrollments.splice(index, 1);
    updateEnrollmentList();
    updatePaymentSection();
  };

  // ê²°ì œ ì„¹ì…˜ ì—…ë°ì´íŠ¸
  function updatePaymentSection() {
    if (enrollments.length === 0) {
      document.getElementById('payment-section').innerHTML = '';
      return;
    }

    const totalPrice = enrollments.reduce((sum, e) => sum + e.price, 0);

    let html = '<h4 style="font-weight: 600; margin-bottom: 15px;">ê²°ì œ ì •ë³´</h4>';

    // í• ì¸ ì„ íƒ
    html += '<div style="margin-bottom: 20px;">';
    html += '<div style="font-weight: 600; margin-bottom: 10px;">í• ì¸ ì ìš©</div>';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
    html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="text_review" value="30000"> ê¸€ í›„ê¸° (-3ë§Œì›)</label>';
    html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="video_review" value="30000"> ì˜ìƒ í›„ê¸° (-3ë§Œì›)</label>';
    html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="referral" value="50000"> ì¹œêµ¬ ì¶”ì²œ (-5ë§Œì›)</label>';
    if (enrollments.length >= 2) {
      html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="bundle_2" value="50000"> 2ê³¼ëª© ë¬¶ìŒ (-5ë§Œì›)</label>';
    }
    if (enrollments.length >= 3) {
      html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="bundle_3" value="100000"> 3ê³¼ëª© ë¬¶ìŒ (-10ë§Œì›)</label>';
    }
    html += '</div></div>';

    // ê²°ì œì¼ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
    const today = new Date();
    const koreaOffset = 9 * 60; // UTC+9
    const koreaTime = new Date(today.getTime() + (koreaOffset * 60 * 1000));
    const todayStr = koreaTime.toISOString().split('T')[0];

    html += '<div style="margin-bottom: 20px;">';
    html += '<label style="display: block; font-weight: 600; margin-bottom: 8px;">ê²°ì œì¼</label>';
    html += '<input type="date" id="payment-date" value="' + todayStr + '" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">';
    html += '</div>';

    // ê¸ˆì•¡ ìš”ì•½
    html += '<div id="payment-summary" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">';
    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>ê¸°ë³¸ ê¸ˆì•¡</span><span id="base-price">' + totalPrice.toLocaleString() + 'ì›</span></div>';
    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #ef4444;"><span>í• ì¸</span><span id="discount-price">0ì›</span></div>';
    html += '<div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.1rem; padding-top: 10px; border-top: 2px solid #e2e8f0;"><span>ìµœì¢… ê¸ˆì•¡</span><span id="final-price" style="color: #667eea;">' + totalPrice.toLocaleString() + 'ì›</span></div>';
    html += '</div>';

    // ê²°ì œ ë²„íŠ¼
    html += '<button onclick="processPayment()" style="width: 100%; margin-top: 20px; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">ê²°ì œ ì™„ë£Œ</button>';

    document.getElementById('payment-section').innerHTML = html;

    // í• ì¸ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.querySelectorAll('.discount-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', calculateFinalPrice);
    });
  }

  // ìµœì¢… ê¸ˆì•¡ ê³„ì‚°
  function calculateFinalPrice() {
    const totalPrice = enrollments.reduce((sum, e) => sum + e.price, 0);
    let totalDiscount = 0;

    document.querySelectorAll('.discount-checkbox:checked').forEach(checkbox => {
      totalDiscount += parseInt(checkbox.value);
    });

    const finalPrice = Math.max(0, totalPrice - totalDiscount);

    document.getElementById('base-price').textContent = totalPrice.toLocaleString() + 'ì›';
    document.getElementById('discount-price').textContent = '-' + totalDiscount.toLocaleString() + 'ì›';
    document.getElementById('final-price').textContent = finalPrice.toLocaleString() + 'ì›';
  }

  // ê²°ì œ ì²˜ë¦¬
  window.processPayment = function() {
    if (enrollments.length === 0) {
      alert('ë“±ë¡í•  ê³¼ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
      return;
    }

    const paymentDate = document.getElementById('payment-date').value;
    if (!paymentDate) {
      alert('ê²°ì œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // í• ì¸ ì •ë³´ ìˆ˜ì§‘
    const selectedDiscounts = [];
    document.querySelectorAll('.discount-checkbox:checked').forEach(checkbox => {
      selectedDiscounts.push(checkbox.getAttribute('data-discount'));
    });

    const totalPrice = enrollments.reduce((sum, e) => sum + e.price, 0);
    let totalDiscount = 0;
    selectedDiscounts.forEach(discountKey => {
      totalDiscount += DISCOUNTS[discountKey];
    });
    const finalPrice = Math.max(0, totalPrice - totalDiscount);

    // ì„œë²„ì— ì „ì†¡
    const paymentData = {
      user_id: currentUserId,
      enrollments: enrollments,
      payment_date: paymentDate,
      discounts: selectedDiscounts,
      total_price: totalPrice,
      discount_amount: totalDiscount,
      final_price: finalPrice
    };

    // ì—°ì¥ ëª¨ë“œì¼ ê²½ìš° enrollment_id ì¶”ê°€
    if (window.extendingEnrollmentId) {
      paymentData.extending_enrollment_id = window.extendingEnrollmentId;
    }

    fetch('/admin/process_payment', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

        // ì—°ì¥ ëª¨ë“œ í”Œë˜ê·¸ ì´ˆê¸°í™”
        window.extendingEnrollmentId = null;
        window.extendingUserId = null;

        closePaymentModal();
        window.loadPaymentsTab(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        alert('ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  };

  // ê²°ì œ ì´ë ¥ ë³´ê¸°
  window.showPaymentHistory = function(userId) {
    fetch(`/admin/payment_history/${userId}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('payment-history-user-name').textContent = data.user_name + ' - ê²°ì œ ì •ë³´';

        const listDiv = document.getElementById('payment-history-list');
        let html = '';

        // í™œì„± ê³¼ëª© ì„¹ì…˜
        if (data.enrollments && data.enrollments.length > 0) {
          html += '<div style="margin-bottom: 30px;">';
          html += '<h4 style="font-size: 1rem; font-weight: 700; color: #2d3748; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">ğŸ“š í™œì„± ê³¼ëª©</h4>';

          data.enrollments.forEach(enrollment => {
            const statusBadge = enrollment.status === 'on_leave'
              ? '<span style="display: inline-block; padding: 4px 8px; background: #fef3c7; color: #f59e0b; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">íœ´ì›</span>'
              : '<span style="display: inline-block; padding: 4px 8px; background: #d1fae5; color: #10b981; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">í™œì„±</span>';

            html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">';
            html += '<div style="font-weight: 700; font-size: 1rem; color: #2d3748;">' + enrollment.subject + ' (' + enrollment.teacher + ') ' + statusBadge + '</div>';
            html += '</div>';
            html += '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">ğŸ“… ' + enrollment.day + ' ' + enrollment.time_slot + '</div>';
            html += '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 5px;">ğŸ“– ë‚¨ì€ ìˆ˜ì—…: ' + enrollment.remaining_lessons + 'íšŒ</div>';
            if (enrollment.next_payment_date) {
              html += '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 10px;">ğŸ’³ ë‹¤ìŒ ê²°ì œì¼: ' + enrollment.next_payment_date + '</div>';
            }
            html += '<button onclick="extendEnrollment(' + enrollment.id + ', ' + userId + ')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">ì—°ì¥í•˜ê¸°</button>';
            html += '</div>';
          });
          html += '</div>';
        }

        // ê²°ì œ ì´ë ¥ ì„¹ì…˜
        html += '<div>';
        html += '<h4 style="font-size: 1rem; font-weight: 700; color: #2d3748; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">ğŸ“‹ ê²°ì œ ì´ë ¥</h4>';

        if (data.payments.length === 0) {
          html += '<div class="payment-history-empty">ê²°ì œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          data.payments.forEach(payment => {
            html += '<div class="payment-history-item">';
            html += '<div class="payment-history-date">' + payment.payment_date + '</div>';
            html += '<div class="payment-history-details">';
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ê³¼ëª©</span><span>' + payment.subject + '</span></div>';
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ì„ ìƒë‹˜</span><span>' + payment.teacher + '</span></div>';
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ê¸°ê°„</span><span>' + payment.months + 'ê°œì›” (' + payment.lessons + 'íšŒ)</span></div>';
            if (payment.first_lesson_date && payment.first_lesson_time) {
              html += '<div class="payment-history-detail-row"><span class="payment-history-label">ì²«ìˆ˜ì—…</span><span>' + payment.first_lesson_date + ' ' + payment.first_lesson_time + '</span></div>';
            }
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ê¸ˆì•¡</span><span>' + payment.amount.toLocaleString() + 'ì›</span></div>';
            if (payment.discount_amount > 0) {
              html += '<div class="payment-history-detail-row"><span class="payment-history-label">í• ì¸</span><span style="color: #ef4444;">-' + payment.discount_amount.toLocaleString() + 'ì›</span></div>';
            }
            html += '</div></div>';
          });
        }
        html += '</div>';

        listDiv.innerHTML = html;
        document.getElementById('payment-history-modal').style.display = 'flex';
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  };

  // ê²°ì œ ì´ë ¥ ëª¨ë‹¬ ë‹«ê¸°
  window.closePaymentHistoryModal = function(event) {
    if (!event || event.target.id === 'payment-history-modal') {
      document.getElementById('payment-history-modal').style.display = 'none';
    }
  };

  // ê³¼ëª© ì—°ì¥í•˜ê¸° (ê¸°ì¡´ enrollment ì—°ì¥)
  window.extendEnrollment = function(enrollmentId, userId) {
    // ë‹¤ë¥¸ ëª¨ë‹¬ë“¤ ë‹«ê¸°
    closePaymentHistoryModal();
    closePaymentDateModal();

    // enrollment ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetch(`/admin/enrollment_info/${enrollmentId}`)
      .then(response => response.json())
      .then(enrollment => {
        // ê²°ì œ ëª¨ë‹¬ ì—´ê¸° (ì—°ì¥ ëª¨ë“œë¡œ)
        currentUserId = userId;
        enrollments = [];

        document.getElementById('payment-modal').style.display = 'flex';
        document.getElementById('payment-modal-user-name').textContent = enrollment.subject + ' ì—°ì¥í•˜ê¸°';

        // ì—°ì¥ ëª¨ë“œ í”Œë˜ê·¸ ì„¤ì •
        window.extendingEnrollmentId = enrollmentId;
        window.extendingUserId = userId;

        // ê¸°ê°„/íšŸìˆ˜ ì„ íƒ UIë¥¼ ì§ì ‘ í‘œì‹œ
        const enrollmentListDiv = document.getElementById('enrollment-list');
        enrollmentListDiv.innerHTML = `
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="font-size: 1rem; font-weight: 700; color: #2d3748; margin-bottom: 15px;">ğŸ“š ì—°ì¥ ì •ë³´</h4>
            <div style="margin-bottom: 10px; color: #6b7280;">ê³¼ëª©: ${enrollment.subject}</div>
            <div style="margin-bottom: 10px; color: #6b7280;">ì„ ìƒë‹˜: ${enrollment.teacher}</div>
            <div style="margin-bottom: 10px; color: #6b7280;">ì‹œê°„: ${enrollment.day} ${enrollment.time_slot}</div>
            <div style="margin-bottom: 20px; color: #6b7280;">í˜„ì¬ ë‚¨ì€ ìˆ˜ì—…: ${enrollment.remaining_lessons}íšŒ</div>

            <h4 style="font-size: 0.95rem; font-weight: 700; color: #2d3748; margin-bottom: 10px;">ì—°ì¥ ê¸°ê°„ ì„ íƒ</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <button onclick="selectExtensionDuration(1, 4, ${enrollment.subject}, ${enrollment.teacher})" style="padding: 15px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e5e7eb'">
                <div style="font-weight: 700; font-size: 1.1rem; color: #2d3748;">1ê°œì›”</div>
                <div style="font-size: 0.85rem; color: #6b7280;">4íšŒ ìˆ˜ì—…</div>
              </button>
              <button onclick="selectExtensionDuration(3, 12, '${enrollment.subject}', '${enrollment.teacher}')" style="padding: 15px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e5e7eb'">
                <div style="font-weight: 700; font-size: 1.1rem; color: #2d3748;">3ê°œì›”</div>
                <div style="font-size: 0.85rem; color: #6b7280;">12íšŒ ìˆ˜ì—…</div>
              </button>
            </div>
          </div>
        `;

        // ê²°ì œ ì„¹ì…˜ í‘œì‹œ
        updatePaymentSection();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ê³¼ëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  };

  // ì—°ì¥ ê¸°ê°„ ì„ íƒ
  window.selectExtensionDuration = function(months, lessons, subject, teacher) {
    const price = months === 1 ? 200000 : 600000;

    enrollments = [{
      subject: subject,
      teacher: teacher,
      months: months,
      lessons: lessons,
      price: price,
      day_of_week: null, // ì—°ì¥ ì‹œì—ëŠ” ë¶ˆí•„ìš”
      time_slot: null,
      first_lesson_date: null,
      end_date: null
    }];

    updateEnrollmentList();
    updatePaymentSection();
  };

  // ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
  window.openEnrollmentModal = function(userId) {
    const enrollmentData = document.getElementById('enrollment-data-' + userId);
    if (!enrollmentData) return;

    const items = enrollmentData.querySelectorAll('.enrollment-item');
    let html = '';

    items.forEach(item => {
      const id = item.getAttribute('data-id');
      const subject = item.getAttribute('data-subject');
      const teacher = item.getAttribute('data-teacher');
      const day = item.getAttribute('data-day');
      const time = item.getAttribute('data-time');
      const status = item.getAttribute('data-status');

      html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0;">';
      html += '<div style="font-weight: 600; margin-bottom: 8px;">' + subject + ' - ' + teacher + '</div>';
      html += '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 10px;">' + day + ' ' + time + '</div>';
      html += '<button onclick="toggleEnrollmentStatus(' + id + ', \'' + status + '\', \'' + teacher + '\')" style="padding: 8px 16px; background: ' + (status === 'on_leave' ? '#f59e0b' : '#10b981') + '; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">';
      html += (status === 'on_leave' ? 'íœ´ì› í•´ì œ' : 'íœ´ì› ì²˜ë¦¬') + '</button>';
      html += '</div>';
    });

    document.getElementById('enrollment-manage-list').innerHTML = html;
    document.getElementById('enrollment-manage-modal').style.display = 'flex';
  };

  // ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
  window.closeEnrollmentManageModal = function(event) {
    if (!event || event.target.id === 'enrollment-manage-modal') {
      document.getElementById('enrollment-manage-modal').style.display = 'none';
    }
  };

  // ê³¼ëª©ë³„ íœ´ì› ìƒíƒœ í† ê¸€
  window.toggleEnrollmentStatus = function(enrollmentId, currentStatus, teacher) {
    const newStatus = currentStatus === 'on_leave' ? 'active' : 'on_leave';

    // íœ´ì› í•´ì œ ì‹œ ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
    if (currentStatus === 'on_leave') {
      window.showScheduleSelectModal(enrollmentId, teacher);
    } else {
      // íœ´ì› ì²˜ë¦¬ (ê·¸ëƒ¥ ìƒíƒœë§Œ ë³€ê²½)
      fetch(`/admin/user_enrollments/${enrollmentId}/toggle_status`, {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('íœ´ì› ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeEnrollmentManageModal();
          window.loadPaymentsTab();
        } else {
          alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }
  };

  // ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ (íœ´ì› í•´ì œìš©)
  window.showScheduleSelectModal = function(enrollmentId, teacher) {
    window.currentEnrollmentId = enrollmentId;

    window.scheduleModalData = {
      currentTeacher: teacher,
      teachers: <%= raw @teachers.to_json %>,
      teacherHolidays: <%= raw @teacher_holidays.to_json %>,
      selectedDate: null,
      selectedWeekOffset: 0,
      availabilityData: {},
      scheduleData: {}
    };

    // ì„ ìƒë‹˜ íƒ­ ë Œë”ë§
    renderTeacherTabs();

    // ìº˜ë¦°ë” ë Œë”ë§ (í˜„ì¬ ì£¼)
    loadScheduleAndRenderCalendar(0);

    document.getElementById('schedule-select-modal').style.display = 'flex';
  };

  // ì„ ìƒë‹˜ íƒ­ ë Œë”ë§
  function renderTeacherTabs() {
    const tabsContainer = document.getElementById('teacher-tabs');
    const teachers = window.scheduleModalData.teachers;
    const currentTeacher = window.scheduleModalData.currentTeacher;

    let html = '';
    teachers.forEach(teacher => {
      const isActive = teacher === currentTeacher;
      const style = isActive
        ? 'padding: 12px 24px; background: #667eea; color: white; border: none; border-bottom: 3px solid #667eea; cursor: pointer; font-weight: 600; font-size: 0.95rem;'
        : 'padding: 12px 24px; background: transparent; color: #6b7280; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 500; font-size: 0.95rem;';

      html += `<button onclick="switchTeacher('${teacher}')" style="${style}">${teacher}</button>`;
    });

    tabsContainer.innerHTML = html;
  }

  // ì„ ìƒë‹˜ ì „í™˜
  window.switchTeacher = function(teacher) {
    window.scheduleModalData.currentTeacher = teacher;
    window.scheduleModalData.selectedDate = null;

    renderTeacherTabs();
    document.getElementById('selected-date-info').style.display = 'none';
    document.getElementById('schedule-select-content').innerHTML = '<p style="text-align: center; color: #9ca3af;">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';

    // í˜„ì¬ ì£¼ì˜ ì‹œê°„í‘œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    loadScheduleAndRenderCalendar(window.scheduleModalData.selectedWeekOffset);
  };

  // ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê³  ìº˜ë¦°ë” ë Œë”ë§
  function loadScheduleAndRenderCalendar(weekOffset) {
    const teacher = window.scheduleModalData.currentTeacher;

    fetch(`/admin/load_schedule?teacher=${encodeURIComponent(teacher)}&week_offset=${weekOffset}&mode=manager`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.scheduleModalData.scheduleData = data.schedules;
          window.scheduleModalData.selectedWeekOffset = weekOffset;
          renderScheduleCalendar(data.week_start, data.week_end);
        } else {
          alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.log('Error:', error);
        alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  }

  // ìº˜ë¦°ë” ë Œë”ë§ (ì£¼ ë‹¨ìœ„)
  function renderScheduleCalendar(weekStart, weekEnd) {
    const startDate = new Date(weekStart + 'T00:00:00');
    const endDate = new Date(weekEnd + 'T00:00:00');

    const year = startDate.getFullYear();
    const month = startDate.getMonth() + 1;

    document.getElementById('schedule-calendar-month').textContent = `${year}ë…„ ${month}ì›” (${weekStart} ~ ${weekEnd})`;

    const scheduleData = window.scheduleModalData.scheduleData;
    const teacherHolidays = window.scheduleModalData.teacherHolidays[window.scheduleModalData.currentTeacher] || [];
    const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const timeSlots = ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'];

    let html = '<table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr>';
    ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
      html += `<th style="padding: 8px; text-align: center; font-weight: 600; color: #6b7280;">${day}</th>`;
    });
    html += '</tr></thead><tbody><tr>';

    // 7ì¼ê°„ì˜ ë‚ ì§œ ë Œë”ë§
    for (let i = 0; i < 7; i++) {
      const currentDate = new Date(startDate);
      currentDate.setDate(startDate.getDate() + i);

      const dateStr = currentDate.getFullYear() + '-' +
                      String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                      String(currentDate.getDate()).padStart(2, '0');

      const dayOfWeek = currentDate.getDay();
      const dayKey = dayKeys[dayOfWeek];
      const isHoliday = teacherHolidays.includes(dayOfWeek);

      let isFull = false;
      if (!isHoliday && scheduleData[dayKey]) {
        isFull = true;
        for (const timeSlot of timeSlots) {
          const students = scheduleData[dayKey][timeSlot] || [];
          if (students.length < 3) {
            isFull = false;
            break;
          }
        }
      }

      let style = 'padding: 20px; text-align: center; cursor: pointer; border: 1px solid #e5e7eb; vertical-align: top;';
      let bgColor = 'white';

      if (isHoliday) {
        bgColor = '#fef3c7'; // ì—°ë…¸ë‘ (íœ´ë¬´ì¼)
        style += ' cursor: not-allowed;';
      } else if (isFull) {
        bgColor = '#fee2e2'; // ì—°ë¶‰ì€ìƒ‰ (ê½‰ ì°¸)
        style += ' cursor: not-allowed;';
      } else {
        bgColor = 'white';
      }

      style += ` background: ${bgColor};`;

      const onclick = (isHoliday || isFull) ? '' : `onclick="selectScheduleDate('${dateStr}')"`;
      const onmouseover = (isHoliday || isFull) ? '' : `onmouseover="this.style.background='#dbeafe'"`;
      const onmouseout = (isHoliday || isFull) ? '' : `onmouseout="this.style.background='${bgColor}'"`;

      html += `<td style="${style}" ${onclick} ${onmouseover} ${onmouseout}>`;
      html += `<div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">${currentDate.getDate()}</div>`;

      if (isHoliday) {
        html += '<div style="font-size: 0.8rem; color: #f59e0b;">íœ´ë¬´</div>';
      } else if (isFull) {
        html += '<div style="font-size: 0.8rem; color: #dc2626;">ì˜ˆì•½ ë¶ˆê°€</div>';
      }

      html += '</td>';
    }

    html += '</tr></tbody></table>';
    document.getElementById('schedule-calendar-content').innerHTML = html;
  }

  // ì£¼ ë³€ê²½
  window.changeScheduleMonth = function(delta) {
    const newWeekOffset = window.scheduleModalData.selectedWeekOffset + delta;
    loadScheduleAndRenderCalendar(newWeekOffset);
  };

  // ë‚ ì§œ ì„ íƒ
  window.selectScheduleDate = function(dateStr) {
    window.scheduleModalData.selectedDate = dateStr;

    const date = new Date(dateStr + 'T00:00:00');
    const dayOfWeek = date.getDay();
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];

    const selectedDay = dayKeys[dayOfWeek];

    // ì„ íƒëœ ë‚ ì§œ ì •ë³´ í‘œì‹œ
    const infoDiv = document.getElementById('selected-date-info');
    infoDiv.style.display = 'block';
    infoDiv.querySelector('p').textContent = `ì„ íƒëœ ë‚ ì§œ: ${dateStr} (${dayNames[dayOfWeek]})`;

    // í•´ë‹¹ ìš”ì¼ì˜ ì‹œê°„í‘œ í‘œì‹œ
    const scheduleData = window.scheduleModalData.scheduleData;
    const teacherHolidays = window.scheduleModalData.teacherHolidays[window.scheduleModalData.currentTeacher] || [];
    const isHoliday = teacherHolidays.includes(dayOfWeek);

    renderScheduleForDay(selectedDay, scheduleData[selectedDay] || {}, isHoliday);
  };

  // íŠ¹ì • ìš”ì¼ì˜ ì‹œê°„í‘œ ë Œë”ë§
  function renderScheduleForDay(day, daySchedule, isHoliday) {
    const modalContent = document.getElementById('schedule-select-content');
    const timeSlots = ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'];

    let html = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">';

    timeSlots.forEach(timeSlot => {
      const students = daySchedule[timeSlot] || [];
      const currentCount = students.length;
      const isFull = currentCount >= 3;

      let cardStyle = 'padding: 20px; border-radius: 8px; text-align: center; border: 2px solid; transition: all 0.2s;';
      let onclick = '';

      if (isHoliday) {
        cardStyle += ' background: #fef3c7; color: #f59e0b; border-color: #fbbf24; cursor: not-allowed;';
      } else if (isFull) {
        cardStyle += ' background: #fee2e2; color: #dc2626; border-color: #fecaca; cursor: not-allowed;';
      } else {
        cardStyle += ' background: #dbeafe; color: #1e40af; border-color: #93c5fd; cursor: pointer;';
        onclick = `onclick="selectScheduleSlot('${day}', '${timeSlot}')"`;
      }

      html += `<div style="${cardStyle}" ${onclick}>`;
      html += `<div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">${timeSlot.replace('-', ':00-')}:00</div>`;

      if (isHoliday) {
        html += '<div style="font-size: 0.9rem;">íœ´ë¬´</div>';
      } else {
        html += `<div style="font-size: 0.9rem;">${currentCount}/3</div>`;
        if (!isFull) {
          html += '<div style="font-size: 0.8rem; margin-top: 4px; color: #10b981;">ì„ íƒ ê°€ëŠ¥</div>';
        } else {
          html += '<div style="font-size: 0.8rem; margin-top: 4px;">ìë¦¬ ì—†ìŒ</div>';
        }
      }

      html += '</div>';
    });

    html += '</div>';
    modalContent.innerHTML = html;
  }

  // ì‹œê°„ëŒ€ ì„ íƒ
  window.selectScheduleSlot = function(day, timeSlot) {
    const modalData = window.scheduleModalData;
    const selectedDate = modalData.selectedDate;
    const selectedTeacher = modalData.currentTeacher;

    if (!selectedDate) {
      alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const dayNames = { sun: 'ì¼', mon: 'ì›”', tue: 'í™”', wed: 'ìˆ˜', thu: 'ëª©', fri: 'ê¸ˆ', sat: 'í† ' };
    const confirmMessage = `${selectedTeacher} ì„ ìƒë‹˜\n${selectedDate} (${dayNames[day]})\n${timeSlot.replace('-', ':00-')}:00\n\nìœ„ ì‹œê°„ëŒ€ë¡œ ë³µê·€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

    if (!confirm(confirmMessage)) return;

    fetch(`/admin/user_enrollments/${window.currentEnrollmentId}/toggle_status`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        status: 'active',
        day: day,
        time_slot: timeSlot,
        teacher: selectedTeacher,
        first_lesson_date: selectedDate
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('ë³µê·€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('schedule-select-modal').style.display = 'none';
        closeEnrollmentManageModal();
        window.loadPaymentsTab();
      } else {
        alert('ë³µê·€ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ë³µê·€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  };

  window.closeScheduleSelectModal = function() {
    document.getElementById('schedule-select-modal').style.display = 'none';
  };

  // ============== ê²°ì œ ìº˜ë¦°ë” ==============
  let paymentCalendarData = <%= raw @payment_calendar_data.to_json %>;
  let currentCalendarMonth = new Date();

  // ì¦‰ì‹œ ìº˜ë¦°ë” ë Œë”ë§ (AJAXë¡œ ë¡œë“œë˜ë¯€ë¡œ DOMContentLoaded ì‚¬ìš© ì•ˆ í•¨)
  renderPaymentCalendar();

  // ìº˜ë¦°ë” ë Œë”ë§
  function renderPaymentCalendar() {
    const year = currentCalendarMonth.getFullYear();
    const month = currentCalendarMonth.getMonth();

    document.getElementById('calendar-month-title').textContent = `${year}ë…„ ${month + 1}ì›”`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let html = '<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">';
    html += '<thead><tr>';
    ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach((day, idx) => {
      const color = idx === 0 ? '#dc2626' : idx === 6 ? '#2563eb' : '#6b7280';
      html += `<th style="width: 14.28%; padding: 12px; text-align: center; font-weight: 600; color: ${color}; font-size: 0.9rem;">${day}</th>`;
    });
    html += '</tr></thead><tbody><tr>';

    // ë¹ˆ ì¹¸
    for (let i = 0; i < firstDay; i++) {
      html += '<td style="padding: 15px; border: 1px solid #e5e7eb; background: #f9fafb;"></td>';
    }

    // ë‚ ì§œ ë Œë”ë§
    for (let date = 1; date <= lastDate; date++) {
      const currentDate = new Date(year, month, date);
      currentDate.setHours(0, 0, 0, 0);
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

      const payments = paymentCalendarData[dateStr] || [];
      const count = payments.length;

      const isToday = currentDate.getTime() === today.getTime();
      const isPast = currentDate < today;

      let bgColor = 'white';
      let borderColor = '#e5e7eb';
      let cursor = 'default';

      if (isToday) {
        bgColor = '#fef3c7';
        borderColor = '#f59e0b';
      } else if (isPast) {
        bgColor = '#f3f4f6';
      } else if (count > 0) {
        bgColor = '#dbeafe';
        borderColor = '#3b82f6';
        cursor = 'pointer';
      }

      const onclick = count > 0 ? `onclick="showPaymentDateDetail('${dateStr}')"` : '';
      const style = `height: 100px; padding: 15px; border: 2px solid ${borderColor}; background: ${bgColor}; vertical-align: top; cursor: ${cursor}; transition: all 0.2s;`;
      const hover = count > 0 ? `onmouseover="this.style.background='#bfdbfe'" onmouseout="this.style.background='${bgColor}'"` : '';

      html += `<td style="${style}" ${onclick} ${hover}>`;
      html += `<div style="font-size: 1rem; font-weight: 600; margin-bottom: 5px; color: ${isToday ? '#d97706' : '#2d3748'};">${date}</div>`;

      if (count > 0) {
        html += `<div style="display: inline-block; padding: 4px 8px; background: ${isToday ? '#f59e0b' : '#3b82f6'}; color: white; border-radius: 12px; font-size: 0.75rem; font-weight: 700;">${count}ëª…</div>`;
      }

      html += '</td>';

      if ((firstDay + date) % 7 === 0 && date !== lastDate) {
        html += '</tr><tr>';
      }
    }

    // ë§ˆì§€ë§‰ ë¹ˆ ì¹¸
    const lastDayOfWeek = (firstDay + lastDate) % 7;
    if (lastDayOfWeek !== 0) {
      for (let i = lastDayOfWeek; i < 7; i++) {
        html += '<td style="padding: 15px; border: 1px solid #e5e7eb; background: #f9fafb;"></td>';
      }
    }

    html += '</tr></tbody></table>';
    document.getElementById('payment-calendar-content').innerHTML = html;

    // ì˜¤ëŠ˜ ê²°ì œ ì˜ˆì •ì í‘œì‹œ
    const todayStr = today.toISOString().split('T')[0];
    const todayPayments = paymentCalendarData[todayStr] || [];

    if (todayPayments.length > 0) {
      document.getElementById('today-payments-summary').style.display = 'block';
      let summaryHtml = `<strong>${todayPayments.length}ëª…</strong>ì˜ íšŒì›ì´ ì˜¤ëŠ˜ ê²°ì œ ì˜ˆì •ì…ë‹ˆë‹¤:<br>`;
      todayPayments.forEach(p => {
        summaryHtml += `â€¢ ${p.user_name} (${p.subject} - ${p.teacher})<br>`;
      });
      document.getElementById('today-payments-list').innerHTML = summaryHtml;
    } else {
      document.getElementById('today-payments-summary').style.display = 'none';
    }
  }

  // ì›” ë³€ê²½
  window.changeCalendarMonth = function(delta) {
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + delta);
    renderPaymentCalendar();
  };

  // ë‚ ì§œë³„ ê²°ì œ ì˜ˆì •ì ìƒì„¸ ë³´ê¸°
  window.showPaymentDateDetail = function(dateStr) {
    const payments = paymentCalendarData[dateStr] || [];
    if (payments.length === 0) return;

    const date = new Date(dateStr + 'T00:00:00');
    const formattedDate = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;

    document.getElementById('payment-date-modal-title').textContent = `${formattedDate} ê²°ì œ ì˜ˆì •ì`;

    let html = '';
    payments.forEach(payment => {
      html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">';
      html += `<div style="font-weight: 700; font-size: 1rem; color: #2d3748; margin-bottom: 8px;">${payment.user_name}</div>`;
      html += `<div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 5px;">ê³¼ëª©: ${payment.subject}</div>`;
      html += `<div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 10px;">ì„ ìƒë‹˜: ${payment.teacher}</div>`;
      html += `<button onclick="extendEnrollment(${payment.enrollment_id}, ${payment.user_id})" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">ì—°ì¥í•˜ê¸°</button>`;
      html += '</div>';
    });

    document.getElementById('payment-date-list').innerHTML = html;
    document.getElementById('payment-date-modal').style.display = 'flex';
  };

  // ê²°ì œ ë‚ ì§œ ëª¨ë‹¬ ë‹«ê¸°
  window.closePaymentDateModal = function(event) {
    if (!event || event.target.id === 'payment-date-modal') {
      document.getElementById('payment-date-modal').style.display = 'none';
    }
  };

  console.log('ê²°ì œê´€ë¦¬ JavaScript ë¡œë“œ ì™„ë£Œ');
})();
</script>
