<style>
  .payments-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    overflow: hidden;
    max-width: 100%;
  }

  .payments-content {
    padding: 25px;
    overflow-x: auto;
  }

  .payments-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .payments-table-header {
    background: #f8fafc;
  }

  .payments-table-header th {
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e2e8f0;
  }

  .payments-table-header th:first-child {
    border-radius: 8px 0 0 0;
  }

  .payments-table-header th:last-child {
    border-radius: 0 8px 0 0;
  }

  .payment-row {
    transition: background-color 0.2s ease;
  }

  .payment-row:hover {
    background: #f8fafc;
  }

  .payment-row td {
    padding: 15px 12px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
  }

  .user-name-payment {
    font-weight: 600;
    color: #2d3748;
  }

  .payment-date {
    color: #4a5568;
  }

  .payment-date.overdue {
    color: #dc2626;
    font-weight: 600;
  }

  .payment-date.none {
    color: #9ca3af;
    font-style: italic;
  }

  .pagination-container {
    margin-top: 25px;
    display: flex;
    justify-content: center;
    gap: 8px;
  }

  .pagination-btn {
    padding: 8px 16px;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    color: #4a5568;
    transition: all 0.3s ease;
  }

  .pagination-btn:hover:not(:disabled) {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .pagination-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .pagination-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .empty-state-payment {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
  }

  .empty-state-icon-payment {
    font-size: 3rem;
    margin-bottom: 16px;
  }

  .empty-state-text-payment {
    font-size: 1.1rem;
    font-weight: 500;
  }

  .remaining-lessons {
    color: #2d3748;
    font-weight: 600;
  }

  .payment-amount-input {
    width: 100px;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.85rem;
    transition: all 0.3s ease;
  }

  .payment-amount-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .payment-buttons {
    display: flex;
    gap: 6px;
  }

  .payment-period-btn {
    padding: 8px 14px;
    border: 1px solid #667eea;
    background: white;
    color: #667eea;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .payment-period-btn:hover {
    background: #667eea;
    color: white;
  }

  .subject-select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.85rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 90px;
  }

  .subject-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .confirm-payment-btn {
    padding: 8px 16px;
    border: 1px solid #10b981;
    background: #10b981;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .confirm-payment-btn:hover {
    background: #059669;
    border-color: #059669;
  }

  .leave-status-btn {
    padding: 8px 16px;
    border: 1px solid #9ca3af;
    background: white;
    color: #4a5568;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .leave-status-btn:hover {
    background: #f3f4f6;
    border-color: #6b7280;
  }

  .leave-status-btn.on-leave {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #d97706;
  }

  .leave-status-btn.on-leave:hover {
    background: #fde68a;
    border-color: #d97706;
  }

  /* 320px ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 320px) {
    .payments-container {
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .payments-content {
      padding: 16px;
      overflow-x: auto;
    }

    .payments-table {
      min-width: 500px;
      font-size: 0.8rem;
    }

    .payments-table-header th {
      padding: 10px 8px;
      font-size: 0.7rem;
    }

    .payment-row td {
      padding: 10px 8px;
      font-size: 0.8rem;
    }

    .user-name-payment {
      font-size: 0.85rem;
    }

    .pagination-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
    }

    .empty-state-payment {
      padding: 40px 16px;
    }

    .empty-state-icon-payment {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .empty-state-text-payment {
      font-size: 0.95rem;
    }

    .payment-amount-input {
      width: 80px;
      padding: 6px 8px;
      font-size: 0.75rem;
    }

    .payment-period-btn {
      padding: 6px 10px;
      font-size: 0.7rem;
    }

    .subject-select {
      padding: 6px 8px;
      font-size: 0.75rem;
      min-width: 70px;
    }

    .confirm-payment-btn {
      padding: 6px 12px;
      font-size: 0.7rem;
    }
  }

  /* ê²°ì œ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
  .payment-history-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .payment-history-modal.active {
    display: flex;
  }

  .payment-history-content {
    background: white;
    border-radius: 12px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .payment-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
  }

  .payment-history-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #2d3748;
  }

  .payment-history-close {
    font-size: 1.5rem;
    color: #9ca3af;
    cursor: pointer;
    border: none;
    background: none;
    padding: 0;
    line-height: 1;
  }

  .payment-history-close:hover {
    color: #4a5568;
  }

  .payment-history-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .payment-history-item {
    background: #f8fafc;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #667eea;
  }

  .payment-history-date {
    font-size: 0.9rem;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 8px;
  }

  .payment-history-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 0.85rem;
    color: #4a5568;
  }

  .payment-history-detail-row {
    display: flex;
    justify-content: space-between;
  }

  .payment-history-label {
    font-weight: 600;
    color: #2d3748;
  }

  .payment-history-empty {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
  }
</style>

<!-- ê²°ì œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="payment-modal" class="payment-history-modal" onclick="closePaymentModal(event)" style="display: none;">
  <div class="payment-history-content" style="max-width: 800px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title" id="payment-modal-user-name"></h3>
      <button class="payment-history-close" onclick="closePaymentModal()">&times;</button>
    </div>

    <!-- ìˆ˜ê°• ë“±ë¡ ëª©ë¡ -->
    <div id="enrollment-list" style="margin-bottom: 20px;"></div>

    <!-- ìƒˆ ê³¼ëª© ì¶”ê°€ ë²„íŠ¼ -->
    <button onclick="addNewEnrollment()" style="margin-bottom: 20px; padding: 10px 16px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">+ ìƒˆ ê³¼ëª© ì¶”ê°€</button>

    <!-- ê²°ì œ ì •ë³´ ì„¹ì…˜ -->
    <div id="payment-section" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; background: #f8fafc;"></div>
  </div>
</div>

<!-- ìƒˆ ê³¼ëª© ì¶”ê°€ ëª¨ë‹¬ -->
<div id="add-enrollment-modal" class="payment-history-modal" onclick="closeAddEnrollmentModal(event)" style="display: none;">
  <div class="payment-history-content" style="max-width: 600px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title">ìƒˆ ê³¼ëª© ì¶”ê°€</h3>
      <button class="payment-history-close" onclick="closeAddEnrollmentModal()">&times;</button>
    </div>

    <div style="padding: 20px;">
      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ë‹´ë‹¹ ì„ ìƒë‹˜</label>
        <select id="new-enrollment-teacher" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.95rem;">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ë¬´ì„±" data-subject="í´ë¦°">ë¬´ì„± (í´ë¦°)</option>
          <option value="ì„±ê· " data-subject="í´ë¦°">ì„±ê·  (í´ë¦°)</option>
          <option value="ë…¸ë„¤ì„" data-subject="í´ë¦°">ë…¸ë„¤ì„ (í´ë¦°)</option>
          <option value="ë¡œí•œ" data-subject="í´ë¦°">ë¡œí•œ (í´ë¦°)</option>
          <option value="ë²”ì„" data-subject="í´ë¦°">ë²”ì„ (í´ë¦°)</option>
          <option value="ë‘ë°•" data-subject="í´ë¦°">ë‘ë°• (í´ë¦°)</option>
          <option value="ì˜¤ë˜" data-subject="í´ë¦°">ì˜¤ë˜ (í´ë¦°)</option>
          <option value="ì§€ëª…" data-subject="ë¯¹ì‹±">ì§€ëª… (ë¯¹ì‹±)</option>
          <option value="ë„í˜„" data-subject="ì–¸í´ë¦°">ë„í˜„ (ì–¸í´ë¦°)</option>
          <option value="ì˜¨ë¼ì¸" data-subject="í´ë¦°">ì˜¨ë¼ì¸ (í´ë¦°)</option>
        </select>
      </div>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ê³¼ëª©</label>
        <input type="text" id="new-enrollment-subject" readonly style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 0.95rem;" placeholder="ì„ ìƒë‹˜ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤">
      </div>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ì²«ìˆ˜ì—… ë‚ ì§œ</label>
        <div id="new-enrollment-calendar"></div>
        <input type="hidden" id="new-enrollment-date">
      </div>

      <div id="new-enrollment-time-section" style="margin-bottom: 24px; display: none;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ì²«ìˆ˜ì—… ì‹œê°„</label>
        <div id="new-enrollment-time-slots" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;"></div>
        <input type="hidden" id="new-enrollment-time">
      </div>

      <div id="new-enrollment-duration-section" style="margin-bottom: 24px; display: none;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">ìˆ˜ê°• ê¸°ê°„</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
          <button type="button" class="duration-btn" data-months="1" data-lessons="4" onclick="selectDuration(1, 4, this)" style="padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
            <div style="font-weight: 600;">1ê°œì›”</div>
            <div style="font-size: 0.8rem; color: #6b7280;">4íšŒ</div>
          </button>
          <button type="button" class="duration-btn" data-months="3" data-lessons="12" onclick="selectDuration(3, 12, this)" style="padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
            <div style="font-weight: 600;">3ê°œì›”</div>
            <div style="font-size: 0.8rem; color: #6b7280;">12íšŒ</div>
          </button>
          <button type="button" class="duration-btn" data-months="4" data-lessons="16" onclick="selectDuration(4, 16, this)" style="padding: 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
            <div style="font-weight: 600;">4ê°œì›” (ë¯¹ì‹±)</div>
            <div style="font-size: 0.8rem; color: #6b7280;">16íšŒ</div>
          </button>
        </div>
        <input type="hidden" id="new-enrollment-months">
        <input type="hidden" id="new-enrollment-lessons">
      </div>

      <div id="new-enrollment-summary" style="margin-bottom: 24px; display: none; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
        <div style="font-weight: 600; margin-bottom: 12px; color: #2d3748;">ìˆ˜ê°• ì •ë³´ ìš”ì•½</div>
        <div style="display: grid; gap: 8px; font-size: 0.9rem;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ë‹´ë‹¹ ì„ ìƒë‹˜</span>
            <span id="summary-teacher" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ê³¼ëª©</span>
            <span id="summary-subject" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ìš”ì¼/ì‹œê°„</span>
            <span id="summary-schedule" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ì²«ìˆ˜ì—… ë‚ ì§œ</span>
            <span id="summary-first-lesson" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ì¢…ë£Œì¼</span>
            <span id="summary-end-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #6b7280;">ë‚¨ì€ ìˆ˜ì—…</span>
            <span id="summary-lessons" style="font-weight: 600; color: #667eea;"></span>
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <button onclick="closeAddEnrollmentModal()" style="flex: 1; padding: 12px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
        <button onclick="saveNewEnrollment()" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">ì¶”ê°€</button>
      </div>
    </div>
  </div>
</div>

<!-- ê²°ì œ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
<div id="payment-history-modal" class="payment-history-modal" onclick="closePaymentHistoryModal(event)">
  <div class="payment-history-content" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title" id="payment-history-user-name"></h3>
      <button class="payment-history-close" onclick="closePaymentHistoryModal()">&times;</button>
    </div>
    <div id="payment-history-list" class="payment-history-list"></div>
  </div>
</div>

<!-- ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬ ëª¨ë‹¬ -->
<div id="enrollment-manage-modal" class="payment-history-modal" onclick="closeEnrollmentManageModal(event)">
  <div class="payment-history-content" style="max-width: 500px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title">ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬</h3>
      <button class="payment-history-close" onclick="closeEnrollmentManageModal()">&times;</button>
    </div>
    <div id="enrollment-manage-list" style="padding: 20px;"></div>
  </div>
</div>

<!-- ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ (íœ´ì› í•´ì œìš©) -->
<div id="schedule-select-modal" class="payment-history-modal" onclick="closeScheduleSelectModal(event)" style="display: none;">
  <div class="payment-history-content" style="max-width: 900px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title">ë³µê·€í•  ì‹œê°„ëŒ€ ì„ íƒ</h3>
      <button class="payment-history-close" onclick="closeScheduleSelectModal()">&times;</button>
    </div>
    <div style="padding: 20px;">
      <p style="margin-bottom: 15px; color: #6b7280;">ì›í•˜ì‹œëŠ” ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ë¹ˆ ìë¦¬ë§Œ ì„ íƒ ê°€ëŠ¥)</p>
      <div id="schedule-select-content"></div>
    </div>
  </div>
</div>

<!-- ê²°ì œì¼ íšŒì› ëª©ë¡ ëª¨ë‹¬ -->
<div id="payment-date-modal" class="payment-history-modal" onclick="closePaymentDateModal(event)">
  <div class="payment-history-content" style="max-width: 700px;" onclick="event.stopPropagation()">
    <div class="payment-history-header">
      <h3 class="payment-history-title" id="payment-date-modal-title"></h3>
      <button class="payment-history-close" onclick="closePaymentDateModal()">&times;</button>
    </div>
    <div style="padding: 20px;">
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
          <input type="checkbox" id="select-all-payments" onclick="toggleAllPaymentCheckboxes()" style="width: 16px; height: 16px; cursor: pointer;">
          <span style="font-weight: 600;">ì „ì²´ì„ íƒ</span>
        </label>
        <button onclick="markSelectedAsPaid()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ì„ íƒí•­ëª© ê²°ì œì™„ë£Œ ì²˜ë¦¬</button>
      </div>
      <div id="payment-date-list" style="display: flex; flex-direction: column; gap: 15px;"></div>
    </div>
  </div>
</div>

<div class="payments-container">
  <div class="payments-content">
    <% if @users.empty? %>
      <div class="empty-state-payment">
        <div class="empty-state-icon-payment">ğŸ’³</div>
        <div class="empty-state-text-payment">
          <%= params[:search].present? ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.' %>
        </div>
      </div>
    <% else %>
      <table class="payments-table">
        <thead class="payments-table-header">
          <tr>
            <th>ì´ë¦„</th>
            <th>ë‹´ë‹¹ ì„ ìƒë‹˜</th>
            <th>ìƒíƒœ</th>
            <th>íœ´ì›</th>
            <th>ë§ˆì§€ë§‰ ê²°ì œì¼</th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody>
          <% @users.each do |user| %>
            <%
              # ì‚¬ìš©ìì˜ ê²°ì œ ì™„ë£Œëœ ë“±ë¡ ê³¼ëª©ë§Œ ê°€ì ¸ì˜¤ê¸°
              enrollments = UserEnrollment.where(user_id: user['id'], is_paid: true)
              teachers = enrollments.map(&:teacher).uniq.join(', ')
              teachers = user['teacher'] if teachers.blank?

              # ìƒíƒœ í‘œì‹œ
              status_text = case user['status']
              when 'on_leave' then 'íœ´ì›'
              when 'active', 'approved' then 'í™œì„±'
              else 'ëŒ€ê¸°'
              end

              status_color = case user['status']
              when 'on_leave' then '#f59e0b'
              when 'active', 'approved' then '#10b981'
              else '#9ca3af'
              end
            %>
            <tr class="payment-row" data-user-id="<%= user['id'] %>">
              <td>
                <span class="user-name-payment" style="cursor: pointer; text-decoration: underline; color: #667eea; font-weight: 600;" onclick="openPaymentModal(<%= user['id'] %>)">
                  <%= user['name'] %>
                </span>
              </td>
              <td><%= teachers %></td>
              <td>
                <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: <%= status_color %>20; color: <%= status_color %>;">
                  <%= status_text %>
                </span>
              </td>
              <td>
                <% if enrollments.any? %>
                  <button onclick="openEnrollmentModal(<%= user['id'] %>)"
                          style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                    ê³¼ëª©ë³„ ê´€ë¦¬
                  </button>

                  <!-- ëª¨ë‹¬ìš© ë°ì´í„° ì €ì¥ -->
                  <div id="enrollment-data-<%= user['id'] %>" style="display: none;">
                    <% enrollments.each do |enrollment| %>
                      <div class="enrollment-item"
                           data-id="<%= enrollment.id %>"
                           data-subject="<%= enrollment.subject %>"
                           data-teacher="<%= enrollment.teacher %>"
                           data-day="<%= enrollment.day_korean %>"
                           data-time="<%= enrollment.time_slot %>"
                           data-status="<%= enrollment.status %>">
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <span style="color: #9ca3af;">-</span>
                <% end %>
              </td>
              <td>
                <% if user['last_payment_date'].present? %>
                  <% payment_date = user['last_payment_date'].is_a?(Date) ? user['last_payment_date'] : Date.parse(user['last_payment_date']) %>
                  <% days_ago = (Date.current - payment_date).to_i %>
                  <% is_overdue = days_ago > 30 %>
                  <span class="payment-date <%= is_overdue ? 'overdue' : '' %>">
                    <%= payment_date.strftime('%Y.%m.%d') %>
                    <% if is_overdue %>
                      <span style="font-size: 0.8rem; color: #ef4444;">(<%= days_ago %>ì¼ ì „)</span>
                    <% end %>
                  </span>
                <% else %>
                  <span class="payment-date none">-</span>
                <% end %>
              </td>
              <td>
                <button onclick="showPaymentHistory(<%= user['id'] %>)" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                  ê²°ì œ ë‚´ì—­ ë³´ê¸°
                </button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <% if @total_pages > 1 %>
        <div class="pagination-container">
          <button class="pagination-btn" onclick="loadPaymentsTab(<%= [@page - 1, 1].max %>)" <%= 'disabled' if @page == 1 %>>
            ì´ì „
          </button>

          <% start_page = [@page - 2, 1].max %>
          <% end_page = [start_page + 4, @total_pages].min %>
          <% start_page = [end_page - 4, 1].max if end_page - start_page < 4 %>

          <% (start_page..end_page).each do |page_num| %>
            <button class="pagination-btn <%= 'active' if page_num == @page %>" onclick="loadPaymentsTab(<%= page_num %>)">
              <%= page_num %>
            </button>
          <% end %>

          <button class="pagination-btn" onclick="loadPaymentsTab(<%= [@page + 1, @total_pages].min %>)" <%= 'disabled' if @page == @total_pages %>>
            ë‹¤ìŒ
          </button>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
(function() {
  // ê³¼ëª©ë³„ ê°€ê²© ì •ë³´
  const SUBJECT_PRICES = {
    'í´ë¦°': { 1: 370000, 3: 950000 },
    'ì–¸í´ë¦°': { 1: 370000, 3: 950000 },
    'ë¯¹ì‹±': { 1: 280000, 4: 990000 },
    'ì‘ê³¡': { 1: 350000, 3: 950000 },
    'ê¸°íƒ€': { 1: 300000, 3: 770000 }
  };

  // í• ì¸ ì •ë³´
  const DISCOUNTS = {
    'text_review': 30000,
    'video_review': 30000,
    'referral': 50000,
    'bundle_2': 50000,
    'bundle_3': 100000
  };

  // ì„ ìƒë‹˜ íœ´ë¬´ì¼ ë°ì´í„°
  const TEACHER_HOLIDAYS = <%= raw @teacher_holidays.to_json %>;

  let currentUserId = null;
  let currentUserName = null;
  let enrollments = []; // ì¶”ê°€í•  ê³¼ëª© ëª©ë¡
  let selectedTeacher = null; // í˜„ì¬ ì„ íƒëœ ì„ ìƒë‹˜

  // ê²°ì œ ëª¨ë‹¬ ì—´ê¸°
  window.openPaymentModal = function(userId) {
    fetch(`/admin/users/${userId}`)
      .then(response => response.json())
      .then(data => {
        currentUserId = userId;
        currentUserName = data.name;
        enrollments = [];

        document.getElementById('payment-modal-user-name').textContent = data.name + ' - ê²°ì œ ë“±ë¡';
        document.getElementById('enrollment-list').innerHTML = '';
        document.getElementById('payment-section').innerHTML = '';
        document.getElementById('payment-modal').style.display = 'flex';
      })
      .catch(error => {
        console.error('Error:', error);
        alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  };

  // ê²°ì œ ëª¨ë‹¬ ë‹«ê¸°
  window.closePaymentModal = function(event) {
    if (!event || event.target.id === 'payment-modal') {
      document.getElementById('payment-modal').style.display = 'none';
      enrollments = [];
    }
  };

  // ìƒˆ ê³¼ëª© ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
  window.addNewEnrollment = function() {
    document.getElementById('add-enrollment-modal').style.display = 'flex';
    initializeEnrollmentForm();
  };

  // ìƒˆ ê³¼ëª© ì¶”ê°€ ëª¨ë‹¬ ë‹«ê¸°
  window.closeAddEnrollmentModal = function(event) {
    if (!event || event.target.id === 'add-enrollment-modal') {
      document.getElementById('add-enrollment-modal').style.display = 'none';
    }
  };

  // ê³¼ëª© ì¶”ê°€ í¼ ì´ˆê¸°í™”
  function initializeEnrollmentForm() {
    // ì„ ìƒë‹˜ ì„ íƒ ì‹œ ê³¼ëª© ìë™ ì…ë ¥
    document.getElementById('new-enrollment-teacher').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const subject = selectedOption.getAttribute('data-subject');
      selectedTeacher = this.value; // ì„ íƒëœ ì„ ìƒë‹˜ ì €ì¥
      document.getElementById('new-enrollment-subject').value = subject || '';

      if (subject) {
        showCalendar();
      }
    });

    // í¼ ë¦¬ì…‹
    document.getElementById('new-enrollment-teacher').value = '';
    document.getElementById('new-enrollment-subject').value = '';
    document.getElementById('new-enrollment-date').value = '';
    document.getElementById('new-enrollment-time').value = '';
    document.getElementById('new-enrollment-months').value = '';
    document.getElementById('new-enrollment-lessons').value = '';
    document.getElementById('new-enrollment-time-section').style.display = 'none';
    document.getElementById('new-enrollment-duration-section').style.display = 'none';
    document.getElementById('new-enrollment-summary').style.display = 'none';
  }

  // ë‹¬ë ¥ í‘œì‹œ
  function showCalendar() {
    const calendarDiv = document.getElementById('new-enrollment-calendar');
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();

    // ì„ íƒëœ ì„ ìƒë‹˜ì˜ íœ´ë¬´ì¼ ê°€ì ¸ì˜¤ê¸° (0=ì¼, 1=ì›”, 2=í™”, 3=ìˆ˜, 4=ëª©, 5=ê¸ˆ, 6=í† )
    const teacherHolidays = selectedTeacher ? (TEACHER_HOLIDAYS[selectedTeacher] || []) : [];

    let html = '<div style="text-align: center; margin-bottom: 10px; font-weight: 600;">';
    html += year + 'ë…„ ' + (month + 1) + 'ì›”</div>';
    html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">';

    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    dayNames.forEach(day => {
      html += '<div style="text-align: center; font-weight: 600; padding: 8px; font-size: 0.85rem;">' + day + '</div>';
    });

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      html += '<div></div>';
    }

    for (let date = 1; date <= lastDate; date++) {
      const fullDate = new Date(year, month, date);
      const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(date).padStart(2, '0');
      const dayOfWeek = fullDate.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 
      const isHoliday = teacherHolidays.includes(dayOfWeek);

      let style = 'text-align: center; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;';

      if (isHoliday) {
        // íœ´ë¬´ì¼ì€ ì„ íƒ ë¶ˆê°€
        style += ' opacity: 0.5; pointer-events: none; cursor: not-allowed;';
        style += ' background: #fef3c7;'; // ì—°ë…¸ë‘
      } else {
        style += ' cursor: pointer;';
      }

      const onclick = isHoliday ? '' : 'onclick="selectDate(\'' + dateStr + '\')"';

      html += '<div ' + onclick + ' style="' + style + '" data-date="' + dateStr + '">' + date + '</div>';
    }

    html += '</div>';
    calendarDiv.innerHTML = html;
  }

  // ë‚ ì§œ ì„ íƒ
  window.selectDate = function(dateStr) {
    document.getElementById('new-enrollment-date').value = dateStr;

    // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
    document.querySelectorAll('[data-date]').forEach(el => {
      el.style.background = '';
      el.style.color = '';
    });
    document.querySelector('[data-date="' + dateStr + '"]').style.background = '#667eea';
    document.querySelector('[data-date="' + dateStr + '"]').style.color = 'white';

    showTimeSlots(dateStr);
  };

  // ì‹œê°„ëŒ€ í‘œì‹œ
  function showTimeSlots(dateStr) {
    const parts = dateStr.split('-');
    const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];

    document.getElementById('new-enrollment-time-section').style.display = 'block';

    const timeSlots = ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'];
    let html = '';

    timeSlots.forEach(slot => {
      html += '<button type="button" onclick="selectTime(\'' + slot + '\')" class="time-slot-btn" data-time="' + slot + '" style="';
      html += 'padding: 10px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;';
      html += '">' + slot.replace('-', ':00-') + ':00</button>';
    });

    document.getElementById('new-enrollment-time-slots').innerHTML = html;
  }

  // ì‹œê°„ ì„ íƒ
  window.selectTime = function(timeSlot) {
    document.getElementById('new-enrollment-time').value = timeSlot;

    // ì„ íƒëœ ì‹œê°„ í‘œì‹œ
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
      btn.style.background = 'white';
      btn.style.borderColor = '#e2e8f0';
      btn.style.color = '#374151';
    });
    document.querySelector('[data-time="' + timeSlot + '"]').style.background = '#667eea';
    document.querySelector('[data-time="' + timeSlot + '"]').style.borderColor = '#667eea';
    document.querySelector('[data-time="' + timeSlot + '"]').style.color = 'white';

    showDurationOptions();
  };

  // ìˆ˜ê°• ê¸°ê°„ ì˜µì…˜ í‘œì‹œ
  function showDurationOptions() {
    const subject = document.getElementById('new-enrollment-subject').value;
    document.getElementById('new-enrollment-duration-section').style.display = 'block';

    // ê³¼ëª©ì— ë”°ë¼ ê°€ëŠ¥í•œ ê¸°ê°„ë§Œ í™œì„±í™”
    const availableMonths = Object.keys(SUBJECT_PRICES[subject] || {});
    document.querySelectorAll('.duration-btn').forEach(btn => {
      const months = btn.getAttribute('data-months');
      if (availableMonths.includes(months)) {
        btn.disabled = false;
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.3';
      }
    });
  }

  // ìˆ˜ê°• ê¸°ê°„ ì„ íƒ
  window.selectDuration = function(months, lessons, element) {
    document.getElementById('new-enrollment-months').value = months;
    document.getElementById('new-enrollment-lessons').value = lessons;

    // ì„ íƒëœ ê¸°ê°„ í‘œì‹œ
    document.querySelectorAll('.duration-btn').forEach(btn => {
      btn.style.borderColor = '#e2e8f0';
      btn.style.background = 'white';
    });
    element.style.borderColor = '#667eea';
    element.style.background = '#f0f4ff';

    updateSummary();
  };

  // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateSummary() {
    const teacher = document.getElementById('new-enrollment-teacher').value;
    const subject = document.getElementById('new-enrollment-subject').value;
    const dateStr = document.getElementById('new-enrollment-date').value;
    const timeSlot = document.getElementById('new-enrollment-time').value;
    const months = parseInt(document.getElementById('new-enrollment-months').value);
    const lessons = parseInt(document.getElementById('new-enrollment-lessons').value);

    if (!teacher || !subject || !dateStr || !timeSlot || !months) return;

    const parts = dateStr.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const day = parseInt(parts[2]);
    const date = new Date(year, month, day);
    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];

    // ì¢…ë£Œì¼ ê³„ì‚°
    const endDate = new Date(year, month + months, day);
    const endDateStr = endDate.getFullYear() + '-' +
                       String(endDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(endDate.getDate()).padStart(2, '0');

    document.getElementById('summary-teacher').textContent = teacher;
    document.getElementById('summary-subject').textContent = subject;
    document.getElementById('summary-schedule').textContent = dayOfWeek + 'ìš”ì¼ ' + timeSlot.replace('-', ':00-') + ':00';
    document.getElementById('summary-first-lesson').textContent = dateStr;
    document.getElementById('summary-end-date').textContent = endDateStr;
    document.getElementById('summary-lessons').textContent = lessons + 'íšŒ';

    document.getElementById('new-enrollment-summary').style.display = 'block';
  }

  // ìƒˆ ê³¼ëª© ì €ì¥
  window.saveNewEnrollment = function() {
    const teacher = document.getElementById('new-enrollment-teacher').value;
    const subject = document.getElementById('new-enrollment-subject').value;
    const dateStr = document.getElementById('new-enrollment-date').value;
    const timeSlot = document.getElementById('new-enrollment-time').value;
    const months = parseInt(document.getElementById('new-enrollment-months').value);
    const lessons = parseInt(document.getElementById('new-enrollment-lessons').value);

    if (!teacher || !subject || !dateStr || !timeSlot || !months) {
      alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const parts = dateStr.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const day = parseInt(parts[2]);
    const date = new Date(year, month, day);
    const dayOfWeek = date.getDay(); // 0=ì¼, 1=ì›”, ...

    // ì¢…ë£Œì¼ ê³„ì‚°
    const endDate = new Date(year, month + months, day);
    const endDateStr = endDate.getFullYear() + '-' +
                       String(endDate.getMonth() + 1).padStart(2, '0') + '-' +
                       String(endDate.getDate()).padStart(2, '0');

    enrollments.push({
      teacher: teacher,
      subject: subject,
      first_lesson_date: dateStr,
      time_slot: timeSlot,
      day_of_week: dayOfWeek,
      months: months,
      lessons: lessons,
      end_date: endDateStr,
      price: SUBJECT_PRICES[subject][months]
    });

    closeAddEnrollmentModal();
    updateEnrollmentList();
    updatePaymentSection();
  };

  // ë“±ë¡ ê³¼ëª© ëª©ë¡ ì—…ë°ì´íŠ¸
  function updateEnrollmentList() {
    const listDiv = document.getElementById('enrollment-list');
    if (enrollments.length === 0) {
      listDiv.innerHTML = '';
      return;
    }

    let html = '<div style="margin-bottom: 20px;"><h4 style="font-weight: 600; margin-bottom: 10px;">ë“±ë¡í•  ê³¼ëª©</h4>';
    enrollments.forEach((enroll, index) => {
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
      html += '<div>';
      html += '<div style="font-weight: 600; margin-bottom: 5px;">' + enroll.subject + ' - ' + enroll.teacher + '</div>';
      html += '<div style="font-size: 0.85rem; color: #6b7280;">' + dayNames[enroll.day_of_week] + 'ìš”ì¼ ' + enroll.time_slot.replace('-', ':00-') + ':00</div>';
      html += '<div style="font-size: 0.85rem; color: #6b7280;">ì²«ìˆ˜ì—…: ' + enroll.first_lesson_date + ' | ì¢…ë£Œ: ' + enroll.end_date + '</div>';
      html += '<div style="font-size: 0.85rem; color: #667eea; font-weight: 600; margin-top: 5px;">' + enroll.price.toLocaleString() + 'ì› (' + enroll.months + 'ê°œì›”/' + enroll.lessons + 'íšŒ)</div>';
      html += '</div>';
      html += '<button onclick="removeEnrollment(' + index + ')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">ì‚­ì œ</button>';
      html += '</div></div>';
    });
    html += '</div>';

    listDiv.innerHTML = html;
  }

  // ê³¼ëª© ì‚­ì œ
  window.removeEnrollment = function(index) {
    enrollments.splice(index, 1);
    updateEnrollmentList();
    updatePaymentSection();
  };

  // ê²°ì œ ì„¹ì…˜ ì—…ë°ì´íŠ¸
  function updatePaymentSection() {
    if (enrollments.length === 0) {
      document.getElementById('payment-section').innerHTML = '';
      return;
    }

    const totalPrice = enrollments.reduce((sum, e) => sum + e.price, 0);

    let html = '<h4 style="font-weight: 600; margin-bottom: 15px;">ê²°ì œ ì •ë³´</h4>';

    // í• ì¸ ì„ íƒ
    html += '<div style="margin-bottom: 20px;">';
    html += '<div style="font-weight: 600; margin-bottom: 10px;">í• ì¸ ì ìš©</div>';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
    html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="text_review" value="30000"> ê¸€ í›„ê¸° (-3ë§Œì›)</label>';
    html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="video_review" value="30000"> ì˜ìƒ í›„ê¸° (-3ë§Œì›)</label>';
    html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="referral" value="50000"> ì¹œêµ¬ ì¶”ì²œ (-5ë§Œì›)</label>';
    if (enrollments.length >= 2) {
      html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="bundle_2" value="50000"> 2ê³¼ëª© ë¬¶ìŒ (-5ë§Œì›)</label>';
    }
    if (enrollments.length >= 3) {
      html += '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" class="discount-checkbox" data-discount="bundle_3" value="100000"> 3ê³¼ëª© ë¬¶ìŒ (-10ë§Œì›)</label>';
    }
    html += '</div></div>';

    // ê²°ì œì¼
    html += '<div style="margin-bottom: 20px;">';
    html += '<label style="display: block; font-weight: 600; margin-bottom: 8px;">ê²°ì œì¼</label>';
    html += '<input type="date" id="payment-date" value="' + new Date().toISOString().split('T')[0] + '" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">';
    html += '</div>';

    // ê¸ˆì•¡ ìš”ì•½
    html += '<div id="payment-summary" style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">';
    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span>ê¸°ë³¸ ê¸ˆì•¡</span><span id="base-price">' + totalPrice.toLocaleString() + 'ì›</span></div>';
    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #ef4444;"><span>í• ì¸</span><span id="discount-price">0ì›</span></div>';
    html += '<div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.1rem; padding-top: 10px; border-top: 2px solid #e2e8f0;"><span>ìµœì¢… ê¸ˆì•¡</span><span id="final-price" style="color: #667eea;">' + totalPrice.toLocaleString() + 'ì›</span></div>';
    html += '</div>';

    // ê²°ì œ ë²„íŠ¼
    html += '<button onclick="processPayment()" style="width: 100%; margin-top: 20px; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">ê²°ì œ ì™„ë£Œ</button>';

    document.getElementById('payment-section').innerHTML = html;

    // í• ì¸ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.querySelectorAll('.discount-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', calculateFinalPrice);
    });
  }

  // ìµœì¢… ê¸ˆì•¡ ê³„ì‚°
  function calculateFinalPrice() {
    const totalPrice = enrollments.reduce((sum, e) => sum + e.price, 0);
    let totalDiscount = 0;

    document.querySelectorAll('.discount-checkbox:checked').forEach(checkbox => {
      totalDiscount += parseInt(checkbox.value);
    });

    const finalPrice = Math.max(0, totalPrice - totalDiscount);

    document.getElementById('base-price').textContent = totalPrice.toLocaleString() + 'ì›';
    document.getElementById('discount-price').textContent = '-' + totalDiscount.toLocaleString() + 'ì›';
    document.getElementById('final-price').textContent = finalPrice.toLocaleString() + 'ì›';
  }

  // ê²°ì œ ì²˜ë¦¬
  window.processPayment = function() {
    if (enrollments.length === 0) {
      alert('ë“±ë¡í•  ê³¼ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
      return;
    }

    const paymentDate = document.getElementById('payment-date').value;
    if (!paymentDate) {
      alert('ê²°ì œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // í• ì¸ ì •ë³´ ìˆ˜ì§‘
    const selectedDiscounts = [];
    document.querySelectorAll('.discount-checkbox:checked').forEach(checkbox => {
      selectedDiscounts.push(checkbox.getAttribute('data-discount'));
    });

    const totalPrice = enrollments.reduce((sum, e) => sum + e.price, 0);
    let totalDiscount = 0;
    selectedDiscounts.forEach(discountKey => {
      totalDiscount += DISCOUNTS[discountKey];
    });
    const finalPrice = Math.max(0, totalPrice - totalDiscount);

    // ì„œë²„ì— ì „ì†¡
    fetch('/admin/process_payment', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: currentUserId,
        enrollments: enrollments,
        payment_date: paymentDate,
        discounts: selectedDiscounts,
        total_price: totalPrice,
        discount_amount: totalDiscount,
        final_price: finalPrice
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        closePaymentModal();
        window.loadPaymentsTab(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        alert('ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  };

  // ê²°ì œ ì´ë ¥ ë³´ê¸°
  window.showPaymentHistory = function(userId) {
    fetch(`/admin/payment_history/${userId}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('payment-history-user-name').textContent = data.user_name + ' - ê²°ì œ ì´ë ¥';

        const listDiv = document.getElementById('payment-history-list');
        if (data.payments.length === 0) {
          listDiv.innerHTML = '<div class="payment-history-empty">ê²°ì œ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
          let html = '';
          data.payments.forEach(payment => {
            html += '<div class="payment-history-item">';
            html += '<div class="payment-history-date">' + payment.payment_date + '</div>';
            html += '<div class="payment-history-details">';
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ê³¼ëª©</span><span>' + payment.subject + '</span></div>';
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ì„ ìƒë‹˜</span><span>' + payment.teacher + '</span></div>';
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ê¸°ê°„</span><span>' + payment.months + 'ê°œì›” (' + payment.lessons + 'íšŒ)</span></div>';
            if (payment.first_lesson_date && payment.first_lesson_time) {
              html += '<div class="payment-history-detail-row"><span class="payment-history-label">ì²«ìˆ˜ì—…</span><span>' + payment.first_lesson_date + ' ' + payment.first_lesson_time + '</span></div>';
            }
            html += '<div class="payment-history-detail-row"><span class="payment-history-label">ê¸ˆì•¡</span><span>' + payment.amount.toLocaleString() + 'ì›</span></div>';
            if (payment.discount_amount > 0) {
              html += '<div class="payment-history-detail-row"><span class="payment-history-label">í• ì¸</span><span style="color: #ef4444;">-' + payment.discount_amount.toLocaleString() + 'ì›</span></div>';
            }
            html += '</div></div>';
          });
          listDiv.innerHTML = html;
        }

        document.getElementById('payment-history-modal').style.display = 'flex';
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ê²°ì œ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  };

  // ê²°ì œ ì´ë ¥ ëª¨ë‹¬ ë‹«ê¸°
  window.closePaymentHistoryModal = function(event) {
    if (!event || event.target.id === 'payment-history-modal') {
      document.getElementById('payment-history-modal').style.display = 'none';
    }
  };

  // ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
  window.openEnrollmentModal = function(userId) {
    const enrollmentData = document.getElementById('enrollment-data-' + userId);
    if (!enrollmentData) return;

    const items = enrollmentData.querySelectorAll('.enrollment-item');
    let html = '';

    items.forEach(item => {
      const id = item.getAttribute('data-id');
      const subject = item.getAttribute('data-subject');
      const teacher = item.getAttribute('data-teacher');
      const day = item.getAttribute('data-day');
      const time = item.getAttribute('data-time');
      const status = item.getAttribute('data-status');

      html += '<div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0;">';
      html += '<div style="font-weight: 600; margin-bottom: 8px;">' + subject + ' - ' + teacher + '</div>';
      html += '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 10px;">' + day + ' ' + time + '</div>';
      html += '<button onclick="toggleEnrollmentStatus(' + id + ', \'' + status + '\', \'' + teacher + '\')" style="padding: 8px 16px; background: ' + (status === 'on_leave' ? '#f59e0b' : '#10b981') + '; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">';
      html += (status === 'on_leave' ? 'íœ´ì› í•´ì œ' : 'íœ´ì› ì²˜ë¦¬') + '</button>';
      html += '</div>';
    });

    document.getElementById('enrollment-manage-list').innerHTML = html;
    document.getElementById('enrollment-manage-modal').style.display = 'flex';
  };

  // ê³¼ëª©ë³„ íœ´ì› ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
  window.closeEnrollmentManageModal = function(event) {
    if (!event || event.target.id === 'enrollment-manage-modal') {
      document.getElementById('enrollment-manage-modal').style.display = 'none';
    }
  };

  // ê³¼ëª©ë³„ íœ´ì› ìƒíƒœ í† ê¸€
  window.toggleEnrollmentStatus = function(enrollmentId, currentStatus, teacher) {
    const newStatus = currentStatus === 'on_leave' ? 'active' : 'on_leave';

    // íœ´ì› í•´ì œ ì‹œ ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
    if (currentStatus === 'on_leave') {
      window.showScheduleSelectModal(enrollmentId, teacher);
    } else {
      // íœ´ì› ì²˜ë¦¬ (ê·¸ëƒ¥ ìƒíƒœë§Œ ë³€ê²½)
      fetch(`/admin/user_enrollments/${enrollmentId}/toggle_status`, {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('íœ´ì› ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeEnrollmentManageModal();
          window.loadPaymentsTab();
        } else {
          alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }
  };

  // ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ (íœ´ì› í•´ì œìš©)
  window.showScheduleSelectModal = function(enrollmentId, teacher) {
    window.currentEnrollmentId = enrollmentId;
    window.currentTeacher = teacher;

    // ì‹œê°„í‘œ í˜„í™© ê°€ì ¸ì˜¤ê¸°
    fetch(`/admin/teacher_schedule_availability?teacher=${encodeURIComponent(teacher)}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderScheduleSelectModal(data.availability, data.holidays);
          document.getElementById('schedule-select-modal').style.display = 'flex';
        } else {
          alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      });
  };

  // ì‹œê°„í‘œ ì„ íƒ ëª¨ë‹¬ ë Œë”ë§
  function renderScheduleSelectModal(availability, holidays) {
    const modalContent = document.getElementById('schedule-select-content');
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const dayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
    const timeSlots = ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'];

    let html = '<table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr><th style="border: 1px solid #e5e7eb; padding: 0.5rem;">ì‹œê°„</th>';
    days.forEach((day, idx) => {
      html += `<th style="border: 1px solid #e5e7eb; padding: 0.5rem;">${dayNames[idx]}</th>`;
    });
    html += '</tr></thead><tbody>';

    timeSlots.forEach(timeSlot => {
      html += '<tr>';
      html += `<td style="border: 1px solid #e5e7eb; padding: 0.5rem; text-align: center; font-weight: 600;">${timeSlot.replace('-', ':00-')}:00</td>`;

      days.forEach((day, idx) => {
        const slot = availability[day][timeSlot];
        const isHoliday = holidays.includes(idx === 6 ? 0 : idx + 1); // ë°°ì—´ ì¸ë±ìŠ¤ ì¡°ì •

        let style = 'border: 1px solid #e5e7eb; padding: 0.5rem; text-align: center; cursor: pointer;';
        let onclick = '';
        let text = `${slot.current}/3`;

        if (isHoliday || !slot.available) {
          style += ' background: #f3f4f6; color: #9ca3af; cursor: not-allowed;';
          if (isHoliday) text = 'íœ´ë¬´';
        } else {
          style += ' background: #dbeafe; color: #1e40af;';
          onclick = `onclick="selectScheduleSlot('${day}', '${timeSlot}')"`;
        }

        html += `<td style="${style}" ${onclick}>${text}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    modalContent.innerHTML = html;
  }

  // ì‹œê°„ëŒ€ ì„ íƒ
  window.selectScheduleSlot = function(day, timeSlot) {
    if (!confirm(`${day} ${timeSlot} ì‹œê°„ëŒ€ë¡œ ë³µê·€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    fetch(`/admin/user_enrollments/${window.currentEnrollmentId}/toggle_status`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        status: 'active',
        day: day,
        time_slot: timeSlot
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('ë³µê·€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById('schedule-select-modal').style.display = 'none';
        closeEnrollmentManageModal();
        window.loadPaymentsTab();
      } else {
        alert('ë³µê·€ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ë³µê·€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  };

  window.closeScheduleSelectModal = function() {
    document.getElementById('schedule-select-modal').style.display = 'none';
  };

  console.log('ê²°ì œê´€ë¦¬ JavaScript ë¡œë“œ ì™„ë£Œ');
})();
</script>
