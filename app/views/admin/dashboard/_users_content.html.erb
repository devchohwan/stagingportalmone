<div class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <h2 class="text-2xl font-bold mb-6">통합 회원 관리</h2>
    
    <!-- 탭 선택 -->
    <div class="flex gap-4 mb-4 border-b">
      <button onclick="changeTab('approved')"
              class="tab-btn <%= 'active' if @tab == 'approved' %> pb-2 px-1">
        승인된 회원
      </button>
      <button onclick="changeTab('waiting')"
              class="tab-btn <%= 'active' if @tab == 'waiting' %> pb-2 px-1">
        승인 대기
      </button>
      <button onclick="changeTab('hold')"
              class="tab-btn <%= 'active' if @tab == 'hold' %> pb-2 px-1">
        보류
      </button>
      <button onclick="changeTab('penalty')"
              class="tab-btn <%= 'active' if @tab == 'penalty' %> pb-2 px-1">
        페널티
      </button>
    </div>
    
    <!-- 검색 및 필터 기능 -->
    <div class="mb-4 flex gap-2">
      <input type="text" 
             id="user-search" 
             placeholder="이름이나 아이디로 검색..." 
             class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent"
             onkeyup="searchUsers()">
      
      <select id="system-filter"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-transparent"
              onchange="filterBySystem()">
        <option value="">전체 시스템</option>
        <option value="practice">연습실</option>
        <option value="makeup">보충수업</option>
      </select>
    </div>
    
    <!-- 승인 대기 탭 -->
    <% if @tab == 'waiting' && @pending_users.any? %>
      <div class="bg-white rounded-lg shadow">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">아이디</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">전화번호</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">담당</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">가입일</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">작업</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 user-table-body">
            <% @pending_users.each do |user| %>
              <tr class="user-row bg-yellow-50" data-name="<%= user['name'] %>" data-username="<%= user['username'] %>" data-system="<%= user['system'] || 'practice' %>">
                <td class="px-4 py-2 text-sm font-medium"><%= user['name'] %></td>
                <td class="px-4 py-2 text-sm"><%= user['username'] %></td>
                <td class="px-4 py-2">
                  <input type="tel" 
                         id="phone-pending-<%= user['id'] %>"
                         value="<%= user['phone'] || '' %>" 
                         placeholder="미등록"
                         class="text-sm px-2 py-0.5 border border-gray-300 rounded w-24">
                  <button onclick="updatePhone(<%= user['id'] %>, 'pending', '<%= user['system'] %>')" 
                          class="text-xs px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700 cursor-pointer">확인</button>
                </td>
                <td class="px-4 py-2">
                  <select onchange="updateTeacher(<%= user['id'] %>, this.value, '<%= user['system'] %>')" 
                          class="text-xs px-2 py-1 border border-gray-300 rounded">
                    <% ['무성', '성균', '노네임', '로한', '범석', '두박', '오또', '지명', '도현'].each do |teacher| %>
                      <option value="<%= teacher %>" <%= 'selected' if user['teacher'] == teacher %>><%= teacher %></option>
                    <% end %>
                  </select>
                </td>
                <td class="px-4 py-2 text-xs text-gray-500"><%= DateTime.parse(user['created_at']).strftime('%Y-%m-%d %H:%M') %></td>
                <td class="px-4 py-2">
                  <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">대기중</span>
                </td>
                <td class="px-4 py-2">
                  <button onclick="approveUser(<%= user['id'] %>, '<%= user['system'] %>')" 
                          class="text-green-600 hover:text-green-800 text-sm cursor-pointer mr-2">승인</button>
                  <button onclick="holdUser(<%= user['id'] %>, '<%= user['system'] %>')"
                          class="text-orange-600 hover:text-orange-800 text-sm cursor-pointer mr-2">보류</button>
                  <button onclick="rejectUser(<%= user['id'] %>, '<%= user['system'] %>')"
                          class="text-red-600 hover:text-red-800 text-sm cursor-pointer">거부</button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- 보류 탭 -->
    <% if @tab == 'hold' && @on_hold_users.any? %>
      <div class="bg-white rounded-lg shadow">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">아이디</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">전화번호</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">담당</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">가입일</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">작업</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 user-table-body">
            <% @on_hold_users.each do |user| %>
              <tr class="user-row bg-orange-50" data-name="<%= user['name'] %>" data-username="<%= user['username'] %>" data-system="<%= user['system'] || 'practice' %>">
                <td class="px-4 py-2 text-sm font-medium"><%= user['name'] %></td>
                <td class="px-4 py-2 text-sm"><%= user['username'] %></td>
                <td class="px-4 py-2">
                  <input type="tel" 
                         id="phone-hold-<%= user['id'] %>"
                         value="<%= user['phone'] || '' %>" 
                         placeholder="미등록"
                         class="text-sm px-2 py-0.5 border border-gray-300 rounded w-24">
                  <button onclick="updatePhone(<%= user['id'] %>, 'hold', '<%= user['system'] %>')" 
                          class="text-xs px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700 cursor-pointer">확인</button>
                </td>
                <td class="px-4 py-2">
                  <select onchange="updateTeacher(<%= user['id'] %>, this.value, '<%= user['system'] %>')" 
                          class="text-xs px-2 py-1 border border-gray-300 rounded">
                    <% ['무성', '성균', '노네임', '로한', '범석', '두박', '오또', '지명', '도현'].each do |teacher| %>
                      <option value="<%= teacher %>" <%= 'selected' if user['teacher'] == teacher %>><%= teacher %></option>
                    <% end %>
                  </select>
                </td>
                <td class="px-4 py-2 text-xs text-gray-500"><%= DateTime.parse(user['created_at']).strftime('%Y-%m-%d %H:%M') %></td>
                <td class="px-4 py-2">
                  <span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">보류중</span>
                </td>
                <td class="px-4 py-2">
                  <button onclick="approveUser(<%= user['id'] %>, '<%= user['system'] %>')" 
                          class="text-green-600 hover:text-green-800 text-sm cursor-pointer mr-2">승인</button>
                  <button onclick="rejectUser(<%= user['id'] %>, '<%= user['system'] %>')" 
                          class="text-red-600 hover:text-red-800 text-sm cursor-pointer">삭제</button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- 승인된 회원 탭 -->
    <% if @tab == 'approved' %>
      <div class="bg-white rounded-lg shadow">
        <table class="w-full">
          <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">아이디</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">전화번호</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">담당</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">노쇼</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">취소</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">차단</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">비밀번호</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">삭제</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 user-table-body">
        <% @approved_users.each do |user| %>
          <tr class="user-row" data-name="<%= user['name'] %>" data-username="<%= user['username'] %>" data-system="<%= user['system'] || 'practice' %>">
            <td class="px-4 py-2 text-sm">
              <%= user['name'] %>
              <% if user['is_admin'] %>
                <span class="text-xs bg-violet-100 text-violet-800 px-2 py-0.5 rounded-full ml-2">관리자</span>
              <% end %>
            </td>
            <td class="px-4 py-2 text-sm"><%= user['username'] %></td>
            <td class="px-4 py-2">
              <input type="tel" 
                     id="phone-approved-<%= user['id'] %>"
                     value="<%= user['phone'] || '' %>" 
                     placeholder="-"
                     class="text-sm px-2 py-0.5 border border-gray-300 rounded w-24">
              <button onclick="updatePhone(<%= user['id'] %>, 'approved', '<%= user['system'] %>')" 
                      class="text-xs px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700 cursor-pointer">확인</button>
            </td>
            <td class="px-4 py-2">
              <select onchange="updateTeacher(<%= user['id'] %>, this.value, '<%= user['system'] %>')" 
                      class="text-xs px-2 py-1 border border-gray-300 rounded">
                <% ['무성', '성균', '노네임', '로한', '범석', '두박', '오또', '지명', '도현'].each do |teacher| %>
                  <option value="<%= teacher %>" <%= 'selected' if user['teacher'] == teacher %>><%= teacher %></option>
                <% end %>
              </select>
            </td>
            <td class="px-4 py-2 text-sm"><%= user['no_show_count'] || 0 %></td>
            <td class="px-4 py-2 text-sm"><%= user['cancel_count'] || 0 %></td>
            <td class="px-4 py-2 text-sm">
              <% if user['is_blocked'] %>
                <span class="text-red-600">차단됨</span>
              <% else %>
                -
              <% end %>
            </td>
            <td class="px-4 py-2">
              <button onclick="resetPassword('<%= user['id'] %>', '<%= user['username'] %>', '<%= user['system'] %>')" 
                      class="text-blue-600 hover:text-blue-800 text-sm cursor-pointer">재설정</button>
            </td>
            <td class="px-4 py-2">
              <% unless user['is_admin'] %>
                <button onclick="holdUser(<%= user['id'] %>)" 
                        class="btn-hold-orange mr-2">보류</button>
                <button onclick="deleteUser(<%= user['id'] %>, '<%= user['system'] %>')" 
                        class="text-red-600 hover:text-red-800 text-sm cursor-pointer">삭제</button>
              <% else %>
                <span class="text-xs text-gray-400">-</span>
              <% end %>
            </td>
          </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- 페널티 탭 -->
    <% if @tab == 'penalty' && @users_with_penalties&.any? %>
      <div class="bg-white rounded-lg shadow">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">아이디</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">시스템</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">담당</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">노쇼</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">취소</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">총횟수</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">관리</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 user-table-body">
            <% @users_with_penalties.each do |user| %>
              <% total_count = user['no_show_count'] + user['cancel_count'] %>
              <% is_blocked = user['is_blocked'] || (user['no_show_count'] >= 3) %>
              <tr class="user-row <%= 'bg-red-50' if is_blocked %>" data-name="<%= user['name'] %>" data-username="<%= user['username'] %>" data-system="<%= user['system'] || 'practice' %>">
                <td class="px-4 py-2 text-sm font-medium"><%= user['name'] %></td>
                <td class="px-4 py-2 text-sm"><%= user['username'] %></td>
                <td class="px-4 py-2 text-sm">
                  <% if user['system'] == 'makeup' %>
                    <span class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded">보충수업</span>
                  <% else %>
                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">연습실</span>
                  <% end %>
                </td>
                <td class="px-4 py-2 text-sm"><%= user['teacher'] %></td>
                <td class="px-4 py-2 text-center">
                  <span class="text-lg font-semibold <%= user['no_show_count'] > 0 ? 'text-red-600' : 'text-gray-400' %>">
                    <%= user['no_show_count'] %>
                  </span>
                </td>
                <td class="px-4 py-2 text-center">
                  <span class="text-lg font-semibold <%= user['cancel_count'] > 0 ? 'text-yellow-600' : 'text-gray-400' %>">
                    <%= user['cancel_count'] %>
                  </span>
                </td>
                <td class="px-4 py-2 text-center">
                  <span class="text-lg font-bold <%= total_count >= 5 ? 'text-red-600' : (total_count >= 3 ? 'text-orange-600' : 'text-gray-900') %>">
                    <%= total_count %>
                  </span>
                </td>
                <td class="px-4 py-2">
                  <% if is_blocked %>
                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">차단됨</span>
                  <% elsif total_count >= 3 %>
                    <span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">주의</span>
                  <% else %>
                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">정상</span>
                  <% end %>
                </td>
                <td class="px-4 py-2">
                  <button onclick="resetPenalty(<%= user['id'] %>, '<%= user['system'] %>')" 
                          class="text-violet-600 hover:text-violet-900 font-medium cursor-pointer">
                    초기화
                  </button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- 승인 대기 탭 -->
    <% if @tab == 'waiting' %>
      <% if @pending_users.empty? %>
        <p class="text-gray-500">승인 대기 중인 회원이 없습니다.</p>
      <% end %>
    <% end %>
    
    <!-- 보류 탭 -->
    <% if @tab == 'hold' %>
      <% if @on_hold_users.empty? %>
        <p class="text-gray-500">보류 중인 회원이 없습니다.</p>
      <% end %>
    <% end %>
    
    <!-- 페널티 탭 -->
    <% if @tab == 'penalty' %>
      <% if @users_with_penalties.nil? || @users_with_penalties.empty? %>
        <p class="text-gray-500">페널티가 있는 회원이 없습니다.</p>
      <% end %>
    <% end %>
  </div>
</div>

<style>
.tab-btn {
  color: #666;
  font-weight: normal;
  border-bottom: 2px solid transparent;
  cursor: pointer;
}
.tab-btn.active {
  color: #7c3aed;
  font-weight: bold;
  border-bottom: 2px solid #7c3aed;
}
.tab-btn:hover {
  color: #7c3aed;
}

.btn-approve {
  background-color: #16a34a;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}
.btn-approve:hover {
  background-color: #15803d;
}

.btn-hold {
  background-color: #f97316;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}
.btn-hold:hover {
  background-color: #ea580c;
}

.btn-reject {
  background-color: #ef4444;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}
.btn-reject:hover {
  background-color: #dc2626;
}

.link-hold {
  color: #f97316;
  font-size: 14px;
}
.link-hold:hover {
  color: #ea580c;
  cursor: pointer;
}

.btn-hold-orange {
  color: #f97316;
  font-size: 14px;
}
.btn-hold-orange:hover {
  color: #ea580c;
  cursor: pointer;
}
</style>