<style>
  /* ì „ì²´ ì»¨í…Œì´ë„ˆ - ê³ ìœ  í´ë˜ìŠ¤ë¡œ CSS ê²©ë¦¬ */
  .schedule-manager-wrapper {
    min-height: 100vh;
    background: #f9fafb;
    padding: 1.5rem;
  }

  .schedule-manager-wrapper .header-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-manager-wrapper .header-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #667eea;
  }

  .schedule-manager-wrapper .tabs-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-manager-wrapper .teacher-tab {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .schedule-manager-wrapper .teacher-tab.active {
    background: #667eea;
    color: white;
  }

  .schedule-manager-wrapper .teacher-tab:not(.active) {
    background: #e5e7eb;
    color: #374151;
  }

  .schedule-manager-wrapper .teacher-tab:not(.active):hover {
    background: #d1d5db;
  }

  .schedule-manager-wrapper .nav-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .schedule-manager-wrapper .nav-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .schedule-manager-wrapper .nav-btn:hover {
    background: #5568d3;
  }

  .schedule-manager-wrapper .table-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .schedule-manager-wrapper table {
    width: auto;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .schedule-manager-wrapper th {
    background: #667eea;
    color: white;
    font-weight: 700;
    padding: 0.75rem;
    border: 1px solid white;
    text-align: center;
    width: 140px;
  }

  .schedule-manager-wrapper th:first-child {
    width: 80px;
  }

  .schedule-manager-wrapper td {
    border: 1px solid #e5e7eb;
    width: 140px;
    vertical-align: top;
    background: white;
    padding: 0;
  }

  .schedule-manager-wrapper .time-cell {
    background: #f9fafb;
    font-weight: 700;
    text-align: center;
    padding: 0.75rem;
    position: sticky;
    left: 0;
    z-index: 10;
    width: 80px;
  }

  .schedule-manager-wrapper .schedule-cell {
    min-height: 160px;
    display: flex;
    flex-direction: column;
  }

  .schedule-manager-wrapper .cell-header {
    display: flex;
    justify-content: flex-end;
    padding: 0.5rem;
    background: linear-gradient(to bottom, rgba(102, 126, 234, 0.04), transparent);
    border-bottom: 1px solid #f3f4f6;
  }

  .schedule-manager-wrapper .add-btn {
    width: 24px;
    height: 24px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .schedule-manager-wrapper .add-btn:hover {
    background: #5568d3;
    transform: scale(1.1);
  }

  .schedule-manager-wrapper .students-area {
    flex: 1;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .schedule-manager-wrapper .students-area.empty {
    justify-content: center;
    align-items: center;
    color: #9ca3af;
    font-size: 0.75rem;
    cursor: pointer;
  }

  .schedule-manager-wrapper .students-area.empty:hover {
    background: rgba(102, 126, 234, 0.03);
    color: #667eea;
  }

  .schedule-manager-wrapper .schedule-cell.holiday {
    background: repeating-linear-gradient(
      45deg,
      #f9fafb,
      #f9fafb 10px,
      #f3f4f6 10px,
      #f3f4f6 20px
    );
    opacity: 0.6;
  }

  .schedule-manager-wrapper .schedule-cell.holiday .add-btn,
  .schedule-manager-wrapper .schedule-cell.holiday .students-area {
    pointer-events: none;
    opacity: 0.5;
  }

  .schedule-manager-wrapper .schedule-cell.holiday .students-area.empty::before {
    content: 'ğŸš« íœ´ë¬´ì¼';
    display: block;
    text-align: center;
    color: #9ca3af;
    font-size: 0.75rem;
  }

  .schedule-manager-wrapper .schedule-cell.holiday .students-area.empty {
    cursor: not-allowed;
  }

  .schedule-manager-wrapper .student-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 0.5rem;
    transition: all 0.2s;
    cursor: move;
  }

  .schedule-manager-wrapper .student-card:hover {
    border-color: #667eea;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
  }

  .schedule-manager-wrapper .student-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
  }

  /* ìŠ¤ì¼€ì¤„ í•´ì œ ì˜ì—­ */
  .unschedule-zone {
    border: 3px dashed #d1d5db;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background: #f9fafb;
    transition: all 0.3s;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .unschedule-zone.drag-over {
    border-color: #ef4444;
    background: #fee2e2;
  }

  .unschedule-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
  }

  .unschedule-text {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 5px;
  }

  .unschedule-subtext {
    font-size: 0.85rem;
    color: #9ca3af;
  }

  .students-area.drag-over {
    background: #dbeafe !important;
    border: 2px dashed #3b82f6 !important;
  }

  /* ëª¨ë‹¬ - ì™„ì „ ê²©ë¦¬ */
  .schedule-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999 !important;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
  }

  .schedule-modal-overlay.show {
    display: flex !important;
  }

  .schedule-modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
  }

  .schedule-modal-header {
    background: #667eea;
    color: white;
    padding: 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .schedule-modal-header h3 {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0;
  }

  .schedule-modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .schedule-modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .schedule-modal-body {
    padding: 1.25rem;
  }

  .schedule-modal-body label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .schedule-modal-body input {
    width: 100%;
    padding: 0.625rem;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: all 0.2s;
    box-sizing: border-box;
  }

  .schedule-modal-body input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .schedule-search-results {
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
  }

  .schedule-search-item {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.2s;
  }

  .schedule-search-item:last-child {
    border-bottom: none;
  }

  .schedule-search-item:hover {
    background: #f3f4f6;
  }

  .schedule-search-empty {
    padding: 2rem;
    text-align: center;
    color: #9ca3af;
    font-size: 0.875rem;
  }

  /* ë¡œë”© */
  .schedule-loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999 !important;
    align-items: center;
    justify-content: center;
  }

  .schedule-loading-overlay.show {
    display: flex !important;
  }

  .schedule-loading-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
  }

  .schedule-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<div class="schedule-manager-wrapper">
  <div class="max-w-7xl mx-auto">
    <!-- í—¤ë” -->
    <div class="header-card">
      <h2 class="header-title">ğŸµ ì‹œê°„í‘œ ê´€ë¦¬</h2>
      <p class="text-sm text-gray-600 mt-1">ìˆ˜ê°•ìƒì„ ì‹œê°„í‘œì— ë°°ì¹˜í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
    </div>

    <!-- ì„ ìƒë‹˜ íƒ­ -->
    <div class="tabs-card">
      <div style="display: flex; gap: 0.5rem; overflow-x: auto;">
        <% @teachers.each_with_index do |teacher, index| %>
          <button
            onclick="switchScheduleTeacher('<%= teacher %>')"
            data-teacher="<%= teacher %>"
            class="teacher-tab <%= index == 0 ? 'active' : '' %>">
            ğŸ‘¨â€ğŸ« <%= teacher %>
          </button>
        <% end %>
      </div>
    </div>

    <!-- ì£¼ì°¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="nav-card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <button onclick="changeScheduleWeek(-1)" class="nav-btn">â† ì´ì „ ì£¼</button>
        <div style="text-align: center;">
          <div id="schedule-week-display" style="font-size: 1.125rem; font-weight: 700;"></div>
          <div id="schedule-date-range" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;"></div>
        </div>
        <button onclick="changeScheduleWeek(1)" class="nav-btn">ë‹¤ìŒ ì£¼ â†’</button>
      </div>
    </div>

    <!-- ì‹œê°„í‘œ í…Œì´ë¸” -->
    <div class="table-container">
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th class="time-cell" style="position: sticky; left: 0; z-index: 20;">ì‹œê°„</th>
              <% ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].each_with_index do |day_name, index| %>
                <th>
                  <%= day_name %>
                  <div id="date-<%= ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'][index] %>" style="font-size: 0.75rem; font-weight: 400; opacity: 0.9; margin-top: 0.25rem;"></div>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'].each do |time_slot| %>
              <tr>
                <td class="time-cell"><%= time_slot.split('-').join(':00-') + ':00' %></td>
                <% ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].each do |day| %>
                  <td>
                    <div id="cell-<%= day %>-<%= time_slot %>" class="schedule-cell">
                      <div class="cell-header">
                        <button onclick="showAddStudentModal('<%= day %>', '<%= time_slot %>')" class="add-btn" title="í•™ìƒ ì¶”ê°€">+</button>
                      </div>
                      <div class="students-area empty" data-day="<%= day %>" data-time="<%= time_slot %>">
                        í´ë¦­í•˜ì—¬ ì¶”ê°€
                      </div>
                    </div>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ìŠ¤ì¼€ì¤„ í•´ì œ ì˜ì—­ (ë“œë˜ê·¸ì•¤ë“œë¡­) -->
  <div class="schedule-manager-wrapper">
    <div class="header-card" style="margin-top: 1.5rem;">
      <div id="unschedule-dropzone" class="unschedule-zone">
        <div class="unschedule-icon">ğŸ—‘ï¸</div>
        <div class="unschedule-text">ì—¬ê¸°ì— íšŒì›ì„ ë“œë¡­í•˜ë©´ ìŠ¤ì¼€ì¤„ì´ í•´ì œë©ë‹ˆë‹¤</div>
        <div class="unschedule-subtext">ê²°ì œ ë° ìˆ˜ì—… ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤</div>
      </div>
    </div>
  </div>
</div>

<!-- í•™ìƒ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="add-student-modal" class="schedule-modal-overlay">
  <div class="schedule-modal-content">
    <div class="schedule-modal-header">
      <h3>ğŸ‘¨â€ğŸ“ ìˆ˜ê°•ìƒ ì¶”ê°€</h3>
      <button onclick="closeAddStudentModal()" class="schedule-modal-close">&times;</button>
    </div>
    <div class="schedule-modal-body">
      <label>ğŸ” ìˆ˜ê°•ìƒ ê²€ìƒ‰</label>
      <input
        type="text"
        id="modal-student-search"
        placeholder="ì´ë¦„ ë˜ëŠ” ì•„ì´ë””ë¡œ ê²€ìƒ‰..."
        onkeyup="searchStudentsInModal(this.value)">
      <div id="modal-search-results" class="schedule-search-results">
        <div class="schedule-search-empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
      </div>
    </div>
  </div>
</div>

<!-- íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
<div id="student-detail-modal" class="schedule-modal-overlay">
  <div class="schedule-modal-content" style="max-width: 800px;">
    <div class="schedule-modal-header">
      <h3 id="student-detail-title">ğŸ‘¨â€ğŸ“ íšŒì› ìƒì„¸ ì •ë³´</h3>
      <button onclick="closeStudentDetailModal()" class="schedule-modal-close">&times;</button>
    </div>
    <div class="schedule-modal-body" style="max-height: 70vh; overflow-y: auto;">
      <div id="student-detail-content">
        <div style="text-align: center; padding: 20px; color: #9ca3af;">ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>
</div>

<!-- ë¡œë”© -->
<div id="schedule-loading" class="schedule-loading-overlay">
  <div class="schedule-loading-content">
    <div class="schedule-spinner"></div>
    <p style="margin-top: 1rem; font-weight: 600; color: #374151;">ì²˜ë¦¬ ì¤‘...</p>
  </div>
</div>

<script>
(function() {
  window.currentScheduleTeacher = '<%= @teachers.first %>';
  window.currentScheduleWeek = 0;
  window.scheduleData = {};
  window.modalTargetDay = '';
  window.modalTargetTime = '';
  window.modalSearchTimeout = null;
  window.teacherHolidays = <%= raw @teacher_holidays.to_json %>;

  window.switchScheduleTeacher = function(teacher) {
    window.currentScheduleTeacher = teacher;
    document.querySelectorAll('.teacher-tab').forEach(tab => {
      if (tab.dataset.teacher === teacher) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });
    updateHolidayCells();
    loadScheduleData();
  };

  window.changeScheduleWeek = function(offset) {
    window.currentScheduleWeek += offset;
    updateScheduleWeekDisplay();
    loadScheduleData();
  };

  window.isTeacherHoliday = function(teacher, dayOfWeek) {
    const holidays = window.teacherHolidays[teacher] || [];
    return holidays.includes(dayOfWeek);
  };

  window.updateScheduleWeekDisplay = function() {
    const today = new Date();
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay() + (window.currentScheduleWeek * 7));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);

    const weekDisplayEl = document.getElementById('schedule-week-display');
    const dateRangeEl = document.getElementById('schedule-date-range');

    if (weekDisplayEl) {
      weekDisplayEl.textContent = `${weekStart.getFullYear()}ë…„ ${weekStart.getMonth() + 1}ì›” ${weekStart.getDate()}ì¼ ì£¼`;
    }
    if (dateRangeEl) {
      dateRangeEl.textContent = `${weekStart.getMonth() + 1}/${weekStart.getDate()} - ${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`;
    }

    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    days.forEach((day, index) => {
      const dayDate = new Date(weekStart);
      // weekStartëŠ” ì¼ìš”ì¼ì´ë¯€ë¡œ, monì€ +1, tueëŠ” +2, ... sunì€ +7
      dayDate.setDate(weekStart.getDate() + index + 1);
      const dateEl = document.getElementById(`date-${day}`);
      if (dateEl) {
        dateEl.textContent = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
      }
    });

    // íœ´ë¬´ì¼ í‘œì‹œ ì—…ë°ì´íŠ¸
    updateHolidayCells();
  };

  window.updateHolidayCells = function() {
    const today = new Date();
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay() + (window.currentScheduleWeek * 7));

    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    days.forEach((day, index) => {
      const dayDate = new Date(weekStart);
      // weekStartëŠ” ì¼ìš”ì¼ì´ë¯€ë¡œ, monì€ +1, tueëŠ” +2, ... sunì€ +7
      dayDate.setDate(weekStart.getDate() + index + 1);
      const dayOfWeek = dayDate.getDay();

      const isHoliday = isTeacherHoliday(window.currentScheduleTeacher, dayOfWeek);

      // í•´ë‹¹ ìš”ì¼ì˜ ëª¨ë“  ì‹œê°„ëŒ€ ì…€ì— íœ´ë¬´ì¼ í‘œì‹œ
      ['13-14', '14-15', '15-16', '16-17', '17-18', '19-20', '20-21', '21-22'].forEach(timeSlot => {
        const cell = document.getElementById(`cell-${day}-${timeSlot}`);
        if (cell) {
          if (isHoliday) {
            cell.classList.add('holiday');
          } else {
            cell.classList.remove('holiday');
          }
        }
      });
    });
  };

  window.loadScheduleData = async function() {
    showScheduleLoading(true);
    window.scheduleData = {};

    document.querySelectorAll('.students-area').forEach(container => {
      container.innerHTML = 'í´ë¦­í•˜ì—¬ ì¶”ê°€';
      container.classList.add('empty');
    });

    try {
      const response = await fetch(`/admin/load_schedule?teacher=${encodeURIComponent(window.currentScheduleTeacher)}&week_offset=${window.currentScheduleWeek}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();

      if (data.success) {
        renderScheduleData(data.schedules);
      } else {
        alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    } catch (error) {
      console.error('Error loading schedule:', error);
      alert('ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      showScheduleLoading(false);
    }
  };

  window.renderScheduleData = function(schedules) {
    for (const [day, timeSlots] of Object.entries(schedules)) {
      for (const [timeSlot, students] of Object.entries(timeSlots)) {
        if (!window.scheduleData[day]) window.scheduleData[day] = {};
        if (!window.scheduleData[day][timeSlot]) window.scheduleData[day][timeSlot] = [];

        const cell = document.getElementById(`cell-${day}-${timeSlot}`);
        if (!cell) continue;

        const container = cell.querySelector('.students-area');
        if (!container) continue;

        if (students.length > 0) {
          container.classList.remove('empty');
          container.innerHTML = '';
        }

        students.forEach(student => {
          if (!student.is_pass && !student.is_makeup_away && !student.is_makeup && !student.is_absent) {
            window.scheduleData[day][timeSlot].push(student.id);
            const card = createScheduleStudentCard(student, day, timeSlot);
            container.appendChild(card);
          }
        });
      }
    }
  };

  window.createScheduleStudentCard = function(student, day, timeSlot) {
    const card = document.createElement('div');
    card.className = 'student-card';
    card.dataset.userId = student.id;
    card.dataset.currentDay = day;
    card.dataset.currentTimeSlot = timeSlot;
    card.draggable = true;

    // íœ´ì› ìƒíƒœì— ë”°ë¥¸ ë°°ê²½ìƒ‰ ì„¤ì •
    if (student.is_on_leave) {
      card.style.background = '#fef3c7'; // ì—°ë…¸ë‘
      card.style.borderColor = '#fbbf24';
    } else {
      card.style.background = '#d9f99d'; // ì—°ë‘ìƒ‰
      card.style.borderColor = '#84cc16';
    }

    const usernameDiv = document.createElement('div');
    usernameDiv.style.fontSize = '0.875rem';
    usernameDiv.style.color = '#111827';
    usernameDiv.style.fontWeight = '600';
    usernameDiv.style.textAlign = 'center';
    usernameDiv.style.pointerEvents = 'none'; // ë“œë˜ê·¸ ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€

    // íœ´ì› ìƒíƒœ í‘œì‹œ
    if (student.is_on_leave) {
      usernameDiv.textContent = student.username + ' (íœ´ì›)';
    } else {
      usernameDiv.textContent = student.username;
    }

    card.appendChild(usernameDiv);

    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    card.addEventListener('click', function(e) {
      e.stopPropagation();
      showStudentDetailModal(student.id);
    });

    // ë“œë˜ê·¸ ì´ë²¤íŠ¸
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);

    return card;
  };

  window.showAddStudentModal = function(day, timeSlot) {
    const currentCount = window.scheduleData[day]?.[timeSlot]?.length || 0;
    if (currentCount >= 3) {
      alert('ì´ ì‹œê°„ëŒ€ëŠ” ì´ë¯¸ 3ëª…ìœ¼ë¡œ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
      return;
    }

    window.modalTargetDay = day;
    window.modalTargetTime = timeSlot;

    const searchInput = document.getElementById('modal-student-search');
    const searchResults = document.getElementById('modal-search-results');
    const modal = document.getElementById('add-student-modal');

    if (searchInput) searchInput.value = '';
    if (searchResults) searchResults.innerHTML = '<div class="schedule-search-empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
    if (modal) modal.classList.add('show');
  };

  window.closeAddStudentModal = function() {
    const modal = document.getElementById('add-student-modal');
    if (modal) modal.classList.remove('show');
  };

  window.searchStudentsInModal = async function(query) {
    clearTimeout(window.modalSearchTimeout);

    const resultsDiv = document.getElementById('modal-search-results');
    if (!resultsDiv) return;

    if (query.length < 2) {
      resultsDiv.innerHTML = '<div class="schedule-search-empty">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
      return;
    }

    window.modalSearchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/admin/search_students?search=${encodeURIComponent(query)}&teacher=${encodeURIComponent(window.currentScheduleTeacher)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        resultsDiv.innerHTML = '';

        if (data.students && data.students.length > 0) {
          data.students.forEach(student => {
            const item = document.createElement('div');
            item.className = 'schedule-search-item';

            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = '700';
            nameDiv.style.color = '#111827';
            nameDiv.textContent = `ğŸµ ${student.name}`;

            const infoDiv = document.createElement('div');
            infoDiv.style.fontSize = '0.75rem';
            infoDiv.style.color = '#6b7280';
            infoDiv.style.marginTop = '0.25rem';
            infoDiv.textContent = `${student.username} - ${student.teacher}`;

            item.appendChild(nameDiv);
            item.appendChild(infoDiv);
            item.onclick = () => window.addStudentToSchedule(student);
            resultsDiv.appendChild(item);
          });
        } else {
          resultsDiv.innerHTML = '<div class="schedule-search-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }
      } catch (error) {
        console.error('Error searching students:', error);
        resultsDiv.innerHTML = '<div class="schedule-search-empty" style="color: #ef4444;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
      }
    }, 300);
  };

  window.addStudentToSchedule = function(student) {
    const day = window.modalTargetDay;
    const timeSlot = window.modalTargetTime;

    if (window.scheduleData[day]?.[timeSlot]?.includes(student.id)) {
      alert('ì´ë¯¸ ì¶”ê°€ëœ í•™ìƒì…ë‹ˆë‹¤.');
      return;
    }

    if (!window.scheduleData[day]) window.scheduleData[day] = {};
    if (!window.scheduleData[day][timeSlot]) window.scheduleData[day][timeSlot] = [];

    if (window.scheduleData[day][timeSlot].length >= 3) {
      alert('ì´ ì‹œê°„ëŒ€ëŠ” ì´ë¯¸ 3ëª…ìœ¼ë¡œ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
      return;
    }

    window.scheduleData[day][timeSlot].push(student.id);

    const cell = document.getElementById(`cell-${day}-${timeSlot}`);
    const container = cell.querySelector('.students-area');

    if (container) {
      if (container.classList.contains('empty')) {
        container.classList.remove('empty');
        container.innerHTML = '';
      }

      const card = createScheduleStudentCard(student, day, timeSlot);
      container.appendChild(card);
    }

    closeAddStudentModal();

    // ìë™ ì €ì¥
    autoSaveSchedule();
  };

  window.removeStudentFromSchedule = function(userId, day, timeSlot) {
    if (!confirm('ì´ í•™ìƒì„ ì‹œê°„í‘œì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    if (window.scheduleData[day]?.[timeSlot]) {
      window.scheduleData[day][timeSlot] = window.scheduleData[day][timeSlot].filter(id => id !== userId);
    }

    const cell = document.getElementById(`cell-${day}-${timeSlot}`);
    const container = cell.querySelector('.students-area');
    const cards = container ? container.querySelectorAll(`[data-user-id="${userId}"]`) : [];

    cards.forEach(card => card.remove());

    if (container && container.children.length === 0) {
      container.classList.add('empty');
      container.innerHTML = 'í´ë¦­í•˜ì—¬ ì¶”ê°€';
    }

    // ìë™ ì €ì¥
    autoSaveSchedule();
  };

  // ìë™ ì €ì¥ (ë””ë°”ìš´ì‹± ì ìš©)
  let autoSaveTimeout = null;
  window.autoSaveSchedule = function() {
    clearTimeout(autoSaveTimeout);

    autoSaveTimeout = setTimeout(async () => {
      try {
        const response = await fetch('/admin/save_schedule', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({
            teacher: window.currentScheduleTeacher,
            schedules: window.scheduleData
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        if (data.success) {
          console.log('ì‹œê°„í‘œê°€ ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', data.message);
        }
      } catch (error) {
        console.error('Error auto-saving schedule:', error);
      }
    }, 500); // 500ms í›„ ì €ì¥
  };

  window.showScheduleLoading = function(show) {
    const loading = document.getElementById('schedule-loading');
    if (loading) {
      if (show) {
        loading.classList.add('show');
      } else {
        loading.classList.remove('show');
      }
    }
  };

  window.setupEmptyContainerClicks = function() {
    document.querySelectorAll('.students-area').forEach(container => {
      const newContainer = container.cloneNode(true);
      container.parentNode.replaceChild(newContainer, container);

      newContainer.addEventListener('click', function(e) {
        if (e.target.closest('.student-card')) return;

        const day = this.dataset.day;
        const time = this.dataset.time;

        if (day && time) {
          window.showAddStudentModal(day, time);
        }
      });
    });
  };

  // íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
  window.showStudentDetailModal = function(userId) {
    const modal = document.getElementById('student-detail-modal');
    modal.classList.add('show');

    // ë°ì´í„° ë¡œë“œ
    fetch(`/admin/student_detail/${userId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          renderStudentDetail(data);
        } else {
          alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          closeStudentDetailModal();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        closeStudentDetailModal();
      });
  };

  // íšŒì› ìƒì„¸ ì •ë³´ ë Œë”ë§
  function renderStudentDetail(data) {
    const { user, makeup_pass_requests, payments, enrollments, remaining_lessons, remaining_passes } = data;

    document.getElementById('student-detail-title').textContent = `ğŸ‘¨â€ğŸ“ ${user.name} (${user.username})`;

    let html = '';

    // ë‚¨ì€ ìˆ˜ì—…/íŒ¨ìŠ¤ íšŸìˆ˜
    html += '<div style="background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">';
    html += '<div style="display: flex; justify-content: space-around; text-align: center;">';
    html += '<div><div style="font-size: 0.85rem; color: #0369a1; margin-bottom: 5px;">ë‚¨ì€ ìˆ˜ì—…</div>';
    html += `<div style="font-size: 1.5rem; font-weight: 700; color: #0369a1;">${remaining_lessons}íšŒ</div></div>`;
    html += '<div><div style="font-size: 0.85rem; color: #0369a1; margin-bottom: 5px;">ë‚¨ì€ íŒ¨ìŠ¤</div>';
    html += `<div style="font-size: 1.5rem; font-weight: 700; color: #0369a1;">${remaining_passes}íšŒ</div></div>`;
    html += '</div></div>';

    // ìˆ˜ê°• ì •ë³´
    html += '<div style="margin-bottom: 20px;"><h4 style="font-weight: 700; margin-bottom: 10px; color: #374151;">ğŸ“š ìˆ˜ê°• ì •ë³´</h4>';
    if (enrollments.length > 0) {
      enrollments.forEach(enrollment => {
        const statusColor = enrollment.status === 'active' ? '#10b981' : '#f59e0b';
        const statusText = enrollment.status === 'active' ? 'í™œì„±' : 'íœ´ì›';
        html += '<div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; margin-bottom: 8px;">';
        html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">`;
        html += `<span style="font-weight: 600;">${enrollment.teacher} - ${enrollment.subject}</span>`;
        html += `<span style="padding: 3px 8px; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>`;
        html += '</div>';
        html += `<div style="font-size: 0.85rem; color: #6b7280;">${enrollment.day} ${enrollment.time_slot} | ë‚¨ì€ ìˆ˜ì—…: ${enrollment.remaining_lessons}íšŒ</div>`;
        html += `<div style="font-size: 0.75rem; color: #9ca3af; margin-top: 3px;">ì²« ìˆ˜ì—…: ${enrollment.first_lesson_date || '-'} | ì¢…ë£Œ: ${enrollment.end_date || '-'}</div>`;
        html += '</div>';
      });
    } else {
      html += '<div style="text-align: center; padding: 20px; color: #9ca3af;">ìˆ˜ê°• ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    html += '</div>';

    // ë³´ê°•/íŒ¨ìŠ¤ ì‹ ì²­ ë‚´ì—­
    html += '<div style="margin-bottom: 20px;"><h4 style="font-weight: 700; margin-bottom: 10px; color: #374151;">ğŸ”„ ë³´ê°•/íŒ¨ìŠ¤ ì‹ ì²­ ë‚´ì—­</h4>';
    if (makeup_pass_requests.length > 0) {
      makeup_pass_requests.forEach(req => {
        const typeColor = req.request_type === 'makeup' ? '#3b82f6' : '#f59e0b';
        const typeText = req.request_type === 'makeup' ? 'ë³´ê°•' : 'íŒ¨ìŠ¤';
        const statusColor = req.status === 'active' ? '#10b981' : (req.status === 'cancelled' ? '#ef4444' : '#9ca3af');
        const statusText = req.status === 'active' ? 'ìŠ¹ì¸' : (req.status === 'cancelled' ? 'ì·¨ì†Œ' : req.status);

        html += '<div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; margin-bottom: 8px;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">';
        html += `<span style="padding: 3px 8px; background: ${typeColor}20; color: ${typeColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${typeText}</span>`;
        html += `<span style="padding: 3px 8px; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>`;
        html += '</div>';
        html += `<div style="font-size: 0.85rem; color: #374151; margin-top: 5px;">ì‹ ì²­ì¼: ${req.request_date}</div>`;
        if (req.request_type === 'makeup') {
          html += `<div style="font-size: 0.85rem; color: #6b7280;">ë³´ê°•ì¼: ${req.makeup_date || '-'} ${req.makeup_day || ''} ${req.makeup_time_slot || ''}</div>`;
          html += `<div style="font-size: 0.85rem; color: #6b7280;">ì„ ìƒë‹˜: ${req.makeup_teacher || '-'}</div>`;
        }
        html += `<div style="font-size: 0.75rem; color: #9ca3af; margin-top: 3px;">${req.created_at}</div>`;
        html += '</div>';
      });
    } else {
      html += '<div style="text-align: center; padding: 20px; color: #9ca3af;">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    html += '</div>';

    // ê²°ì œ ë‚´ì—­
    html += '<div style="margin-bottom: 20px;"><h4 style="font-weight: 700; margin-bottom: 10px; color: #374151;">ğŸ’³ ê²°ì œ ë‚´ì—­</h4>';
    if (payments.length > 0) {
      payments.forEach(payment => {
        html += '<div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; margin-bottom: 8px;">';
        html += `<div style="font-weight: 600; margin-bottom: 5px;">${payment.teacher} - ${payment.subject}</div>`;
        html += `<div style="font-size: 0.85rem; color: #6b7280;">ìˆ˜ì—…: ${payment.lessons}íšŒ / ê¸°ê°„: ${payment.months}ê°œì›”</div>`;
        html += `<div style="font-size: 0.85rem; color: #6b7280;">ê²°ì œì¼: ${payment.payment_date}</div>`;
        html += `<div style="font-size: 0.85rem; color: #6b7280;">ì²« ìˆ˜ì—…: ${payment.first_lesson_date || '-'} ${payment.first_lesson_time || ''}</div>`;
        html += '</div>';
      });
    } else {
      html += '<div style="text-align: center; padding: 20px; color: #9ca3af;">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    html += '</div>';

    document.getElementById('student-detail-content').innerHTML = html;
  }

  // íšŒì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
  window.closeStudentDetailModal = function() {
    document.getElementById('student-detail-modal').classList.remove('show');
  };

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
  let draggedCard = null;

  function handleDragStart(e) {
    draggedCard = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');

    // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ drag-over í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.students-area').forEach(area => {
      area.classList.remove('drag-over');
    });
    document.getElementById('unschedule-dropzone').classList.remove('drag-over');
  }

  function handleDragOver(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
  }

  function handleDragEnter(e) {
    this.classList.add('drag-over');
  }

  function handleDragLeave(e) {
    this.classList.remove('drag-over');
  }

  function handleDrop(e) {
    if (e.stopPropagation) {
      e.stopPropagation();
    }

    this.classList.remove('drag-over');

    if (draggedCard) {
      const userId = draggedCard.dataset.userId;
      const currentDay = draggedCard.dataset.currentDay;
      const currentTimeSlot = draggedCard.dataset.currentTimeSlot;
      const newDay = this.dataset.day;
      const newTimeSlot = this.dataset.time;

      // ê°™ì€ ìœ„ì¹˜ì— ë“œë¡­í•˜ë©´ ë¬´ì‹œ
      if (currentDay === newDay && currentTimeSlot === newTimeSlot) {
        return false;
      }

      // í˜„ì¬ í•™ìƒ ìˆ˜ í™•ì¸
      const currentCount = window.scheduleData[newDay]?.[newTimeSlot]?.length || 0;
      if (currentCount >= 3) {
        alert('í•´ë‹¹ ì‹œê°„ëŒ€ëŠ” ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
        return false;
      }

      // ì„œë²„ì— ì´ë™ ìš”ì²­
      moveStudentSchedule(userId, currentDay, currentTimeSlot, newDay, newTimeSlot);
    }

    return false;
  }

  function handleUnscheduleDropZoneDragOver(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
  }

  function handleUnscheduleDropZoneDragEnter(e) {
    document.getElementById('unschedule-dropzone').classList.add('drag-over');
  }

  function handleUnscheduleDropZoneDragLeave(e) {
    document.getElementById('unschedule-dropzone').classList.remove('drag-over');
  }

  function handleUnscheduleDropZoneDrop(e) {
    if (e.stopPropagation) {
      e.stopPropagation();
    }

    document.getElementById('unschedule-dropzone').classList.remove('drag-over');

    if (draggedCard) {
      const userId = draggedCard.dataset.userId;
      const currentDay = draggedCard.dataset.currentDay;
      const currentTimeSlot = draggedCard.dataset.currentTimeSlot;

      if (confirm('ìŠ¤ì¼€ì¤„ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê²°ì œ ë° ìˆ˜ì—… ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
        // ì„œë²„ì— ìŠ¤ì¼€ì¤„ í•´ì œ ìš”ì²­
        unscheduleStudent(userId, currentDay, currentTimeSlot);
      }
    }

    return false;
  }

  // í•™ìƒ ìŠ¤ì¼€ì¤„ ì´ë™
  function moveStudentSchedule(userId, fromDay, fromTimeSlot, toDay, toTimeSlot) {
    showScheduleLoading(true);

    fetch('/admin/move_student_schedule', {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: userId,
        from_day: fromDay,
        from_time_slot: fromTimeSlot,
        to_day: toDay,
        to_time_slot: toTimeSlot,
        teacher: window.currentScheduleTeacher
      })
    })
    .then(response => response.json())
    .then(data => {
      showScheduleLoading(false);
      if (data.success) {
        alert('ìŠ¤ì¼€ì¤„ì´ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadScheduleData();
      } else {
        alert('ìŠ¤ì¼€ì¤„ ì´ë™ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(error => {
      showScheduleLoading(false);
      console.error('Error:', error);
      alert('ìŠ¤ì¼€ì¤„ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }

  // í•™ìƒ ìŠ¤ì¼€ì¤„ í•´ì œ
  function unscheduleStudent(userId, day, timeSlot) {
    showScheduleLoading(true);

    fetch('/admin/unschedule_student', {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: userId,
        day: day,
        time_slot: timeSlot,
        teacher: window.currentScheduleTeacher
      })
    })
    .then(response => response.json())
    .then(data => {
      showScheduleLoading(false);
      if (data.success) {
        alert('ìŠ¤ì¼€ì¤„ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadScheduleData();
      } else {
        alert('ìŠ¤ì¼€ì¤„ í•´ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .catch(error => {
      showScheduleLoading(false);
      console.error('Error:', error);
      alert('ìŠ¤ì¼€ì¤„ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  }

  // ë“œë¡­ ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  function setupDropZones() {
    // ëª¨ë“  students-areaì— ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.students-area').forEach(area => {
      area.addEventListener('dragover', handleDragOver);
      area.addEventListener('dragenter', handleDragEnter);
      area.addEventListener('dragleave', handleDragLeave);
      area.addEventListener('drop', handleDrop);
    });

    // ìŠ¤ì¼€ì¤„ í•´ì œ ì˜ì—­ì— ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€
    const unscheduleZone = document.getElementById('unschedule-dropzone');
    if (unscheduleZone) {
      unscheduleZone.addEventListener('dragover', handleUnscheduleDropZoneDragOver);
      unscheduleZone.addEventListener('dragenter', handleUnscheduleDropZoneDragEnter);
      unscheduleZone.addEventListener('dragleave', handleUnscheduleDropZoneDragLeave);
      unscheduleZone.addEventListener('drop', handleUnscheduleDropZoneDrop);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      updateScheduleWeekDisplay();
      loadScheduleData();
      setupEmptyContainerClicks();
      setupDropZones();
    });
  } else {
    updateScheduleWeekDisplay();
    loadScheduleData();
    setupEmptyContainerClicks();
    setupDropZones();
  }
})();
</script>
