<div class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <h2 class="text-2xl font-bold mb-6">ì˜ˆì•½ ê´€ë¦¬</h2>
    
    <!-- íƒ­ ì„ íƒ -->
    <div class="flex gap-4 mb-4 border-b">
      <button onclick="loadReservationsTab('practice')"
              class="reservation-tab-btn <%= service_type != 'makeup' ? 'active' : '' %> pb-2 px-1">
        ì—°ìŠµì‹¤ ì˜ˆì•½
      </button>
      <button onclick="loadReservationsTab('makeup')"
              class="reservation-tab-btn <%= service_type == 'makeup' ? 'active' : '' %> pb-2 px-1">
        ë³´ì¶©ìˆ˜ì—… ì˜ˆì•½
      </button>
    </div>
  
  <!-- ê²€ìƒ‰ ê¸°ëŠ¥ (ìˆ˜ì •ëœ ë¶€ë¶„) -->
  <div class="mb-4">
    <form id="reservation-filter-form" class="flex gap-2 flex-wrap">
      <input type="text" 
             id="reservation-search"
             name="search"
             placeholder="ì´ë¦„ì´ë‚˜ ì•„ì´ë””ë¡œ ê²€ìƒ‰..."
             class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-violet-500 focus:border-transparent"
             value=""
             onkeyup="searchReservations()"
             oninput="searchReservations()">
      
      <select id="reservation-status" name="status" class="px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-violet-500 focus:border-transparent" onchange="filterReservations()">
        <option value="">ì „ì²´ ìƒíƒœ</option>
        <% if service_type == 'makeup' %>
          <option value="pending">ìŠ¹ì¸ ëŒ€ê¸°</option>
          <option value="active">ìˆ˜ì—… ëŒ€ê¸°</option>
          <option value="completed">ì™„ë£Œ</option>
          <option value="cancelled">ê±°ì ˆë¨</option>
          <option value="no_show">ë…¸ì‡¼</option>
        <% else %>
          <option value="pending">ëŒ€ê¸°</option>
          <option value="active">ì´ìš© ì „</option>
          <option value="completed">ì™„ë£Œ</option>
          <option value="cancelled">ì·¨ì†Œ</option>
          <option value="no_show">ë…¸ì‡¼</option>
        <% end %>
      </select>
      
      <input type="date" 
             id="reservation-date"
             name="date"
             class="px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-violet-500 focus:border-transparent"
             onchange="filterReservations()">
      
      <button type="button" onclick="filterReservations()" 
              class="px-3 py-1.5 text-sm bg-violet-600 text-white rounded hover:bg-violet-700">
        ê²€ìƒ‰
      </button>
      
      <button type="button" onclick="resetReservationFilters()" 
              class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
        ì´ˆê¸°í™”
      </button>
    </form>
  </div>
  
  <!-- ì˜ˆì•½ ëª©ë¡ -->
  <div class="bg-white rounded-lg shadow">
    <% if reservations && reservations.any? %>
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì•„ì´ë””</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"><%= service_type == 'makeup' ? 'ìˆ˜ì—…' : 'ì—°ìŠµì‹¤' %></th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì‹œê°„</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% reservations.each do |reservation| %>
            <% next unless reservation.user %>
            <tr class="reservation-row <%= 'bg-yellow-50' if reservation.status == 'pending' %>" 
                data-name="<%= reservation.user.name %>"
                data-username="<%= reservation.user.username %>"
                data-status="<%= reservation.status %>"
                data-date="<%= reservation.start_time.strftime('%Y-%m-%d') %>">
              <td class="px-4 py-2 text-sm font-medium"><%= reservation.user.name %></td>
              <td class="px-4 py-2 text-sm"><%= reservation.user.username %></td>
              <td class="px-4 py-2 text-sm">
                <% if service_type == 'makeup' %>
                  <%= reservation.subject if reservation.respond_to?(:subject) %> ë³´ì¶©
                  <% if reservation.user.respond_to?(:teacher) && reservation.user.teacher %>
                    <span class="text-xs text-gray-500">(<%= reservation.user.teacher %>)</span>
                  <% end %>
                <% else %>
                  <%= reservation.room.number %>ë²ˆ
                  <% if reservation.room.respond_to?(:has_outlet) && reservation.room.has_outlet %>
                    <span title="ì½˜ì„¼íŠ¸ ìˆìŒ">ğŸ”Œ</span>
                  <% end %>
                <% end %>
              </td>
              <td class="px-4 py-2 text-sm"><%= reservation.start_time.strftime('%Y-%m-%d') %></td>
              <td class="px-4 py-2 text-sm">
                <%= reservation.start_time.strftime('%H:%M') %> - <%= reservation.end_time.strftime('%H:%M') %>
              </td>
              <td class="px-4 py-2">
                <% if service_type == 'makeup' %>
                  <% case reservation.status %>
                  <% when 'pending' %>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">ìŠ¹ì¸ ëŒ€ê¸°</span>
                  <% when 'active' %>
                    <% if reservation.start_time > Time.current %>
                      <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">ìˆ˜ì—… ëŒ€ê¸°</span>
                    <% else %>
                      <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">ì™„ë£Œ</span>
                    <% end %>
                  <% when 'completed' %>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">ì™„ë£Œ</span>
                  <% when 'cancelled' %>
                    <% if reservation.cancelled_by == 'admin' %>
                      <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">ê±°ì ˆë¨</span>
                    <% else %>
                      <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">ì·¨ì†Œ</span>
                    <% end %>
                  <% when 'no_show' %>
                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">ë…¸ì‡¼</span>
                  <% else %>
                    <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full"><%= reservation.status %></span>
                  <% end %>
                <% else %>
                  <% case reservation.status %>
                  <% when 'pending' %>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">ëŒ€ê¸°</span>
                  <% when 'active' %>
                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">ì´ìš© ì „</span>
                  <% when 'completed' %>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">ì™„ë£Œ</span>
                  <% when 'cancelled' %>
                    <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">ì·¨ì†Œ</span>
                  <% when 'no_show' %>
                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">ë…¸ì‡¼</span>
                  <% else %>
                    <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full"><%= reservation.status %></span>
                  <% end %>
                <% end %>
              </td>
              <td class="px-4 py-2">
                <% if service_type == 'makeup' && reservation.status == 'pending' %>
                  <button onclick="updateReservationStatus(<%= reservation.id %>, 'active', 'makeup')" 
                          class="text-green-600 hover:text-green-800 text-sm cursor-pointer mr-2">ìŠ¹ì¸</button>
                  <button onclick="updateReservationStatus(<%= reservation.id %>, 'cancelled', 'makeup')" 
                          class="text-red-600 hover:text-red-800 text-sm cursor-pointer mr-2">ê±°ì ˆ</button>
                <% end %>
                <select onchange="updateReservationStatus(<%= reservation.id %>, this.value, '<%= service_type %>')" 
                        class="text-xs px-2 py-1 border border-gray-300 rounded mr-2">
                  <% if service_type == 'makeup' %>
                    <option value="pending" <%= 'selected' if reservation.status == 'pending' %>>ìŠ¹ì¸ ëŒ€ê¸°</option>
                    <option value="active" <%= 'selected' if reservation.status == 'active' %>>ìˆ˜ì—… ëŒ€ê¸°</option>
                    <option value="completed" <%= 'selected' if reservation.status == 'completed' %>>ì™„ë£Œ</option>
                    <option value="cancelled" <%= 'selected' if reservation.status == 'cancelled' %>><%= reservation.cancelled_by == 'admin' ? 'ê±°ì ˆë¨' : 'ì·¨ì†Œ' %></option>
                    <option value="no_show" <%= 'selected' if reservation.status == 'no_show' %>>ë…¸ì‡¼</option>
                  <% else %>
                    <option value="pending" <%= 'selected' if reservation.status == 'pending' %>>ëŒ€ê¸°</option>
                    <option value="active" <%= 'selected' if reservation.status == 'active' %>>ì´ìš© ì „</option>
                    <option value="completed" <%= 'selected' if reservation.status == 'completed' %>>ì™„ë£Œ</option>
                    <option value="cancelled" <%= 'selected' if reservation.status == 'cancelled' %>>ì·¨ì†Œ</option>
                    <option value="no_show" <%= 'selected' if reservation.status == 'no_show' %>>ë…¸ì‡¼</option>
                  <% end %>
                </select>
                <button onclick="deleteReservation(<%= reservation.id %>, '<%= service_type %>')" 
                        class="text-red-600 hover:text-red-800 text-sm cursor-pointer">ì‚­ì œ</button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-gray-500 p-8 text-center">ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    <% end %>
  </div>
  </div>
</div>

<script>
// ì˜ˆì•½ ê´€ë¦¬ ì „ì—­ í•¨ìˆ˜ë“¤ - í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„

// ê²€ìƒ‰ í•¨ìˆ˜ë“¤ì„ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ë¡œ ê°ì‹¸ì„œ í™•ì‹¤íˆ ë¡œë“œë˜ê²Œ í•¨
(function() {
  // ê²€ìƒ‰ ê¸°ëŠ¥
  window.searchReservations = function() {
    const searchInput = document.getElementById('reservation-search');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('.reservation-row');
    
    rows.forEach(row => {
      const name = (row.getAttribute('data-name') || '').toLowerCase();
      const username = (row.getAttribute('data-username') || '').toLowerCase();
      
      if (searchTerm === '' || name.includes(searchTerm) || username.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  };

  // í•„í„°ë§ ê¸°ëŠ¥ 
  window.filterReservations = function() {
    const statusFilter = document.getElementById('reservation-status')?.value || '';
    const dateFilter = document.getElementById('reservation-date')?.value || '';
    const searchTerm = (document.getElementById('reservation-search')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('.reservation-row');
    
    rows.forEach(row => {
      let visible = true;
      
      // ê²€ìƒ‰ì–´ í•„í„°
      if (searchTerm) {
        const name = (row.getAttribute('data-name') || '').toLowerCase();
        const username = (row.getAttribute('data-username') || '').toLowerCase();
        if (!name.includes(searchTerm) && !username.includes(searchTerm)) {
          visible = false;
        }
      }
      
      // ìƒíƒœ í•„í„°
      if (statusFilter && visible) {
        const status = row.getAttribute('data-status');
        if (status !== statusFilter) {
          visible = false;
        }
      }
      
      // ë‚ ì§œ í•„í„°
      if (dateFilter && visible) {
        const date = row.getAttribute('data-date');
        if (date !== dateFilter) {
          visible = false;
        }
      }
      
      row.style.display = visible ? '' : 'none';
    });
  };

  // ì´ˆê¸°í™” ê¸°ëŠ¥
  window.resetReservationFilters = function() {
    const searchInput = document.getElementById('reservation-search');
    const statusSelect = document.getElementById('reservation-status');
    const dateInput = document.getElementById('reservation-date');
    
    if (searchInput) searchInput.value = '';
    if (statusSelect) statusSelect.value = '';
    if (dateInput) dateInput.value = '';
    
    const rows = document.querySelectorAll('.reservation-row');
    rows.forEach(row => {
      row.style.display = '';
    });
  };

  // í†µí•© í•„í„° ì ìš© (ê²€ìƒ‰ ë²„íŠ¼ìš©)
  window.applyReservationFilters = function() {
    window.filterReservations();
  };

  console.log('ì˜ˆì•½ ê´€ë¦¬ í•„í„°ë§ í•¨ìˆ˜ë“¤ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
})();

// ê¸°ì¡´ í•¨ìˆ˜ë“¤
  
  window.updateReservationStatus = function(reservationId, status, service) {
    fetch(`/admin/reservations/${reservationId}/update_status`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: status, service: service })
    }).then(response => {
      if (response.ok || response.redirected) {
        window.loadReservationsTab(service);
      } else {
        alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  };

  window.deleteReservation = function(reservationId, service) {
    if (confirm('ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ service: service })
      }).then(response => {
        if (response.ok || response.redirected) {
          window.loadReservationsTab(service);
        } else {
          alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }
  };
  
  window.applyReservationFilters = function() {
    const service = window.currentReservationService || 'practice';
    const search = document.getElementById('reservation-search')?.value || '';
    const status = document.getElementById('reservation-status')?.value || '';
    const date = document.getElementById('reservation-date')?.value || '';
    
    // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
    const params = new URLSearchParams();
    params.append('service', service);
    if (search) params.append('search', search);
    if (status) params.append('status', status);
    if (date) params.append('date', date);
    
    // ì„œë²„ì—ì„œ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/admin/reservations/content?${params.toString()}`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('reservations-content-area').innerHTML = html;
      })
      .catch(error => {
        console.error('Filter error:', error);
      });
  };
  
  window.resetReservationFilters = function() {
    document.getElementById('reservation-search').value = '';
    document.getElementById('reservation-status').value = '';
    document.getElementById('reservation-date').value = '';
    
    // í•„í„° ì´ˆê¸°í™” í›„ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    const service = window.currentReservationService || 'practice';
    window.loadReservationsTab(service);
  };

</script>

<style>
.reservation-tab-btn {
  color: #666;
  font-weight: normal;
  border-bottom: 2px solid transparent;
  cursor: pointer;
}
.reservation-tab-btn.active {
  color: #7c3aed;
  font-weight: bold;
  border-bottom: 2px solid #7c3aed;
}
.reservation-tab-btn:hover {
  color: #7c3aed;
}
</style>