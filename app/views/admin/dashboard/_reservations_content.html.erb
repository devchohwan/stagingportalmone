<style>
  .reservations-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    overflow: hidden;
  }
  
  .reservations-header {
    padding: 25px;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .reservations-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 20px;
  }
  
  .service-nav {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    background: #f7fafc;
    padding: 5px;
    border-radius: 10px;
  }
  
  .service-btn {
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    background: transparent;
    color: #4a5568;
  }
  
  .service-btn:hover {
    background: #edf2f7;
    color: #2d3748;
  }
  
  .service-btn.active {
    background: #ffffff;
    color: #f093fb;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .filters-container {
    display: grid;
    grid-template-columns: 1fr auto auto auto auto;
    gap: 12px;
    align-items: center;
  }
  
  .search-input {
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }
  
  .search-input:focus {
    outline: none;
    border-color: #f093fb;
    box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.1);
  }
  
  .filter-select {
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
  }
  
  .filter-select:focus {
    outline: none;
    border-color: #f093fb;
    box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.1);
  }
  
  .filter-btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .filter-btn-primary {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: white;
  }
  
  .filter-btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
  }
  
  .filter-btn-secondary {
    background: #f7fafc;
    color: #4a5568;
    border: 1px solid #e2e8f0;
  }
  
  .filter-btn-secondary:hover {
    background: #edf2f7;
    color: #2d3748;
  }
  
  .reservations-content {
    padding: 25px;
  }
  
  .reservations-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .table-header {
    background: #f8fafc;
  }
  
  .table-header th {
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .table-header th:first-child {
    border-radius: 8px 0 0 0;
  }
  
  .table-header th:last-child {
    border-radius: 0 8px 0 0;
  }
  
  .reservation-row {
    transition: background-color 0.2s ease;
  }
  
  .reservation-row:hover {
    background: #f8fafc;
  }
  
  .reservation-row td {
    padding: 15px 12px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
  }
  
  .reservation-row.pending-row {
    background: #fffbeb;
  }
  
  .user-name {
    font-weight: 600;
    color: #2d3748;
  }
  
  .room-info {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .outlet-icon {
    font-size: 0.8rem;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .status-pending {
    background: #fef3c7;
    color: #92400e;
  }
  
  .status-active {
    background: #dcfce7;
    color: #166534;
  }
  
  .status-waiting {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .status-completed {
    background: #e0e7ff;
    color: #3730a3;
  }
  
  .status-cancelled {
    background: #f3f4f6;
    color: #374151;
  }
  
  .status-rejected {
    background: #fee2e2;
    color: #991b1b;
  }
  
  .status-no-show {
    background: #fecaca;
    color: #991b1b;
  }
  
  .action-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .action-btn:hover {
    transform: translateY(-1px);
  }
  
  .btn-approve {
    background: #10b981;
    color: white;
  }
  
  .btn-approve:hover {
    background: #059669;
  }
  
  .btn-reject {
    background: #ef4444;
    color: white;
  }
  
  .btn-reject:hover {
    background: #dc2626;
  }
  
  .btn-delete {
    background: #f59e0b;
    color: white;
  }
  
  .btn-delete:hover {
    background: #d97706;
  }
  
  .status-select {
    padding: 6px 10px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.8rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .status-select:focus {
    outline: none;
    border-color: #f093fb;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #9ca3af;
  }
  
  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
  }
  
  .empty-state-text {
    font-size: 1.1rem;
    font-weight: 500;
  }
  
  @media (max-width: 1024px) {
    .filters-container {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 10px 16px;
    }
  }
  
  @media (max-width: 768px) {
    .reservations-table {
      font-size: 0.8rem;
    }
    
    .table-header th,
    .reservation-row td {
      padding: 10px 8px;
    }
    
    .action-controls {
      flex-direction: column;
      gap: 4px;
    }
    
    .action-btn {
      padding: 4px 8px;
      font-size: 0.7rem;
    }
  }
</style>

<div class="reservations-container">
  <div class="reservations-header">
    <h2 class="reservations-title">📅 예약 관리</h2>
    
    <!-- 서비스 선택 네비게이션 -->
    <div class="service-nav">
      <button onclick="loadReservationsTab('practice')" class="service-btn <%= service_type != 'makeup' ? 'active' : '' %>">
        🎹 연습실 예약
      </button>
      <button onclick="loadReservationsTab('makeup')" class="service-btn <%= service_type == 'makeup' ? 'active' : '' %>">
        📚 보충수업 예약
      </button>
    </div>
    
    <!-- 검색 및 필터 -->
    <div class="filters-container">
      <input type="text" 
             id="reservation-search"
             placeholder="이름이나 아이디로 검색..."
             class="search-input"
             onkeyup="searchReservations()">
      
      <select id="reservation-status" class="filter-select" onchange="filterReservations()">
        <option value="">전체 상태</option>
        <% if service_type == 'makeup' %>
          <option value="pending">승인 대기</option>
          <option value="active">수업 대기</option>
          <option value="completed">완료</option>
          <option value="cancelled">거절됨</option>
          <option value="no_show">노쇼</option>
        <% else %>
          <option value="pending">대기</option>
          <option value="active">이용 전</option>
          <option value="completed">완료</option>
          <option value="cancelled">취소</option>
          <option value="no_show">노쇼</option>
        <% end %>
      </select>
      
      <input type="date" 
             id="reservation-date"
             class="filter-select"
             style="min-width: 140px;"
             onchange="filterReservations()">
      
      <button type="button" onclick="filterReservations()" class="filter-btn filter-btn-primary">
        검색
      </button>
      
      <button type="button" onclick="resetReservationFilters()" class="filter-btn filter-btn-secondary">
        초기화
      </button>
    </div>
  </div>

  <div class="reservations-content">
    <% if reservations && reservations.any? %>
      <table class="reservations-table">
        <thead class="table-header">
          <tr>
            <th>이름</th>
            <th>아이디</th>
            <th><%= service_type == 'makeup' ? '담당' : '연습실' %></th>
            <th>날짜</th>
            <th>시간</th>
            <th>상태</th>
            <th>관리</th>
          </tr>
        </thead>
        <tbody>
          <% reservations.each do |reservation| %>
            <% next unless reservation.user %>
            <tr class="reservation-row <%= 'pending-row' if reservation.status == 'pending' %>" 
                data-name="<%= reservation.user.name %>"
                data-username="<%= reservation.user.username %>"
                data-status="<%= reservation.status %>"
                data-date="<%= reservation.start_time&.strftime('%Y-%m-%d') || '' %>">
              
              <td><span class="user-name"><%= reservation.user.name %></span></td>
              <td><%= reservation.user.username %></td>
              <td>
                <% if service_type == 'makeup' %>
                  <div class="room-info">
                    <% # 회원의 담당 선생님 표시 %>
                    <% if reservation.user && reservation.user.teacher.present? %>
                      <%= reservation.user.teacher %>
                    <% else %>
                      <span style="color: #9ca3af;">미지정</span>
                    <% end %>
                  </div>
                <% else %>
                  <div class="room-info">
                    <%= reservation.room.number %>번
                    <% if reservation.room.respond_to?(:has_outlet) && reservation.room.has_outlet %>
                      <span class="outlet-icon" title="콘센트 있음">🔌</span>
                    <% end %>
                  </div>
                <% end %>
              </td>
              <td><%= reservation.start_time&.strftime('%Y-%m-%d') || 'N/A' %></td>
              <td>
                <%= reservation.start_time&.strftime('%H:%M') || 'N/A' %> - <%= reservation.end_time&.strftime('%H:%M') || 'N/A' %>
              </td>
              <td>
                <% if service_type == 'makeup' %>
                  <% case reservation.status %>
                  <% when 'pending' %>
                    <span class="status-badge status-pending">승인 대기</span>
                  <% when 'active' %>
                    <% if reservation.start_time > Time.current %>
                      <span class="status-badge status-waiting">수업 대기</span>
                    <% else %>
                      <span class="status-badge status-completed">완료</span>
                    <% end %>
                  <% when 'completed' %>
                    <span class="status-badge status-completed">완료</span>
                  <% when 'cancelled' %>
                    <% if reservation.cancelled_by == 'admin' %>
                      <span class="status-badge status-rejected">거절됨</span>
                    <% else %>
                      <span class="status-badge status-cancelled">취소</span>
                    <% end %>
                  <% when 'no_show' %>
                    <span class="status-badge status-no-show">노쇼</span>
                  <% else %>
                    <span class="status-badge status-cancelled"><%= reservation.status %></span>
                  <% end %>
                <% else %>
                  <% case reservation.status %>
                  <% when 'pending' %>
                    <span class="status-badge status-pending">대기</span>
                  <% when 'active' %>
                    <span class="status-badge status-active">이용 전</span>
                  <% when 'completed' %>
                    <span class="status-badge status-completed">완료</span>
                  <% when 'cancelled' %>
                    <span class="status-badge status-cancelled">취소</span>
                  <% when 'no_show' %>
                    <span class="status-badge status-no-show">노쇼</span>
                  <% else %>
                    <span class="status-badge status-cancelled"><%= reservation.status %></span>
                  <% end %>
                <% end %>
              </td>
              <td>
                <div class="action-controls">
                  <% if service_type == 'makeup' && reservation.status == 'pending' %>
                    <button onclick="updateReservationStatus(<%= reservation.id %>, 'active', 'makeup')" 
                            class="action-btn btn-approve">승인</button>
                    <button onclick="updateReservationStatus(<%= reservation.id %>, 'cancelled', 'makeup')" 
                            class="action-btn btn-reject">거절</button>
                  <% end %>
                  
                  <select onchange="updateReservationStatus(<%= reservation.id %>, this.value, '<%= service_type %>')" 
                          class="status-select">
                    <% if service_type == 'makeup' %>
                      <option value="pending" <%= 'selected' if reservation.status == 'pending' %>>승인 대기</option>
                      <option value="active" <%= 'selected' if reservation.status == 'active' %>>수업 대기</option>
                      <option value="completed" <%= 'selected' if reservation.status == 'completed' %>>완료</option>
                      <option value="cancelled" <%= 'selected' if reservation.status == 'cancelled' %>><%= reservation.cancelled_by == 'admin' ? '거절됨' : '취소' %></option>
                      <option value="no_show" <%= 'selected' if reservation.status == 'no_show' %>>노쇼</option>
                    <% else %>
                      <option value="pending" <%= 'selected' if reservation.status == 'pending' %>>대기</option>
                      <option value="active" <%= 'selected' if reservation.status == 'active' %>>이용 전</option>
                      <option value="completed" <%= 'selected' if reservation.status == 'completed' %>>완료</option>
                      <option value="cancelled" <%= 'selected' if reservation.status == 'cancelled' %>>취소</option>
                      <option value="no_show" <%= 'selected' if reservation.status == 'no_show' %>>노쇼</option>
                    <% end %>
                  </select>
                  
                  <button onclick="deleteReservation(<%= reservation.id %>, '<%= service_type %>')" 
                          class="action-btn btn-delete">삭제</button>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">
        <div class="empty-state-icon">📅</div>
        <div class="empty-state-text">예약이 없습니다</div>
      </div>
    <% end %>
  </div>
</div>

<script>
(function() {
  // 검색 기능
  window.searchReservations = function() {
    const searchInput = document.getElementById('reservation-search');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('.reservation-row');
    
    rows.forEach(row => {
      const name = (row.getAttribute('data-name') || '').toLowerCase();
      const username = (row.getAttribute('data-username') || '').toLowerCase();
      
      if (searchTerm === '' || name.includes(searchTerm) || username.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  };

  // 필터링 기능 
  window.filterReservations = function() {
    const statusFilter = document.getElementById('reservation-status')?.value || '';
    const dateFilter = document.getElementById('reservation-date')?.value || '';
    const searchTerm = (document.getElementById('reservation-search')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('.reservation-row');
    
    rows.forEach(row => {
      let visible = true;
      
      // 검색어 필터
      if (searchTerm) {
        const name = (row.getAttribute('data-name') || '').toLowerCase();
        const username = (row.getAttribute('data-username') || '').toLowerCase();
        if (!name.includes(searchTerm) && !username.includes(searchTerm)) {
          visible = false;
        }
      }
      
      // 상태 필터
      if (statusFilter && visible) {
        const status = row.getAttribute('data-status');
        if (status !== statusFilter) {
          visible = false;
        }
      }
      
      // 날짜 필터
      if (dateFilter && visible) {
        const date = row.getAttribute('data-date');
        if (date !== dateFilter) {
          visible = false;
        }
      }
      
      row.style.display = visible ? '' : 'none';
    });
  };

  // 초기화 기능
  window.resetReservationFilters = function() {
    const searchInput = document.getElementById('reservation-search');
    const statusSelect = document.getElementById('reservation-status');
    const dateInput = document.getElementById('reservation-date');
    
    if (searchInput) searchInput.value = '';
    if (statusSelect) statusSelect.value = '';
    if (dateInput) dateInput.value = '';
    
    const rows = document.querySelectorAll('.reservation-row');
    rows.forEach(row => {
      row.style.display = '';
    });
  };

  // 상태 업데이트
  window.updateReservationStatus = function(reservationId, status, service) {
    fetch(`/admin/reservations/${reservationId}/update_status`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: status, service: service })
    }).then(response => {
      if (response.ok || response.redirected) {
        window.loadReservationsTab(service);
      } else {
        alert('상태 변경에 실패했습니다.');
      }
    });
  };

  // 예약 삭제
  window.deleteReservation = function(reservationId, service) {
    if (confirm('정말로 이 예약을 삭제하시겠습니까?')) {
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ service: service })
      }).then(response => {
        if (response.ok || response.redirected) {
          window.loadReservationsTab(service);
        } else {
          alert('삭제에 실패했습니다.');
        }
      });
    }
  };

  console.log('예약 관리 함수들이 로드되었습니다.');
})();
</script>