<div class="min-h-screen bg-gray-50">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <h2 class="text-2xl font-bold mb-6">통합 회원 관리</h2>
    
    <% if @pending_users.any? %>
      <div class="mb-8">
        <h3 class="text-lg font-medium mb-3">승인 대기 회원</h3>
        <div class="space-y-2">
          <% @pending_users.each do |user| %>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium"><%= user['name'] %></p>
                  <p class="text-sm text-gray-600">
                    아이디: <%= user['username'] %>
                  </p>
                  <p class="text-sm text-gray-600">
                    전화번호: 
                    <input type="tel" 
                           id="phone-pending-<%= user['id'] %>"
                           value="<%= user['phone'] || '' %>" 
                           placeholder="미등록"
                           class="text-sm px-2 py-0.5 border border-gray-300 rounded w-24">
                    <button onclick="updatePhone(<%= user['id'] %>, 'pending')" 
                            class="text-xs px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700">확인</button>
                  </p>
                  <p class="text-sm text-gray-600">
                    담당: 
                    <select onchange="updateTeacher(<%= user['id'] %>, this.value)" 
                            class="text-xs px-2 py-1 border border-gray-300 rounded">
                      <% ['무성', '성균', '노네임', '로한', '범석', '두박', '오또', '지명', '도현'].each do |teacher| %>
                        <option value="<%= teacher %>" <%= 'selected' if user['teacher'] == teacher %>><%= teacher %></option>
                      <% end %>
                    </select>
                  </p>
                  <p class="text-xs text-gray-500 mt-1">
                    가입일: <%= DateTime.parse(user['created_at']).strftime('%Y-%m-%d %H:%M') %>
                  </p>
                </div>
                <div class="flex gap-2">
                  <button onclick="approveUser(<%= user['id'] %>)" 
                          class="btn-approve">승인</button>
                  <button onclick="holdUser(<%= user['id'] %>)"
                          class="btn-hold">보류</button>
                  <button onclick="rejectUser(<%= user['id'] %>)"
                          class="btn-reject">거부</button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <% if @on_hold_users.any? %>
      <div class="mb-8">
        <h3 class="text-lg font-medium mb-3">보류 중인 회원</h3>
        <div class="space-y-2">
          <% @on_hold_users.each do |user| %>
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium"><%= user['name'] %></p>
                  <p class="text-sm text-gray-600">
                    아이디: <%= user['username'] %>
                  </p>
                  <p class="text-sm text-gray-600">
                    전화번호: 
                    <input type="tel" 
                           id="phone-hold-<%= user['id'] %>"
                           value="<%= user['phone'] || '' %>" 
                           placeholder="미등록"
                           class="text-sm px-2 py-0.5 border border-gray-300 rounded w-24">
                    <button onclick="updatePhone(<%= user['id'] %>, 'hold')" 
                            class="text-xs px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700">확인</button>
                  </p>
                  <p class="text-sm text-gray-600">
                    담당: 
                    <select onchange="updateTeacher(<%= user['id'] %>, this.value)" 
                            class="text-xs px-2 py-1 border border-gray-300 rounded">
                      <% ['무성', '성균', '노네임', '로한', '범석', '두박', '오또', '지명', '도현'].each do |teacher| %>
                        <option value="<%= teacher %>" <%= 'selected' if user['teacher'] == teacher %>><%= teacher %></option>
                      <% end %>
                    </select>
                  </p>
                  <p class="text-xs text-gray-500 mt-1">
                    가입일: <%= DateTime.parse(user['created_at']).strftime('%Y-%m-%d %H:%M') %>
                  </p>
                </div>
                <div class="flex gap-2">
                  <button onclick="approveUser(<%= user['id'] %>)" 
                          class="btn-approve">승인</button>
                  <button onclick="rejectUser(<%= user['id'] %>)" 
                          class="link-hold text-sm">삭제</button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    
    <!-- 탭 선택 -->
    <div class="flex gap-4 mb-4 border-b">
      <button onclick="changeTab('approved')"
              class="tab-btn <%= 'active' if @tab == 'approved' %> pb-2 px-1">
        승인된 회원
      </button>
      <button onclick="changeTab('pending')"
              class="tab-btn <%= 'active' if @tab == 'pending' %> pb-2 px-1">
        대기/보류
      </button>
    </div>
    
    <!-- 승인된 회원 탭 -->
    <% if @tab == 'approved' %>
      <div class="bg-white rounded-lg shadow">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">이름</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">아이디</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">전화번호</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">담당</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">노쇼</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">취소</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">차단</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">비밀번호</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">삭제</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @approved_users.each do |user| %>
              <tr>
                <td class="px-4 py-2 text-sm"><%= user['name'] %></td>
                <td class="px-4 py-2 text-sm"><%= user['username'] %></td>
                <td class="px-4 py-2">
                  <input type="tel" 
                         id="phone-approved-<%= user['id'] %>"
                         value="<%= user['phone'] || '' %>" 
                         placeholder="-"
                         class="text-sm px-2 py-0.5 border border-gray-300 rounded w-24">
                  <button onclick="updatePhone(<%= user['id'] %>, 'approved')" 
                          class="text-xs px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700">확인</button>
                </td>
                <td class="px-4 py-2">
                  <select onchange="updateTeacher(<%= user['id'] %>, this.value)" 
                          class="text-xs px-2 py-1 border border-gray-300 rounded">
                    <% ['무성', '성균', '노네임', '로한', '범석', '두박', '오또', '지명', '도현'].each do |teacher| %>
                      <option value="<%= teacher %>" <%= 'selected' if user['teacher'] == teacher %>><%= teacher %></option>
                    <% end %>
                  </select>
                </td>
                <td class="px-4 py-2 text-sm"><%= user['no_show_count'] || 0 %></td>
                <td class="px-4 py-2 text-sm"><%= user['cancel_count'] || 0 %></td>
                <td class="px-4 py-2 text-sm">
                  <% if user['is_blocked'] %>
                    <span class="text-red-600">차단됨</span>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td class="px-4 py-2">
                  <button onclick="resetPassword('<%= user['id'] %>', '<%= user['username'] %>')" 
                          class="text-blue-600 hover:text-blue-800 text-sm">재설정</button>
                </td>
                <td class="px-4 py-2">
                  <button onclick="deleteUser(<%= user['id'] %>)" 
                          class="text-red-600 hover:text-red-800 text-sm">삭제</button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
    
    <!-- 대기/보류 탭 -->
    <% if @tab == 'pending' %>
      <p class="text-gray-500">위의 승인 대기 및 보류 회원 목록을 확인하세요.</p>
    <% end %>
    
    <div class="mt-4">
      <a href="/admin" class="text-gray-600 text-sm">← 관리자 대시보드로</a>
    </div>
  </div>
</div>

<style>
.tab-btn {
  color: #666;
  font-weight: normal;
  border-bottom: 2px solid transparent;
}
.tab-btn.active {
  color: #7c3aed;
  font-weight: bold;
  border-bottom: 2px solid #7c3aed;
}
.tab-btn:hover {
  color: #7c3aed;
}

.btn-approve {
  background-color: #16a34a;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}
.btn-approve:hover {
  background-color: #15803d;
}

.btn-hold {
  background-color: #f97316;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}
.btn-hold:hover {
  background-color: #ea580c;
}

.btn-reject {
  background-color: #ef4444;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 14px;
}
.btn-reject:hover {
  background-color: #dc2626;
}

.link-hold {
  color: #f97316;
  font-size: 14px;
}
.link-hold:hover {
  color: #ea580c;
  cursor: pointer;
}
</style>

<script>
function changeTab(tab) {
  window.location.href = '/admin/users?tab=' + tab;
}

function approveUser(userId) {
  if(confirm('이 사용자를 승인하시겠습니까?')) {
    fetch(`/admin/practice/users/${userId}/approve`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    }).then(() => {
      window.location.reload();
    });
  }
}

function holdUser(userId) {
  if(confirm('이 사용자를 보류하시겠습니까?')) {
    fetch(`/admin/practice/users/${userId}/hold`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    }).then(() => {
      window.location.reload();
    });
  }
}

function rejectUser(userId) {
  if(confirm('이 사용자를 거부/삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
    fetch(`/admin/practice/users/${userId}/reject`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    }).then(() => {
      window.location.reload();
    });
  }
}

function deleteUser(userId) {
  if(confirm('정말 삭제하시겠습니까?')) {
    fetch(`/admin/practice/users/${userId}/reject`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    }).then(() => {
      window.location.reload();
    });
  }
}

function updateTeacher(userId, teacher) {
  fetch(`/admin/practice/users/${userId}/update_teacher`, {
    method: 'PATCH',
    headers: {
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ teacher: teacher })
  });
}

function updatePhone(userId, type) {
  const phoneInput = document.getElementById(`phone-${type}-${userId}`);
  const phone = phoneInput.value;
  
  fetch(`/admin/practice/users/${userId}/update_info`, {
    method: 'PATCH',
    headers: {
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ 
      phone: phone 
    })
  }).then(response => {
    if(response.ok) {
      alert('전화번호가 업데이트되었습니다.');
    } else {
      alert('전화번호 업데이트에 실패했습니다.');
    }
  });
}

function resetPassword(userId, username) {
  const newPassword = prompt(`${username}의 새 비밀번호를 입력하세요 (최소 6자):`);
  if (newPassword && newPassword.length >= 6) {
    fetch(`/admin/practice/users/${userId}/reset_password`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ password: newPassword })
    }).then(() => {
      alert('비밀번호가 재설정되었습니다.');
    });
  } else if (newPassword) {
    alert('비밀번호는 최소 6자 이상이어야 합니다.');
  }
}
</script>