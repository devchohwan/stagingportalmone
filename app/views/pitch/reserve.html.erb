<script>
// ë‹¬ë ¥ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë¥¼ ë¨¼ì € ì •ì˜
function navigateMonth(direction) {
  var currentCalendar = document.querySelector('.calendar');
  if (!currentCalendar) {
    console.error('Calendar element not found');
    return;
  }

  var currentMonth = currentCalendar.getAttribute('data-month');
  var [year, month] = currentMonth.split('-').map(Number);

  if (direction === 'prev') {
    month--;
    if (month < 1) {
      month = 12;
      year--;
    }
  } else {
    month++;
    if (month > 12) {
      month = 1;
      year++;
    }
  }

  // ë‘ ìë¦¬ ìˆ«ìë¡œ í¬ë§·
  var formattedMonth = month < 10 ? '0' + month : month.toString();
  var newDate = year + '-' + formattedMonth + '-01';

  // ìƒˆ ë‹¬ë ¥ ë¡œë“œ
  fetch('/pitch/reserve?date=' + newDate, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
    .then(function(response) { return response.text(); })
    .then(function(html) {
      document.getElementById('calendar-container').innerHTML = html;

      // ë‹¤ë¥¸ ì„¹ì…˜ë“¤ ìˆ¨ê¸°ê¸°
      var timeSection = document.querySelector('[data-reservation-target="timeSection"]');
      var seatSection = document.querySelector('[data-reservation-target="seatSection"]');
      var confirmSection = document.querySelector('[data-reservation-target="confirmSection"]');

      if (timeSection) timeSection.classList.add('hidden');
      if (seatSection) seatSection.classList.add('hidden');
      if (confirmSection) confirmSection.classList.add('hidden');

      // ì„ íƒ ì´ˆê¸°í™”
      if (typeof selectedDate !== 'undefined') selectedDate = null;
      if (typeof selectedTime !== 'undefined') selectedTime = null;
      if (typeof selectedSeat !== 'undefined') selectedSeat = null;
    })
    .catch(function(error) {
      console.error('ë‹¬ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
var selectedDate = null;
var selectedTime = null;
var selectedSeat = null;

// ë‚ ì§œ ì„ íƒ í•¨ìˆ˜
function selectDate(element) {
  selectedDate = element.getAttribute('data-date');

  // ê¸°ì¡´ ì„ íƒ í•´ì œ
  document.querySelectorAll('.calendar-day-cell.selected').forEach(function(el) {
    el.classList.remove('selected');
  });
  element.classList.add('selected');

  // ì‹œê°„ ìŠ¬ë¡¯ ë¡œë“œ
  fetch('/pitch/time_slots?date=' + selectedDate)
    .then(function(response) { return response.text(); })
    .then(function(html) {
      document.getElementById('time-slots-container').innerHTML = html;
      var timeSection = document.querySelector('[data-reservation-target="timeSection"]');
      if (timeSection) {
        timeSection.classList.remove('hidden');
      }

      // ì´í›„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      var seatSection = document.querySelector('[data-reservation-target="seatSection"]');
      var confirmSection = document.querySelector('[data-reservation-target="confirmSection"]');
      if (seatSection) seatSection.classList.add('hidden');
      if (confirmSection) confirmSection.classList.add('hidden');
    });
}

// ì‹œê°„ ì„ íƒ í•¨ìˆ˜
function selectTime(element) {
  selectedTime = {
    start: element.getAttribute('data-start-time'),
    end: element.getAttribute('data-end-time')
  };

  // ê¸°ì¡´ ì„ íƒ í•´ì œ
  document.querySelectorAll('.time-slot.selected').forEach(function(el) {
    el.classList.remove('selected');
  });
  element.classList.add('selected');

  // ì¢Œì„ ì •ë³´ ë¡œë“œ
  fetch('/pitch/available_seats?start_time=' + selectedTime.start + '&end_time=' + selectedTime.end)
    .then(function(response) { return response.text(); })
    .then(function(html) {
      document.getElementById('seats-container').innerHTML = html;
      var seatSection = document.querySelector('[data-reservation-target="seatSection"]');
      if (seatSection) {
        seatSection.classList.remove('hidden');
      }
    });
}

// ì¢Œì„ ì„ íƒ í•¨ìˆ˜
function selectSeat(element) {
  selectedSeat = {
    id: element.getAttribute('data-seat-id'),
    name: element.getAttribute('data-seat-name')
  };

  // ê¸°ì¡´ ì„ íƒ í•´ì œ
  document.querySelectorAll('.seat-card.selected').forEach(function(el) {
    el.classList.remove('selected');
  });
  element.classList.add('selected');

  // ìŒì •ìˆ˜ì—… ì •ë³´ ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
  var contentSection = document.querySelector('[data-reservation-target="contentSection"]');
  if (contentSection) {
    contentSection.classList.remove('hidden');
  }
}

// ì£¼ì°¨ ì…ë ¥ ì—…ë°ì´íŠ¸
function updateWeekNumber() {
  var weekNumber = document.getElementById('week-number').value;
  document.getElementById('pitch_reservation_week_number').value = weekNumber;
}

// ë©”ëª¨ ì—…ë°ì´íŠ¸
function updateNotes() {
  var notes = document.getElementById('reservation-notes').value;
  document.getElementById('pitch_reservation_notes').value = notes;
}

// í™•ì¸ ì„¹ì…˜ í‘œì‹œ
function showConfirmSection() {
  var weekNumber = document.getElementById('week-number').value;

  if (!weekNumber) {
    alert('ì£¼ì°¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  showReservationSummary();

  var confirmSection = document.querySelector('[data-reservation-target="confirmSection"]');
  if (confirmSection) {
    confirmSection.classList.remove('hidden');
  }
}

function showReservationSummary() {
  var startTime = new Date(selectedTime.start);
  var endTime = new Date(selectedTime.end);
  var dateStr = startTime.toLocaleDateString('ko-KR');
  var timeStr = startTime.getHours() + ':00 - ' + endTime.getHours() + ':00';
  var weekNumber = document.getElementById('week-number').value;
  var notes = document.getElementById('reservation-notes').value;

  var summary = '<div class="reservation-item"><span class="item-label">ë‚ ì§œ:</span> ' + dateStr + '</div>' +
                '<div class="reservation-item"><span class="item-label">ì‹œê°„:</span> ' + timeStr + '</div>' +
                '<div class="reservation-item"><span class="item-label">ì¢Œì„:</span> ' + selectedSeat.name + '</div>' +
                '<div class="reservation-item"><span class="item-label">ì£¼ì°¨:</span> ' + (weekNumber ? weekNumber + 'ì£¼ì°¨' : 'ë¯¸ì…ë ¥') + '</div>' +
                '<div class="reservation-item"><span class="item-label">ë©”ëª¨:</span> ' + (notes || 'ì—†ìŒ') + '</div>';

  document.getElementById('reservation-summary').innerHTML = summary;

  // hidden í•„ë“œ ê°’ ì„¤ì •
  document.getElementById('pitch_reservation_pitch_room_id').value = selectedSeat.id;
  document.getElementById('pitch_reservation_start_time').value = selectedTime.start;
  document.getElementById('pitch_reservation_end_time').value = selectedTime.end;
  document.getElementById('pitch_reservation_week_number').value = weekNumber;
  document.getElementById('pitch_reservation_notes').value = notes;
}

// Window ê°ì²´ì— í•¨ìˆ˜ë“¤ í• ë‹¹ (ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´)
window.navigateMonth = navigateMonth;
window.selectDate = selectDate;
window.selectTime = selectTime;
window.selectSeat = selectSeat;
window.updateWeekNumber = updateWeekNumber;
window.updateNotes = updateNotes;
window.showConfirmSection = showConfirmSection;
</script>

<style>
  .reserve-container {
    min-height: 100vh;
    background: #ffffff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 40px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .reserve-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .reserve-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 20px;
    line-height: 1.3;
  }

  .content-wrapper {
    width: 100%;
    max-width: 500px;
  }

  .step-section {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
    padding: 25px;
  }

  .step-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 15px;
    font-size: 1.1rem;
  }

  .calendar-container {
    background: #ffffff;
    border-radius: 8px;
    padding: 0;
  }

  .btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    text-align: center;
    display: block;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    width: 100%;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
  }

  .confirmation-card {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(236, 72, 153, 0.05));
    border: 2px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .confirmation-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 10px;
  }

  .confirmation-text {
    color: #4a5568;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .back-link {
    color: #718096;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.3s ease;
    text-align: center;
    display: block;
    margin-top: 30px;
  }

  .back-link:hover {
    color: #2d3748;
    text-decoration: none;
  }

  /* Calendar specific styles */
  .calendar {
    width: 100%;
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .calendar-nav-btn {
    color: #718096;
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  .calendar-nav-btn:hover {
    color: #2d3748;
    background-color: #f7fafc;
  }

  .calendar-month-title {
    font-weight: 600;
    color: #2d3748;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }

  .calendar-weekday {
    text-align: center;
    font-weight: 600;
    color: #718096;
    font-size: 0.8rem;
    padding: 10px 0;
  }

  .calendar-day-cell {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: #f7fafc;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .calendar-day-cell:hover:not(.past-day):not(.weekend-closed):not(.blocked-day):not(.not-current-month) {
    background: #e9d5ff;
    transform: translateY(-2px);
  }

  .calendar-day-cell.selected {
    background: #8b5cf6;
    color: white;
  }

  .calendar-day-cell.today {
    background: #ddd6fe;
  }

  .calendar-day-cell.past-day,
  .calendar-day-cell.weekend-closed,
  .calendar-day-cell.blocked-day {
    background: #f1f5f9;
    color: #cbd5e0;
    cursor: not-allowed;
  }

  .calendar-day-cell.not-current-month {
    opacity: 0.3;
  }

  .calendar-day-cell.has-reservation {
    background: #e9d5ff;
    color: #6b46c1;
    cursor: not-allowed;
  }

  .day-number {
    font-size: 0.95rem;
    font-weight: 500;
  }

  .day-label {
    font-size: 0.6rem;
    margin-top: 2px;
    color: #8b5cf6;
    font-weight: 600;
  }

  .calendar-day-cell.selected .day-label {
    color: white;
  }

  .hidden {
    display: none;
  }

  .reservation-item {
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
  }

  .reservation-item:last-child {
    border-bottom: none;
  }

  .item-label {
    color: #718096;
    font-weight: 500;
    margin-right: 10px;
  }

  .form-group {
    margin-top: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    color: #4a5568;
    font-weight: 500;
  }

  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.95rem;
    resize: vertical;
  }

  .form-control:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }

  /* 320px ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 320px) {
    .reserve-container {
      padding: 20px 10px;
    }

    .reserve-title {
      font-size: 1.2rem;
    }

    .step-section {
      padding: 18px;
      border-radius: 10px;
    }

    .calendar-day-cell {
      font-size: 0.85rem;
    }

    .day-number {
      font-size: 0.8rem;
    }

    .day-label {
      font-size: 0.55rem;
    }
  }
</style>

<div class="reserve-container" data-controller="reservation">
  <div class="reserve-header">
    <h1 class="reserve-title">ğŸµ ìŒì •ìˆ˜ì—… ì˜ˆì•½</h1>
  </div>

  <div class="content-wrapper">
    <!-- Step 1: ë‚ ì§œ ì„ íƒ -->
    <div class="step-section">
      <h2 class="step-title">1ï¸âƒ£ ë‚ ì§œ ì„ íƒ</h2>
      <div class="calendar-container" id="calendar-container">
        <%= render partial: 'calendar', locals: { date: @date, selected_date: nil } %>
      </div>
    </div>

    <!-- Step 2: ì‹œê°„ ì„ íƒ -->
    <div class="step-section hidden" data-reservation-target="timeSection">
      <h2 class="step-title">2ï¸âƒ£ ì‹œê°„ ì„ íƒ</h2>
      <div id="time-slots-container"></div>
    </div>

    <!-- Step 3: ì¢Œì„ ì„ íƒ -->
    <div class="step-section hidden" data-reservation-target="seatSection">
      <h2 class="step-title">3ï¸âƒ£ ì¢Œì„ ì„ íƒ</h2>
      <div id="seats-container"></div>
    </div>

    <!-- Step 4: ìŒì •ìˆ˜ì—… ì •ë³´ ì…ë ¥ -->
    <div class="step-section hidden" data-reservation-target="contentSection">
      <h2 class="step-title">4ï¸âƒ£ ìŒì •ìˆ˜ì—… ì •ë³´</h2>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px;">ì£¼ì°¨</label>
        <input type="number"
               id="week-number"
               placeholder="ëª‡ ì£¼ì°¨ì¸ì§€ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 1, 2, 3...)"
               style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;"
               min="1" max="20"
               onchange="updateWeekNumber()">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px;">ì˜ˆì•½ ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
        <textarea id="reservation-notes"
                  placeholder="íŠ¹ë³„í•œ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”"
                  style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; resize: vertical;"
                  onchange="updateNotes()"></textarea>
      </div>

      <button type="button" class="btn-primary" onclick="showConfirmSection()">
        ë‹¤ìŒ ë‹¨ê³„
      </button>
    </div>

    <!-- Step 5: ì˜ˆì•½ í™•ì¸ -->
    <div class="step-section hidden" data-reservation-target="confirmSection">
      <h2 class="step-title">5ï¸âƒ£ ì˜ˆì•½ í™•ì¸</h2>

      <div class="confirmation-card">
        <div class="confirmation-title">ì˜ˆì•½ ì •ë³´</div>
        <div class="confirmation-text" id="reservation-summary"></div>
      </div>

      <%= form_with model: @reservation, url: pitch_reservations_path, local: true,
                    data: { turbo: false } do |f| %>
        <%= f.hidden_field :pitch_room_id %>
        <%= f.hidden_field :start_time %>
        <%= f.hidden_field :end_time %>
        <%= f.hidden_field :week_number %>
        <%= f.hidden_field :notes %>

        <button type="submit" class="btn-primary"
                onclick="return confirm('ì˜ˆì•½ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ìˆ˜ì—…ì´ í™•ì •ë©ë‹ˆë‹¤.')">
          ì˜ˆì•½ ì‹ ì²­í•˜ê¸°
        </button>
      <% end %>
    </div>

    <a href="<%= pitch_path %>" class="back-link">â† ëŒì•„ê°€ê¸°</a>
  </div>
</div>